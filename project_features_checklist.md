# 项目功能与实现清单

## 项目概览
- **代码总规模**: ~47,379 行
- **前端 (apps/web)**: ~30,047 行
- **后端 (apps/api)**: ~9,693 行
- **共享包 (packages)**: ~7,639 行

## 功能实现状态
下表基于文档 (`sprint-status.yaml`) 和代码库分析总结了功能状态。

| 状态 | 功能 | 实现路径 | 代码行数 (约) | 文件数 |
| :--- | :--- | :--- | :--- | :--- |
| [x] | **画布与图表核心**<br>基础操作、连接管理 | `apps/web/components/graph`<br>`apps/api/src/modules/graphs`<br>`apps/api/src/modules/edges` | 2,579 | 12 |
| [x] | **节点操作**<br>快捷键、多选、数据组织 | `apps/web/components/nodes`<br>`apps/api/src/modules/nodes` | 3,957 | 29 |
| [x] | **布局控制**<br>自动布局引擎 | `apps/web/components/layout` | 952 | 4 |
| [x] | **实时协同**<br>同步引擎、光标、感知 | `apps/web/features/collab`<br>`apps/web/components/collab`<br>`apps/api/src/modules/collab` | 1,644 | 10 |
| [x] | **任务属性面板**<br>任务详情、状态管理 | `apps/web/components/PropertyPanel` | 3,411 | 15 |
| [x] | **产品库**<br>(PBS 增强) | `apps/web/components/ProductLibrary`<br>`apps/api/src/modules/product-library` | 1,025 | 5 |
| [x] | **知识库**<br>(Mock/原型) | `apps/web/components/Knowledge`<br>`apps/api/src/modules/knowledge-library` | 591 | 6 |
| [/] | **评论系统**<br>上下文各、提及 (Review 中) | `apps/web/components/Comments`<br>`apps/api/src/modules/comments` | 5,372 | 28 |
| [/] | **审批工作流**<br>状态流转 (Review 中) | `apps/api/src/modules/approval` | 1,441 | 7 |
| [ ] | **智能通知**<br>(代办 / 仅脚手架) | `apps/web/components/notifications`<br>`apps/api/src/modules/notification` | 854 | 9 |
| [ ] | **关注与订阅**<br>(准备开发 / 仅脚手架) | `apps/api/src/modules/subscriptions` | 614 | 5 |
| [x] | **应用节点 & 文件 I/O**<br>执行逻辑、文件管理 | `apps/web/components/App`<br>`apps/api/src/modules/app-library`<br>`apps/api/src/modules/file` | 2,708 | 20 |
| [x] | **用户与鉴权** | `apps/web/components/UserSelector`<br>`apps/api/src/modules/users` | 518 | 6 |

## 详细代码统计
*统计日期: `2025-12-25`*

- **前端**: `apps/web` (不含 node_modules, .next)
  - 总行数: ~30k
  - 核心组件: `Comments` (~5.3k 行) 是最大的单一功能组件。
  - 节点逻辑: `nodes` (~4k 行) 包含大量业务逻辑。

- **后端**: `apps/api` (不含 node_modules, dist)
  - 总行数: ~9.7k
  - 架构: NestJS Modules
  - 最大模块: `nodes`, `graphs`, `comments`。

- **共享包**: `packages`
  - 总行数: ~7.6k
  - 共享类型、工具函数、数据库 Schema

## 下一步计划 (基于 `sprint-status.yaml`)
1.  **Review**: 完成 **评论系统** (4-3) 和 **审批工作流** (4-1) 的代码评审。
2.  **开发**: 开始 **关注与订阅** (4-4)。
3.  **待办**: 智能通知中心 (4-5)。

## 用户操作功能详单 (已实现)

以下列出用户在界面上可直接触发的具体操作：

### 节点操作 (Node Operations)
- [x] **创建节点**
    - `Tab`: 创建子节点
    - `Enter`: 创建兄弟节点 (或子节点，视当前选中而定)
    - 图表初始化时自动添加中心节点
- [x] **编辑内容**
    - `双击` 节点: 进入编辑模式 (修改标题)
    - `Space` (空格键): 进入编辑模式
    - 编辑时 `Enter`: 确认修改
    - 编辑时 `Esc`: 取消修改
- [x] **删除节点**
    - `Delete` / `Backspace`: 删除选中节点 (放入剪贴板/软删除)
    - `Shift + Delete`: 彻底删除节点
- [x] **选择与导航**
    - `Click`: 单选节点
    - `Cmd/Ctrl + Click`: 多选节点
    - `Cmd/Ctrl + A`: 全选节点
    - `Arrow Keys` (上下左右): 在节点树中导航焦点
- [x] **剪贴板操作**
    - `Cmd/Ctrl + C` (或工具栏按钮): 复制节点
    - `Cmd/Ctrl + X` (或工具栏按钮): 剪切节点
    - `Cmd/Ctrl + V`: 粘贴节点 (智能粘贴到当前选中节点下，或鼠标位置)
    - 右键菜单 -> "粘贴到此处"
- [x] **高级交互**
    - 拖拽节点: 移动位置 (触发自动布局调整)
    - 右键菜单 -> "关注/取消关注" (订阅节点变动)
    - 点击评论图标: 展开/收起评论面板
    - 点击应用运行图标 (APP节点): 触发应用执行

### 连线与依赖 (Edges & Dependencies)
- [x] **创建依赖**
    - 底部状态栏 "开启依赖模式"
    - `Click` 起点 -> `Click` 终点: 创建依赖连线
    - 自动校验环状依赖，非法连接显示禁止光标
- [x] **管理依赖**
    - `Click`: 选中连线 (高亮显示)
    - `Delete` / `Backsapce`: 删除选中连线
    - 右键菜单 -> "修改依赖类型" (FS, SS, FF, SF)
    - 右键菜单 -> "删除依赖连线"

### 属性面板操作 (Property Panel)
- [x] **任务属性**
    - 修改状态 (待办/进行中/已完成)
    - 修改优先级 (低/中/高)
    - 指定执行人 (用户选择器)
    - 设置开始时间/截止时间
    - 填写自定义阶段
- [x] **任务分发 (Task Dispatch)**
    - 分配者: 点击 "派发任务"
    - 执行人: 点击 "接受" 或 "驳回" (填写驳回理由)
    - 查看派发/反馈时间戳
- [x] **审批流程 (Approval)**
    - 查看审批进度条 (Stepper)
    - 配置审批流程 (若未配置)
    - **交付物管理**: 上传文件、下载文件、预览文件 (Mock)、删除文件
    - **提交审批**: 满足条件时点击提交
    - **审批动作**: 审批人点击 "通过" 或 "驳回"
- [x] **知识库关联**
    - 添加/移除关联的知识资源

### 业务节点功能 (Business Nodes)
- [x] **APP 节点 (工业应用)**
    - **应用配置**: 选择来源 (本地/远程/库)
    - **I/O 参数**: 配置输入/输出参数 (类型、默认值)
    - **执行控制**: 点击 "启动应用"
    - **状态反馈**: 查看执行中/成功/失败状态及日志
- [x] **PBS 节点 (产品分解)**
    - **属性管理**: 编辑 PBS 编码、版本号、负责人
    - **产品库关联**: 搜索并关联卫星产品 (支持多维筛选)
    - **指标管理**:
        - 添加指标: 从常用模板选择 (通信/导航/遥感等)
        - 编辑指标: 设定目标值、实际值、单位
        - 删除指标

### 视图与布局 (Views & Layouts)
- [x] **看板视图 (Kanban)**
    - **拖拽流转**: 拖动卡片改变状态 (To Do -> In Progress -> Done)
    - **分组视图**: 切换 "状态视图" / "阶段视图" (Custom Stage)
    - **自定义阶段**: 添加/删除自定义列
    - **显示控制**: 隐藏/显示已完成任务
- [x] **甘特图视图 (Gantt)**
    - **缩放控制**: 切换日/周/月/季视图
    - **任务调度**: 拖拽调整时间、拖曳边缘调整时长
    - **进度管理**: 拖拽进度条更新完成度 (0-100%)
    - **依赖可视化**: 显示/隐藏依赖连线
    - **未排程任务**: 侧边栏拖拽未排期任务到时间轴
- [x] **自动布局 (Layouts)**
    - **思维导图模式**: 标准脑图结构
    - **逻辑图模式**: 向右生长的树状结构
    - **自由模式**: 任意拖拽 (支持网格吸附)
    - **网络图 (Network)**: 针对复杂依赖的自动优化布局

### 画布交互 (Canvas)
- [x] **视图控制**
    - 滚轮 / 触控板: 缩放画布
    - 拖拽空白处: 平移画布 (Pan)
    - 空白处右键菜单: "粘贴到此处"
- [x] **历史记录**
    - `Cmd/Ctrl + Z`: 撤销 (Undo)
    - `Cmd/Ctrl + Shift + Z` / `Cmd/Ctrl + Y`: 重做 (Redo)
- [x] **布局模式**
    - 顶部工具栏切换: 思维导图 / 逻辑图 / 组织结构图 (自动重排)

### 评论系统 (Comments)
- [x] **查看评论**
    - 评论面板: 显示节点关联的所有评论
    - 标记只读: 打开面板自动标记为已读
    - 附件预览: 点击附件下载或预览图片
    - 时间显示: 相对时间 (刚刚/x分钟前)
- [x] **发送评论**
    - `Enter`: 发送评论
    - `Cmd/Ctrl + Enter`: 换行
    - 提及 (@): 触发用户列表，选中后插入提及
    - 回复评论: 点击 "回复" icon，进入嵌套回复模式
    - 取消回复: `Esc` 或点击取消按钮
- [x] **管理评论**
    - 删除评论: 作者点击垃圾桶 icon (可删除自己的)

### 顶部与辅助工具栏 (Toolbars)
- [x] **剪贴板工具栏** (右上角)
    - 复制按钮 (选中节点时高亮)
    - 剪切按钮
    - 粘贴按钮
    - 显示选中节点数量
- [x] **协同状态** (左下角)
    - 显示当前在线/离线状态
    - 显示同步状态指示器 (同步中/已同步)

### 全局搜索 (Global Search)
- [x] **命令面板**
    - `Cmd/Ctrl + K`: 打开全局搜索对话框
    - 输入关键词: 搜索节点名称、描述
    - `#标签名`: 按标签搜索节点
    - `Arrow Keys` + `Enter`: 导航并选中结果
    - `Esc`: 关闭对话框
- [x] **搜索结果**
    - 显示节点类型图标
    - 显示所属图表名称
    - 点击标签快速切换到标签搜索

### 标签管理 (Tag Editor)
- [x] **节点标签编辑**
    - 输入标签名, `Enter` 或 `,` 添加
    - `Backspace`: 删除最后一个标签
    - 点击标签上 `x` 删除指定标签
    - 最多支持 10 个标签

### 协同感知详情 (Collaboration Awareness)
- [x] **远程光标**
    - 看到其他用户的光标位置 (带颜色标识)
    - 用户名称气泡 (pulsing 动画)
- [x] **在线用户头像栈**
    - 右上角显示当前协作用户头像列表

### 多端同步 (Multi-Device Sync)
- [x] **实时数据同步**
    - 基于 Yjs CRDT 无冲突数据结构
    - WebSocket 连接 (Hocuspocus Server)
    - 节点/边/属性变更毫秒级同步
- [x] **连接管理**
    - 断线自动重连 (指数退避)
    - 连接状态指示器 (在线/离线/重连中)
- [x] **离线支持**
    - 离线时本地操作正常进行
    - 重新上线后自动合并 (CRDT 保证最终一致性)
    - 无需手动解决冲突

### 通知中心 (Notifications) [脚手架]
- [x] **通知铃铛**
    - 显示未读通知数量徽章
    - 点击展开通知列表
- [x] **通知列表**
    - 分组显示 (评论/审批/任务变动)
    - 标记已读/未读
    - 点击跳转到对应节点


