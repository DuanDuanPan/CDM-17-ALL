---
title: PRD — 脑图驱动协同研发平台
date: 2025-12-12
owner: Enjoyjavapan
status: draft
---

# 1. 背景与目标
- 背景：现有“项目→任务→汇报”模式割裂，需求/架构/执行分层，协同慢、通知噪音大、权限粗粒度，大图性能无保障。
- 目标：以脑图为单一真相源（SoT），让需求/任务/知识/审批/执行在同一可视化空间流动，实现实时协同与执行编排。
- 成功标准（首版）：1k+ 节点、50 人并发无降级（P95 交互 <100ms，协同延迟 <200ms）；审批→自动分派命中率 >90%；通知重复率下降 >60%；权限违规审计零漏记。

# 2. 用户与场景
- 项目/系统工程经理：梳理需求与依赖，下发任务并追踪甘特/时间线。
- 研发/架构/测试：在脑图中协同建模、下钻子图、提交与审批交付物。
- 安全/合规负责人：配置密级、审计下载/预览、监控违规。
- 场景：多团队并发、涉密/分级访问、跨专业项目（航天/通信/大型软件）。

# 3. 范围
## 3.1 范围内（MVP）
- 脑图多布局（自由/树/逻辑）、快捷键与 / 命令、批量粘贴成树、节点下钻子图并回链。
- 节点模型：需求/任务/模板/知识/控制/工具；多版本+时间线；MBSE 关系（父子/依赖/数据流）。
- 执行驱动：任务映射；FS/SS/FF/SF 依赖；审批后自动推演下一任务；定期任务。
- 数据流与下发：上下游下发/接收/驳回；变更通知；基础跨图引用可视指示。
- 协同与权限：多人光标；锁定/解锁；冲突提示（人为合并）；密级/字段/附件级权限；动态水印（在线预览）；审计≥1年。
- 通知节流：站内信；同节点同事件 5 分钟去重；5 分钟汇总；高优事件实时。
- 版本与可见性：未保存仅本人可见；自动保存；版本切换通知。
- 互动：评论与回复，支持 @ 提及与通知。
- 绩效管理（基础）：节点/任务分值与分摊，按人/组/部门统计与排名，报表导出。
- 视图与同步：脑图/甘特/时间轴/看板多视图共用同一数据源，折叠/选中状态可保持；任务依赖在甘特/脑图两处可编辑。
- AI 辅助：支持 AI 一键生成/扩展骨架分支；可选局部（选中分支）生成。
- 订阅：分支/节点订阅，按 5 分钟节流策略推送站内信。
- 数据组织：标签/筛选/搜索；节点归档与恢复；数据质量基本校验（必填/格式）。

### 3.1.A 采纳的可落地增强（Milanote 优点转化）
- 自由布局+排版控件：自由模式提供对齐/吸附/网格/距离指示线；可与树/逻辑模式切换。
- 模板与子树片段库：模板库与自定义片段一键插入，预置字段必填与默认密级。
- 协同可见性：多人光标、评论线程、@mention 通知（遵循 5 分钟节流），评论侧栏/底部抽屉展示。
- 导出强化：PDF/PNG/Word/Markdown/纯文本/ZIP，多格式导出可选水印开关、敏感字段遮罩、导出范围（全图/选中子树）。
- 访问可见性与审计：图/板级“访问记录”视图，列出访问/编辑/下载事件，支持按密级过滤并导出审计。
- 快速上手模式：/命令面板、粘贴文本/表格生成树、AI 一键骨架，顶部 `?` 或按钮展示快捷键提示。
- 分享与权限联动：只读/可评论链接分享（受密级判定），可查看已分享列表并一键失效链接，默认开启水印。

## 3.2 范围外（首版不做）
- 离线编辑；移动端同等性能指标；IM Webhook（企业微信/钉钉）；专业工具深度集成（航天仿真等）；国产化/国密适配（后续评审）。

# 4. 需求条目表（MVP）
| ID | 需求描述 | 优先级 | 验收标准 | 依赖/备注 |
| --- | --- | --- | --- | --- |
| R1 | 脑图多布局 + 快捷键/批量/下钻 | Must | 1k 节点场景下切换/缩放/折叠 P95<100ms；支持 / 命令与文本粘贴生成树；节点下钻可回链 | 性能基线 |
| R2 | 节点模型多版本+时间线 | Must | 节点支持版本历史浏览/回退；未保存版本仅本人可见；版本切换自动记录并可通知 | R1 |
| R3 | 任务映射与依赖（FS/SS/FF/SF） | Must | 节点→任务；依赖阻塞生效；批量/定期任务可配置 | R1 |
| R4 | 审批驱动执行编排 | Must | 交付物/任务审批通过后自动推演下一任务并通知；审批记录可审计 | R3 |
| R5 | 密级/字段/附件级权限 + 动态水印 | Must | 用户密级≥资源密级方可见；字段/附件可配置可见/编辑/下载；支持临时提升申请审批；在线预览水印；审计1年可导出 | 安全基线 |
| R6 | 协同与冲突控制 | Must | 多人光标；锁/解锁；冲突提示并支持人工合并 | R1 |
| R7 | 通知节流（站内信） | Must | 同节点同事件5分钟内去重；5分钟汇总；高优事件实时送达；收件箱可过滤已读/未读 | 通知服务 |
| R8 | 性能与监测 | Must | 1k 节点、50 并发；初始加载<2s；P95交互<100ms；协同<200ms；前端FPS/内存与后端队列/冲突率监测 | R1,R6 |
| R9 | 模板库与复用 | Should | 支持结构/字段/样式模板；子树片段保存/套用；导入 XMind/Markdown/CSV，导出 PNG/HTML/Markdown | R1 |
| R10 | 数据血缘与跨图可视化（基础版） | Should | 支持节点关系线标注方向/标签；跨图引用可视指示；无自动合并 | R1 |
| R11 | 上下游下发/接收/驳回 | Should | 上游可下发节点/任务；下游可接收或驳回并写回状态；变更触发站内信；日志可审计 | R1,R7 |
| R12 | 评论与 @ 提及 | Should | 节点评论、线程回复；@被提及人收到站内信；可过滤未读评论 | R7 |
| R13 | 绩效管理（基础） | Should | 节点/任务可设分值与分摊；按人/组/部门统计与排名；导出报表；提醒/激励规则可配置占位 | R1,R7 |
| R14 | 脑图↔甘特/时间轴联动 | Should | 甘特/时间轴与脑图共享数据；依赖可在任一视图编辑并实时同步；视图切换保留折叠/选中状态 | R1,R3 |
| R15 | AI 生成/扩展骨架 | Should | 一键生成初始分支或选中分支扩展；生成内容可回收/撤销；支持人工编辑后保存版本 | R1 |
| R16 | 分支订阅与节流 | Should | 用户可订阅分支/节点，采用同节点同事件 5 分钟去重与 5 分钟汇总策略推送站内信 | R7 |
| R17 | 标签/搜索/归档 | Should | 节点支持标签；按标签/类型/状态搜索与过滤；节点归档/恢复；必填/格式校验提示 | R1 |
| R18 | 自由布局+排版控件 | Should | 自由模式可切换/返回树或逻辑模式且状态保持；支持对齐/吸附/网格/距离指示线开关；1k 节点 P95 交互<100ms（依 R8） | R1,R8 |
| R19 | 模板与子树片段库 | Should | 模板/片段可搜索预览，一键插入选中节点；模板可预置必填字段与默认密级；支持将选中子树保存为片段复用 | R1,R5,R9 |
| R20 | 协同可见性与评论节流 | Should | 多人光标与选中实时可见；评论线程支持 @mention；@ 提及触发站内信遵循 5 分钟去重+汇总策略；评论面板显示未读状态 | R6,R7 |
| R21 | 导出强化与敏感遮罩 | Should | 支持 PDF/PNG/Word/Markdown/纯文本/ZIP 导出；导出时可选水印开关、敏感字段遮罩、范围（全图/选中子树）；导出完成有成功提示与下载链接 | R5 |
| R22 | 访问记录与审计视图 | Should | 提供图/节点“访问记录”列表，含查看/编辑/下载事件；可按时间与密级过滤并导出 CSV/JSON；加载 P95<2s | R5 |
| R23 | 快速上手模式 | Should | / 命令面板；粘贴文本/表格生成树前可预览并确认；AI 一键生成骨架插入当前选中节点；`?` 或按钮弹出快捷键提示 | R1,R15 |
| R24 | 分享与权限联动 | Should | 支持生成只读或可评论链接，创建时校验用户密级与节点密级；可查看现有分享记录并一键失效；链接默认开启水印；访问者显示在访问记录中 | R5 |
| R25 | PBS 指标与产品库引用 | Should | PBS 节点支持自定义指标（名称、单位、目标值/实际值）及常用工程指标预设；支持从全局共享产品库搜索并创建引用（链接同步）；弹窗交互 | R1 |
| R26 | 知识关联与推荐 | Should | 任务节点可关联知识资源；任意节点在详情面板显示知识推荐区域；本阶段 Mock 数据，实际 AI/知识库集成延后至 R15 | R1,R15 |
| R27 | APP 节点类型与工业软件集成 | Should | 新增 APP 节点类型，可调用本地桌面应用或 Web API；应用列表由系统管理员预配置；支持通过数据线传递上下游参数；启动按钮触发调用 | R1,R3 |
| R28 | 多选与剪贴板操作 | Must | 支持 Shift+Click/框选多节点；支持跨窗口/页签复制粘贴（序列化）；支持复制为图片/文本；粘贴时维持原有相对结构 | R1 |
| R29 | 数据管理与工业格式预览 | Should | 独立数据资源库 Drawer（Cmd+D，宽度60-70%）；支持 PBS/任务/文件夹三种组织视图；支持 STEP(glTF)/网格(STL)/云图(VTK) 轻量化预览（Three.js）；过程数据（任务交付物/数据节点）自动汇聚；节点-数据双向关联；MVP 阶段暂忽略权限 | R1,R17 |

# 5. 非功能与指标
- 性能：见 R8；批量操作可容忍 P95<400ms。
- 可靠性：关键操作自动快照；版本时间线可回滚。
- 安全/合规：密级匹配访问；在线预览水印；审计导出按人/节点/密级过滤；分享/导出默认开启水印与敏感遮罩。
- 导出/分享/审计性能：中等规模导出（≤500 节点、含附件元数据）P95<3s；访问记录查询/导出 P95<2s；分享链接创建/失效操作 P95<1s。
- 可用性：快捷键帮助；模板套用；子树复用。

# 6. 里程碑（建议）
- M0 方案冻结：2025-12-15
- M1 MVP 设计冻结：2026-01-15
- M2 技术验证（性能/权限/节流）：2026-02-15
- M3 Beta（50 并发、1k 节点）：2026-03-15

### 6.1 增强项分阶段落地（针对 R18–R24）
- M1 设计冻结：完成 R18–R24 的交互稿与验收标准对齐；落地 Layout/Template/Export/Share/Audit 组件的技术选型。
- M2 技术验证：实现 R18（自由布局控件基础版）、R20（协同可见性+@节流）、R23（/命令+粘贴预览+AI骨架），并跑 1k 节点性能基线；完成 Export/Share/Audit 服务的骨架与审计链路。
- M3 Beta：交付 R19（模板/片段库含密级预置）、R21（导出水印/遮罩/范围）、R22（访问记录视图+导出）、R24（分享联动默认水印、可失效链接）；强化 R18 交互细节与状态持久化。
# 7. 风险与对策
- 性能风险：1k 节点渲染/协同；→ 懒加载分片、关系线视图裁剪、前端监测。
- 权限复杂度：密级+字段/附件+审批叠加；→ 继承+局部覆盖 ACL，强制审计。
- 通知噪音：高频事件；→ 5 分钟去重+汇总，优先级实时通道。
- 集成空白：专业工具/API 待定；→ 预留 webhook 与字段映射表，后续迭代。
- 导出/分享安全：链接误配或水印关闭导致泄露；→ 默认强制水印/遮罩，分享需密级校验，失效快捷入口，日志可追溯。
- 审计/访问记录可靠性：日志写入/查询超时或丢失；→ append-only + 重试/缓冲；独立监控与告警；导出失败降级为分页查询。

# 8. 决策闭环（2025-12-12）
- 访问记录数据模型（写入/查询统一）：
  - 字段：event_id(UUID)、project_id、graph_id、node_id(optional)、resource_type(graph/node/export/share)、resource_level、subject_user_id、subject_level、action(view/edit/download/export/share_create/share_visit/share_invalidate)、channel(web/ws/api/share_link)、result(allow/deny)、ip(anonymized after 30d)、ua_fingerprint(hash)、ts_ms、latency_ms、request_id、client_version。
  - 留存：热存储 90 天可查询，冷存储 12 个月（S3/对象存储）；IP/UA 30 天后哈希化；导出/分享关联事件可追溯 12 个月。
  - 索引： (graph_id, ts desc)、(project_id, ts desc)、(action, ts)、(resource_level, ts)；TTL 400 天；所有查询强制按 project_id + 时间窗。
- 分享默认策略：
  - 默认开启水印与敏感遮罩（不可关闭）；默认有效期 7 天，可调 1–30 天；资源密级 ≥“机密”禁用公开分享链接，仅限受邀访问。
  - 权限不足或资源超密级时阻断创建，提示文案：“链接创建失败：资源密级高于你的授权级别，可发起权限提升或邀请协作者。”
  - 失效操作即时生效并写入访问记录；访问超期返回错误码 41001（link_expired）。
- 导出范围与遮罩冲突：
  - 后端总是先做 ACL，再导出；无权限字段/附件一律遮罩，列表与导出文件显示占位“***”；记录遮罩计数。
  - 全图导出若遮罩节点>500，则提示“存在大量遮罩，自动降级为结构-only 导出或请选择子树”；用户可改为“选中子树”或“结构-only（无字段/附件）”。
  - 导出超时支持分片/重试；失败提示“可切换纯文本/结构-only 以完成导出”。
- 模板版本与回滚：模板/片段采用版本化 {draft → published → deprecated}；仅 published 可被选择；发布需要校验必填与密级；回滚=提升旧版本为新 published，并写审计/访问记录。
- 性能压测脚本与指标：
  - Script-P1：1k 节点加载/缩放/折叠（50 并发，k6），目标 P95 交互<100ms。
  - Script-P2：协同编辑 50 并发 + 评论/@（ws + http），目标协同延迟<200ms。
  - Script-P3：导出中等规模（≤500 节点含附件元数据）+ 访问记录查询/导出，目标导出 P95<3s，访问记录查询 P95<2s。
- 未读计数与错误码：
  - 未读单一来源 = Notification Service Inbox；评论未读与站内信共享计数，不再在评论侧维护副本。
  - 权限/分享/导出错误码：40301(classification_denied)、40302(field_attachment_masked)、40303(audit_required)、41001(link_expired)、42910(rate_limited)。

# 9. Architecture Blueprint（高层）
- 总体：前后端分离 + 实时协同通道 + 权限/审计网关 + 分层存储（图数据/版本快照/审计/通知）。
- 前端：Web（桌面优先）；模块：绘图引擎（多布局+关系线+下钻）、协同光标/冲突提示、AI Assist 面板、通知收件箱、权限可视提示（水印/锁）。
- 实时层：WebSocket/RTC 事件（节点/布局/依赖/版本/评论/审批/通知），带节流与压缩。
- 后端服务：Graph（节点/版本/跨图引用/标签/搜索/下钻快照）；Execution（任务映射、FS/SS/FF/SF、定期任务、审批后推演下一任务）；Permission/Security（密级判定、字段/附件 ACL、临时提升审批、水印策略、审计写入）；Notification（站内信去重/汇总/优先通道、订阅过滤）；Template/AI（模板库、子树复用、AI 生成/扩展）。
- 存储：图存储（文档型+图索引）；审计/日志 append-only（冷热分层，保留≥1年）；版本快照（增量+关键操作）；大附件对象存储；访问记录索引（按时间/密级可查询导出）。
- 性能：懒加载分片（视口/层级）、关系线裁剪、增量渲染、读写分离；监测 P95/P99（队列时延、冲突率）。
- 安全：密级≥资源可见；在线预览水印；下载/预览审计；临时提升审批；无降级模式满足 1k 节点/50 并发。
- 集成预留：Webhook + 字段映射表；后续 IM/CI/工单、国产化/内网部署留白；导出管线支持水印/遮罩策略插件化。
- 新增增强支撑组件：
  - Layout Engine：自由/树/逻辑统一引擎，提供对齐/吸附/网格/距离计算，可持久化布局状态。
  - Template Service：模板与子树片段仓库，含字段/密级预置；与权限网关联动校验。
  - Export Service：统一导出管线，多格式转换，水印/敏感遮罩、范围裁剪，全程审计。
  - Share & Link Manager：生成/失效分享链接，校验密级，写入访问记录。
  - Audit/Visit Log：独立存储与查询接口，支持过滤与导出；前端访问记录视图依赖。
  - Command & Paste Engine：/命令面板、粘贴解析器（文本/表格→树），插入前预览；AI Skeleton 调用 Template/Graph。

# 10. UX Framework（信息架构）
- IA：工作区/项目 → 脑图画布（多视图：脑图/甘特/时间轴/看板）→ 右侧面板（属性/版本/依赖/AI/审批）→ 底部通知与评论抽屉。
- 画布交互：/命令面板（可搜索命令/模板）；粘贴文本/表格生成树（预览确认）；AI 生成骨架；拖拽/批量；自由模式对齐/吸附/网格开关；折叠/展开；节点下钻子图（面包屑回退）；关系线方向/标签/颜色。
- 视图状态：脑图/甘特/时间轴切换保留选中与折叠；依赖在任一视图可编辑并同步。
- 右侧面板：属性（密级提示）；版本/时间线（差异对比、回滚）；依赖与任务映射；AI Assist（生成/扩展/审阅）；审批与推演预览；访问记录（过滤/导出）。
- 通知与评论：收件箱支持过滤、5 分钟去重+汇总；评论线程化，@ 提及触发站内信并标未读；评论面板可停靠侧栏或底部。
- 权限/水印提示：顶部或预览区显示密级与水印；无权限字段/附件遮罩并提供“申请提升”入口；分享/导出对话框内默认开启水印与遮罩选项。
- 绩效视角：看板/统计按人/组/部门展示分值/完成度；报表导出。
- 空状态/异常：无离线模式提示；冲突提示引导人工合并；高负载提示（不自动降级）。
