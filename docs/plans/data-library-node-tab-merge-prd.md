# 数据资源库：节点视图（PBS+任务）合并 PRD

## 1. 背景
当前「数据资源库」Drawer 提供 `PBS / 任务 / 文件夹` 三个组织视图。随着图谱（脑图）节点类型增加（DATA、REQUIREMENT、APP…），`PBS` 与 `任务` 两个 Tab 在信息层面高度重叠，且在“从图谱根节点出发”进行结构化浏览时会产生割裂：

- 用户在图谱中以**根节点**为单一真相源（SoT）构建层级，但数据资源库需要在 PBS 与任务之间来回切换才能完成关联/追溯。
- 图谱上层可能存在“数据节点/普通节点”等非 PBS/任务语义层（例如：第 2 层是 DATA，第 3 层才开始出现 PBS），此时直接呈现整棵树会引入噪音。

因此需要将 `PBS/任务` 合并为统一的「节点视图」，并按图谱结构动态投影，只展示包含 PBS/任务 的子树片段，同时保持资产面板的输入/输出/参考分栏与可追溯性。

## 2. 目标与非目标

### 2.1 目标（MVP）
- 合并 `PBS` 与 `任务` 为单一 Tab：`节点（PBS+任务）`，保留 `文件夹` Tab。
- 节点视图从图谱根节点投影，只展示 `PBS/TASK` 的**子树片段（Fragment）**，隐藏 DATA/ORDINARY/REQUIREMENT/APP 等非 PBS/任务节点。
- 支持节点**多选**，右侧资产面板按 `输入/输出/参考` 分栏展示所选节点资产的并集去重，并展示**溯源**。
- 溯源以“从图谱根节点开始的路径”为准；路径过长自动折叠，仅依赖 breadcrumb，不在树中展示被隐藏的数据节点上下文。
- 支持两个独立搜索入口：
  - 搜索 `PBS/任务` 节点
  - 搜索资产（数据资源）
- 解绑语义：在节点视图中对资产的“删除/移除”仅做**解绑**；物理删除在 `文件夹` 视图执行。

### 2.2 非目标（MVP 不做）
- 不实现资产关系的自动推导（后续单独 Story）。
- 不实现节点拖拽改父节点/重排。
- 不在节点视图内提供资产的物理删除能力。
- 不引入新的权限模型（MVP 与现状一致或暂忽略）。

## 3. 关键约束与事实
- 根节点：图谱（脑图）的根节点。
- 层级关系：节点（PBS/任务）均为图谱节点，且**单父**（一个节点只归属一个父节点）；允许 `任务包含 PBS`、`PBS 包含任务`，也允许同类包含（PBS→PBS、任务→任务）。
- PBS 资产范围：选中 PBS 时，仅展示 PBS **自身**关联的资产（不自动汇总子孙节点资产）。
- 规模：节点数量约 ≤ 1k（单图谱/单资源库）。

## 4. 术语与定义
- **图谱节点（Mindmap Node）**：图谱中的所有节点，含语义类型 `NodeType`。
- **语义节点（Anchor Node）**：`nodeType ∈ { PBS, TASK }` 的节点。
- **子树片段（Fragment）**：从根节点出发，将图谱树投影到仅包含语义节点的“压缩树/森林”；只保留包含 PBS/TASK 的分支。
- **投影/压缩（Projection）**：视图层重建父子关系：语义节点的显示父节点是其“最近的语义祖先”，中间非语义节点被隐藏但保留在 breadcrumb 路径中。
- **资产（Data Asset）**：数据资源库中的文件/模型/文档等。
- **节点-资产关系（Link）**：节点与资产的关联，分为 `input / output / reference` 三类（可追溯）。
- **溯源（Provenance）**：资产与节点的关联链路，用“根节点 → … → 节点”的路径表达；同一资产可来自多个输出节点或被多个节点引用。

## 5. 信息架构（IA）
数据资源库 Drawer：
- Tab 1：`节点（PBS+任务）`
  - 左侧：节点树（投影后的 PBS/TASK 片段）
  - 右侧：资产面板（输入/输出/参考分栏）
- Tab 2：`文件夹`
  - 维持现有文件夹/资产管理能力（含物理删除）

## 6. 功能需求（MVP）

### 6.1 节点树：片段生成规则
输入：图谱根节点为起点的原始树（包含全部 `NodeType`）。

输出：仅包含 `NodeType.PBS` 与 `NodeType.TASK` 的“片段森林”。

投影算法（定义行为，非实现细节）：
1) **过滤**：选取所有语义节点 `A = { n | n.type ∈ {PBS, TASK} }`。
2) **重挂载**：对每个 `n ∈ A`，在原始 parent 链上找到最近的语义祖先 `p ∈ A`：
   - 若存在 `p`：在节点树中显示为 `p` 的子节点
   - 若不存在 `p`：在节点树中作为片段根节点（Top-level）
3) **排序**：维持原始树的同级顺序（若原始顺序存在），否则按名称排序作为降级策略。

约束：
- 投影仅影响“节点视图”的展示层级，不修改图谱真实 parentId。
- 节点树不展示被隐藏的 DATA/ORDINARY/REQUIREMENT/APP 等节点；它们只出现在 breadcrumb 路径中。

### 6.2 节点选择（单选/多选）
- 支持单选（点击行/卡片）。
- 支持多选（checkbox 方式为主，允许跨片段选择）。
- 提供“清空选择”入口；可显示已选数量。

选择语义：
- 单选：右侧仅展示该节点**自身**关联的资产（input/output/reference）。
- 多选：右侧展示所选节点集合 `S` 的资产**并集去重**：
  - 去重键：`assetId`
  - 同一资产在不同节点可具有不同 `linkType`；右侧按 `input/output/reference` 分栏时，资产可同时出现在多个分栏（或以角色徽标归并，最终实现由现有 UI 能力决定）。

### 6.3 资产面板（输入/输出/参考）
沿用现有三分栏结构（参考现有实现）：
- 输入（Input）
- 输出（Output）
- 参考（Reference）

每个资产卡片需展示：
- 基本信息：名称、格式/类型、版本、标签等（沿用现有能力）
- 操作：解除关联（解绑）
- 溯源摘要（见 6.4）

### 6.4 溯源与 breadcrumb（必须）

#### 6.4.1 节点 breadcrumb
当选中节点时，右侧面板顶部显示从**图谱根节点**到该节点的路径：
- 路径基于原始 parent 链（包含被隐藏的 DATA/ORDINARY 等节点）
- 路径过长时自动折叠：`Root / … / Parent / Current`
- breadcrumb 每一段可点击，用于快速定位到对应节点（节点视图内）。

#### 6.4.2 资产溯源（Provenance）
资产卡片需可追溯“该资产与哪些节点发生了何种关系”：
- 对于单选：显示该资产与当前节点的关系 + 资产在整个图谱中的其他关联节点（至少包含输出来源与被引用去向）
- 对于多选：显示该资产在所选节点集合内的关联节点列表（按 `input/output/reference` 聚合），并提供展开查看完整路径

溯源表现要求：
- 默认展示“精简摘要”（例如：`输出：2` / `引用：5`），点击展开显示节点路径列表
- 路径展示使用与节点 breadcrumb 相同的折叠策略
- 点击某条路径可定位/选中对应节点

### 6.5 搜索（两个独立入口）

#### 6.5.1 节点搜索（PBS/任务）
- 作用域：节点视图（投影后的 PBS/TASK 节点集合）
- 匹配：节点名称（可选扩展：PBS code、任务自定义字段）
- 结果呈现：过滤/高亮命中，并自动展开命中路径
- 清空搜索后恢复完整片段森林

#### 6.5.2 资产搜索
- 作用域：数据资源库内的资产（graphId 级别）
- 匹配：资产名称；可选扩展：标签、格式、版本
- 结果呈现：
  - 在右侧面板展示命中资产列表（仍按 输入/输出/参考 分栏或以“搜索结果”视图呈现，取决于现有实现成本）
  - 每个结果必须可查看溯源，并可一键定位到关联节点

### 6.6 解绑与删除
- 在节点视图中，对资产的“删除/移除”语义为**解绑**（移除 `NodeDataLink`），不得删除资产实体。
- 资产物理删除仅允许在 `文件夹` 视图中执行（与现有一致）。

## 7. 非功能需求（MVP）
- 性能：节点树在 1k 节点规模下可流畅展开/搜索；建议使用虚拟列表或分片渲染作为实现手段。
- 易用性：多选状态与搜索状态应可见、可一键清空；空态应给出行动提示（例如：未找到 PBS/任务 节点时提示在图谱中设置节点类型）。

## 8. 验收标准（AC）
- AC1：数据资源库 Drawer 中 `PBS` 与 `任务` Tab 合并为 `节点（PBS+任务）`，保留 `文件夹` Tab。
- AC2：节点视图仅展示 `NodeType.PBS` 与 `NodeType.TASK` 的投影片段；DATA/ORDINARY 等节点不在树中出现。
- AC3：breadcrumb 能从图谱根节点展示到当前节点的完整路径，并对长路径折叠。
- AC4：支持节点多选；右侧按输入/输出/参考展示资产并集去重；资产卡片展示溯源并可定位到关联节点。
- AC5：提供两个独立搜索入口：节点搜索与资产搜索；两者互不干扰且可清空恢复。
- AC6：节点视图中的资产“移除”仅解绑，不删除资产；物理删除在文件夹视图执行。

## 9. 后续迭代（Stories）
- 自动推导资产流转：基于输出→下游输入的规则自动生成/建议关联（含冲突处理与可撤销）。
- 权限/密级：资产与节点关联的访问控制与审计增强。
- 更丰富的搜索：支持按标签/格式/时间范围筛选与排序。

## 10. 附录：数据结构对齐（现有类型）
- 节点类型：`packages/types/src/node-types.ts` 中 `NodeType.PBS`、`NodeType.TASK`、`NodeType.DATA` 等。
- 节点-资产关系：`packages/types/src/data-library-types.ts` 中 `NodeDataLink` 与 `DataLinkType = input | output | reference`。
