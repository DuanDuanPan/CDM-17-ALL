# Story 8.9 影响分析报告

## 📊 分析结论

**整体评估**：✅ **无严重冲突**，可以安全实施。发现 2 个需注意的交互点。

---

## 🔴 冲突分析

### 1. 快捷键冲突检查

| 快捷键 | 现有用途 | Story 8.9 用途 | 状态 |
|--------|----------|----------------|:----:|
| `Enter` | 创建兄弟节点 | ❌ 不使用 | ✅ |
| `Cmd/Ctrl+Enter` | ⚠️ 当前会落入 `Enter` 创建逻辑（需拦截） | 下钻快捷键 | ⚠️ 需修正 |
| `Backspace` | 删除选中的**边**（非节点） | ❌ 不使用 | ✅ |
| `Escape` | 退出依赖模式/编辑模式 | ❌ 不使用（返回通过面包屑） | ✅ |

> **最终决策**：返回上层仅通过面包屑导航实现，无需任何快捷键，避免与现有 Escape/Backspace 逻辑冲突。

### 2. 右键菜单冲突检查

| 现有菜单项 | Story 8.9 新增项 | 冲突 |
|------------|------------------|:----:|
| 复制/剪切/粘贴 | - | ✅ 无冲突 |
| 关注节点 | - | ✅ 无冲突 |
| 折叠/展开 (8.1) | - | ✅ 无冲突 |
| 保存为模板 (5.2) | - | ✅ 无冲突 |
| - | **进入子图** | ✅ 新增 |

> **结论**：右键菜单可直接添加"进入子图"选项，无冲突。

---

## 🟡 功能交互分析

### 1. Story 8.1 折叠/展开

| 场景 | 行为 | 自洽性 |
|------|------|:------:|
| 折叠节点后下钻 | 子图显示所有后代（含已折叠的；下钻不改变折叠状态） | ✅ 合理 |
| 下钻后折叠子节点 | 在子图内正常折叠 | ✅ 合理 |
| 返回主图 | 保持之前的折叠状态 | ✅ 合理 |

> **结论**：折叠是**节点内部状态**，下钻是**视图过滤**，两者正交。

### 2. Story 8.5 Focus Mode

| 场景 | 行为 | 自洽性 |
|------|------|:------:|
| 下钻后启用 Focus | 在子图内淡化非关联节点 | ✅ 合理 |
| Focus 中下钻 | 进入子图，Focus 保持（下钻仅隐藏非子树节点，无需新增重算 API） | ✅ 合理 |
| 返回时 Focus 状态 | 保持 Focus；现有 hook 会在选中节点/层级变化时自动更新 | ✅ 合理 |

### 3. Story 8.8 Semantic Zoom (LOD)

| 场景 | 行为 | 自洽性 |
|------|------|:------:|
| 子图内缩放 | LOD 正常工作 | ✅ 无冲突 |
| 下钻/返回时的缩放级别 | 建议：记忆各层级的缩放 | 可选增强 |

---

## 🟢 数据模型一致性

| 检查项 | 结果 |
|--------|:----:|
| 下钻是否修改 Yjs 数据？ | ❌ 否（仅视图过滤） |
| 子图内操作是否正常同步？ | ✅ 是（Yjs 保持完整结构） |
| 返回主图后数据一致？ | ✅ 是 |

---

## 📝 Story 文档更新建议

### 需修改的 AC/设计点

1. **快捷键说明修正**：
   - `Cmd/Ctrl+Enter` 必须在 `useGraphHotkeys` 中优先拦截，否则会落入现有 `Enter` 创建逻辑。
2. **Focus Mode 说明修正**：
   - 不需要新增 `recalculateFocus()` 之类的接口；Focus Mode 现有 hook 已会在依赖变化时重算。

---

## ✅ 实施建议

1. **快捷键**：仅使用 `Cmd/Ctrl+Enter` 下钻，**无返回快捷键**
2. **返回方式**：仅通过面包屑导航返回上层，简化与现有 Escape 逻辑的冲突
3. **右键菜单**：在 `NodeContextMenu.tsx` 中添加"进入子图"选项，位于"折叠/展开"区块之后
4. **双击行为**：保持现有双击进入编辑模式的行为，不触发下钻
5. **Focus Mode**：保持现状；下钻仅影响可见性，Focus Mode 的既有计算/更新机制继续工作
