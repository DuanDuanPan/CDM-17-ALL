# Validation Report

**Document:** docs/sprint-artifacts/9-5-data-upload-node-linking.md  
**Checklist:** _bmad/bmm/workflows/4-implementation/create-story/checklist.md  
**Date:** 2026-01-11T22-24-16+0800  
**Agent Model:** GPT-5.2 (Codex CLI)

## Summary
- Overall: 34/80 passed (42.5%); Partial: 37; Fail: 6; N/A: 3
- Critical Issues: 6

## Section Results

### Critical Mistakes to Prevent
Pass Rate: 1/8 (12.5%)

⚠ PARTIAL — Reinventing wheels  
Evidence: Story 提到复用预览与附件存储（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:40-44`），但又要求“创建 DataAssetRepository/NodeDataLinkRepository”（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:260-263`）而 repo 已存在（`apps/api/src/modules/data-management/data-asset.repository.ts:26-29`；`apps/api/src/modules/data-management/node-data-link.repository.ts:9-10`）。  
Impact: Dev 可能重复造轮子/重复抽象，增加返工与合并冲突风险。

⚠ PARTIAL — Wrong libraries  
Evidence: Story 要求复用 `AttachmentService`（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:41-43,250-252`），但后端现有文件存储实现为 `FileService`（`apps/api/src/modules/file/file.service.ts:1-6,29-39`）且未发现 `AttachmentService`。  
Impact: Dev 按 Story 实现会在“依赖不存在/找不到服务”处卡住。

✗ FAIL — Wrong file locations  
Evidence: Story/Tech-Spec 指向 `apps/web/features/workspace/components/...` 与 `RightSidebar/NodeDetailPanel.tsx`（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:295-301,478-483`；`docs/sprint-artifacts/tech-spec-9-5-data-upload-node-linking.md:231-233`），但当前 RightSidebar 实际入口为 `apps/web/components/layout/RightSidebar.tsx` 且渲染的是 `PropertyPanel`（`apps/web/components/layout/RightSidebar.tsx:8-12,85-96`）。  
Impact: 直接导致实现落点错误、组件集成路径错误，属于高概率阻塞。

⚠ PARTIAL — Breaking regressions  
Evidence: 现有前端已依赖 `/api/data-assets/links` 与 `/api/data-assets/links:byNodes`（`apps/web/features/data-library/api/data-assets.ts:258-297`；`apps/api/src/modules/data-management/data-asset.controller.ts:195-213`），Story/Tech-Spec 却定义另一套 `/api/nodes/:nodeId/data-assets` 等端点（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:141-145`；`docs/sprint-artifacts/tech-spec-9-5-data-upload-node-linking.md:184-187`）。  
Impact: 若按 Story 新增/改动接口与返回结构，容易造成既有 PBS/Task 视图回归或形成双轨接口。

✓ PASS — Ignoring UX  
Evidence: Story 明确给出了 UploadButton、关联 Dialog、详情面板“关联资产”区块的 UI 规范与布局（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:181-240`）。  

⚠ PARTIAL — Vague implementations  
Evidence: “复用现有节点搜索逻辑”未指明复用点/文件/数据源（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:283-287`）；并且 Story 未明确“如何拿到/展示 linkType（关联类型）”的 API 响应形态（现有 GET /data-assets/links 只返回 assets）（`apps/api/src/modules/data-management/data-asset.controller.ts:195-202`；`apps/api/src/modules/data-management/node-data-link.service.ts:56-59`）。  
Impact: 关键交互（节点选择器、关联类型展示）会迫使 Dev 在实现时临时补设计。

⚠ PARTIAL — Lying about completion  
Evidence: Story 有明确 AC + 测试矩阵 + data-testid（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:47-83,494-506,516-627`），但 AC2/格式映射使用 `MESH/CONTOUR/DOCUMENT` 等值（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:55-64`）与实际 `DataAssetFormat` 不一致（`packages/types/src/data-library-types.ts:13-28`）。  
Impact: Dev 即使“按 Story 完成”，也可能无法在类型/枚举层面通过构建或满足验收断言。

⚠ PARTIAL — Not learning from past work  
Evidence: Story 引用 9.1/9.4 与现有 E2E harness（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:173-177,447-452,509-513`），但未复用/指明已存在的 Node-Asset link API（`apps/web/features/data-library/api/data-assets.ts:258-297`）与 RightSidebar/PropertyPanel 集成模式（`apps/web/components/layout/RightSidebar.tsx:8-12,85-96`）。  
Impact: 容易重复实现同类能力并偏离既有架构惯例。

---

### Step 1: Load and Understand the Target
Pass Rate: 6/6 (100.0%)

✓ PASS — Load the workflow configuration  
Evidence: Workflow 配置存在且包含变量/输出路径/validation checklist（`_bmad/bmm/workflows/4-implementation/create-story/workflow.yaml:1-32`）。  

✓ PASS — Load the story file  
Evidence: Story 文件存在且可定位 status/AC/Tasks（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:1-85`）。  

✓ PASS — Load validation framework  
Evidence: Validation framework 存在并定义输出格式与“不跳过任何项”的规则（`_bmad/core/tasks/validate-workflow.xml:18-35,37-71`）。  

✓ PASS — Extract metadata (epic/story key/title)  
Evidence: 标题为 “Story 9.5 …” 且状态 `ready-for-dev`（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:1-3`）。  

✓ PASS — Resolve workflow variables  
Evidence: config 指定 `output_folder` 与 `sprint_artifacts`（`_bmad/bmm/config.yaml:8-13`），workflow 使用这些变量定位 epics/architecture 与 story_dir（`_bmad/bmm/workflows/4-implementation/create-story/workflow.yaml:6-26`）。  

✓ PASS — Understand current status  
Evidence: Story 为 `ready-for-dev`（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:3`），Tech-Spec 为 “Ready for Development”（`docs/sprint-artifacts/tech-spec-9-5-data-upload-node-linking.md:3-5`）。  

---

### Step 2.1: Epics and Stories Analysis
Pass Rate: 6/6 (100.0%)

✓ PASS — Load epics file  
Evidence: Epics 文件存在并包含 Epic 9 与 Story 9.5（`docs/epics.md:1055-1165`）。  

✓ PASS — Epic objectives and business value  
Evidence: Epic 9 目标为“独立数据资源库 + 自动汇聚 + 工业格式预览”（`docs/epics.md:1055-1058`）。  

✓ PASS — ALL stories in this epic (cross-story context)  
Evidence: Epic 9 枚举 9.1–9.6，包含 9.5（`docs/epics.md:1059-1165`）。  

✓ PASS — Story requirements and acceptance criteria alignment  
Evidence: Epic 9.5 的 AC 与 Story 9.5 的 AC1–AC4 语义一致（`docs/epics.md:1127-1145`；`docs/sprint-artifacts/9-5-data-upload-node-linking.md:49-78`）。  

✓ PASS — Technical requirements and constraints  
Evidence: Story 明确 in/out scope 与实现约束（复用存储、Hook-first、Repo pattern、行数限制）（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:24-44,87-178,345-417`）。  

✓ PASS — Cross-story dependencies and prerequisites  
Evidence: Story 指明依赖 9.1-9.4 已完成能力，并复用现有 preview modal（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:15-21,40-44,447-452`）。  

---

### Step 2.2: Architecture Deep-Dive
Pass Rate: 3/10 (30.0%)

✓ PASS — Load architecture file  
Evidence: Architecture 文档存在且包含 Epic 9 Data Management 章节（`docs/architecture.md:714-858`）。  

✓ PASS — Technical stack with versions  
Evidence: 前端依赖中 `online-3d-viewer` 与 `@kitware/vtk.js` 版本与 Story 一致（`apps/web/package.json:29-40`；`docs/sprint-artifacts/9-5-data-upload-node-linking.md:485-493`）。  

⚠ PARTIAL — Code structure and organization patterns  
Evidence: Story 给出 data-library 落点（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:454-477`）与现有结构一致（`apps/web/features/data-library/components/DataLibraryDrawer.tsx:1-33`），但 RightSidebar 集成位置写错（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:478-483` vs `apps/web/components/layout/RightSidebar.tsx:8-12,85-96`）。  
Impact: 前端实现会在集成阶段偏航（改错目录/改错组件）。

✗ FAIL — API design patterns and contracts  
Evidence: Story/Tech-Spec 将“节点关联资产查询”定义为 `GET /api/nodes/:nodeId/data-assets`（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:141-145`；`docs/sprint-artifacts/tech-spec-9-5-data-upload-node-linking.md:184-187`），但现有实现与前端调用为 `GET /api/data-assets/links?nodeId=...`（`apps/api/src/modules/data-management/data-asset.controller.ts:195-202`；`apps/web/features/data-library/api/data-assets.ts:258-272`）。  
Impact: 合约不一致会导致“实现了但前端不工作”或引入重复接口；且 Story 未说明如何返回 linkType 以支持 AC4。

✗ FAIL — Database schemas and relationships  
Evidence: Story 的 prisma 片段使用 `DataFormat { STEP, MESH, CONTOUR, DOCUMENT, OTHER }` 与 `LinkType { INPUT, OUTPUT, REFERENCE }`（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:96-130`），但实际 schema 为 `DataAssetFormat`（STEP/IGES/STL/OBJ/…/OTHER）且 `NodeDataLink.linkType` 为字符串（reference/attachment/source）（`packages/database/prisma/schema.prisma:426-519`；`packages/types/src/data-library-types.ts:13-33`）。  
Impact: 直接导致实现/测试在类型与 DB 层面失配（迁移/类型/接口需要同步调整，但 Story 说“不修改模型”）。

⚠ PARTIAL — Security requirements and patterns  
Evidence: Story 提到“验证 nodeId 存在性 + 权限”（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:254-259`），但未定义上传端点的 file size 限制/鉴权策略；现有 Guard 在非 production 下放行（`apps/api/src/modules/data-management/guards/data-management-auth.guard.ts:14-19`）。  
Impact: 上传/关联接口可能在边界条件下暴露越权或滥用风险（尤其未来接入真实鉴权时）。

⚠ PARTIAL — Performance requirements and optimization strategies  
Evidence: Story 将“大文件分片上传”明确 out-of-scope（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:34-39`），但未给出基础的 max file size/内存策略；而 Nest `FileInterceptor` 默认会把文件放在内存/临时处理，缺少限制易导致内存压力。  
Impact: 在真实大文件（工业格式）场景下可能造成 API 进程 OOM 或响应变慢。

✓ PASS — Testing standards and frameworks  
Evidence: Story 明确单测（Vitest）+ E2E（Playwright）+ 后端测试（Jest）及用例清单（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:315-343,516-627`；`docs/project-context.md:116-130`）。  

➖ N/A — Deployment and environment patterns  
Evidence: 本 Story 不涉及 CI/CD、部署或运行环境变更。  

⚠ PARTIAL — Integration patterns and external services  
Evidence: Story 复用 `ModelViewerModal/ContourViewerModal` 进行预览（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:42-44,298-299`），且现有 DataLibraryDrawer 已通过 dynamic import 集成（`apps/web/features/data-library/components/DataLibraryDrawer.tsx:35-45,95-97`）。但上传存储复用点写成不存在的 `AttachmentService`（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:41-43`）。  
Impact: 复用方向正确，但关键集成点命名错误会导致落地受阻。

---

### Step 2.3: Previous Story Intelligence
Pass Rate: 3/7 (42.9%)

✓ PASS — Load previous story file  
Evidence: Story 引用前序 9.1/9.4 文档作为来源（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:509-513`），且这些文件存在（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:1-4`）。  

⚠ PARTIAL — Dev notes and learnings  
Evidence: Story 提供 Dev Notes 与依赖/落点/测试要点（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:434-506`），但其中关键命名/落点与现状不一致（AttachmentService、workspace 路径）（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:440-443,478-483`）。  
Impact: “Dev Notes” 本应降低风险，却会把 Dev 带到错误实现路径。

➖ N/A — Review feedback and corrections needed  
Evidence: 未发现与本 Story 直接关联的 review/retro 产物被要求加载或遵循。  

⚠ PARTIAL — Files created/modified and their patterns  
Evidence: Story 给出文件结构清单（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:454-483`），但其中 RightSidebar 集成文件与目录在现有代码中不匹配（`apps/web/components/layout/RightSidebar.tsx:8-12,85-96`）。  
Impact: Dev 可能在不存在的目录中创建新实现，导致分散与重复。

✓ PASS — Testing approaches that worked/didn’t work  
Evidence: Story 明确沿用现有 E2E harness（`createTestGraph/makeTestGraphUrl` + `page.getByTitle('数据资源库').click()`）（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:173-177`；`apps/web/e2e/data-library.spec.ts:10-37`）。  

⚠ PARTIAL — Problems encountered and solutions found  
Evidence: 现有后端路由有“冒号需要转义”的历史坑（`apps/api/src/modules/data-management/data-asset.controller.ts:12-14`），但 Story 在新增 `:upload` 时未强调必须使用 `data-assets\\:upload` 的写法。  
Impact: Dev 容易因路由不匹配导致 404/误把 `:upload` 当成 path param 而阻塞。

✓ PASS — Code patterns and conventions established  
Evidence: Story 护栏引用 Repo pattern、Hook-first、300 行限制与 UI 组件来源（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:345-417`；`docs/project-context.md:84-108,92-94`）。  

---

### Step 2.4: Git History Analysis
Pass Rate: 5/5 (100.0%)

✓ PASS — Files created/modified in previous work  
Evidence: Epic 9 的核心文件在历史提交中已落地（例如 `cff0f8d feat(story-9.1)` 涉及 data-management + data-library + schema；`7d25f59` 扩展 org views）（`git show --name-only cff0f8d`；`git show --name-only 7d25f59`）。  

✓ PASS — Code patterns and conventions used  
Evidence: 既有实现采用 Hook-first、data-testid、dynamic import 规避 SSR（`apps/web/features/data-library/components/DataLibraryDrawer.tsx:35-45,95-97`；`apps/web/features/data-library/hooks/useTaskAssets.ts:9-45`）。  

✓ PASS — Library dependencies added/changed  
Evidence: `online-3d-viewer` 已在 2bf6d52 中使用 `^0.18.0`（`git show 2bf6d52:apps/web/package.json`），当前还包含 `@kitware/vtk.js 34.3.1`（`git show eec9af5:apps/web/package.json`）。  

✓ PASS — Architecture decisions implemented  
Evidence: Data management 采用 NocoBase `:action` 路由风格并在 Controller 中显式说明“转义冒号”（`apps/api/src/modules/data-management/data-asset.controller.ts:5-14`），Repo pattern 已拆出 repo/service 文件（`apps/api/src/modules/data-management/data-asset.repository.ts:1-6`）。  

✓ PASS — Testing approaches used  
Evidence: data-library E2E 使用 API seed + testUtils（`apps/web/e2e/data-library.spec.ts:6-37`），industrial viewer E2E/单测也在历史提交中持续演进（`git show --name-only 2bf6d52`）。  

---

### Step 2.5: Latest Technical Research
Pass Rate: 1/4 (25.0%)

✓ PASS — Identify libraries/frameworks mentioned  
Evidence: Story/Tech-Spec 明确涉及 Nest Multer 上传、@cdm/ui、lucide-react、Online3DViewer、VTK.js（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:485-493`；`docs/sprint-artifacts/tech-spec-9-5-data-upload-node-linking.md:171-176`；`apps/web/package.json:29-40`）。  

⚠ PARTIAL — Breaking changes or security updates  
Evidence: Story/Tech-Spec 未提供任何相关依赖（Nest/Multer、online-3d-viewer、vtk.js）的 release notes 或安全注意事项。  
Impact: 依赖升级/环境差异可能在实现阶段才暴露（尤其上传大小限制与浏览器文件类型）。

⚠ PARTIAL — Performance improvements or deprecations  
Evidence: Story 仅声明“大文件分片上传” out-of-scope（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:34-39`），未给出针对大文件/多文件上传的性能策略（并发、限流、流式写入）。  
Impact: 在真实工业文件上传时容易出现 UI 卡顿/服务端压力峰值。

⚠ PARTIAL — Best practices for current versions  
Evidence: Story 未明确上传端点应使用 max file size validator / 错误回传规范；现有 FileController 参考实现带 MAX_FILE_SIZE 与 ParseFilePipe（`apps/api/src/modules/file/file.controller.ts:23-65`）。  
Impact: Dev 可能实现一个“能跑但不稳”的上传接口。

---

### Step 3.1: Reinvention Prevention Gaps
Pass Rate: 0/3 (0.0%)

⚠ PARTIAL — Wheel reinvention  
Evidence: Story 要求复用预览 modal（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:42-44`），但对“关联查询/批量查询”已在 9.2 落地的 API/hook 没有复用指引（`apps/web/features/data-library/hooks/useTaskAssets.ts:1-45`；`apps/web/features/data-library/api/data-assets.ts:258-297`）。  
Impact: Dev 可能重复实现“获取节点资产”逻辑，造成双套实现与不一致。

⚠ PARTIAL — Code reuse opportunities not identified  
Evidence: 现有后端已提供 link 创建/删除端点（`apps/api/src/modules/data-management/data-asset.controller.ts:215-239`），但 Story 的任务分解仍以“实现 /api/data-assets/:id/links + /api/node-data-links/:linkId”为主（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:254-258`）。  
Impact: 会导致“已有能力不用、又新造一套”的重复与维护成本。

⚠ PARTIAL — Existing solutions not mentioned  
Evidence: 现有 preview gating 已封装在 `getAssetPreviewType`（含 VTK 扩展名识别）（`apps/web/features/data-library/hooks/useAssetPreview.ts:27-78`），Story 在“上传后格式识别/预览”部分未对齐这一策略（仍以 CONTOUR/MESH 分类）（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:55-64,147-171`）。  
Impact: 上传实现可能与预览系统脱节（上传写入的 format/tag 无法触发预览）。

---

### Step 3.2: Technical Specification DISASTERS
Pass Rate: 0/5 (0.0%)

⚠ PARTIAL — Wrong libraries/frameworks  
Evidence: Story 使用不存在的 `AttachmentService`（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:41-43`），而现有复用点为 `FileService`（`apps/api/src/modules/file/file.service.ts:29-61`）。  
Impact: “选错组件/服务”会直接阻塞实现或导致无谓重构。

✗ FAIL — API contract violations  
Evidence: Story/Tech-Spec 定义 link 相关端点为 `/api/data-assets/:id/links`、`/api/nodes/:nodeId/data-assets`、`/api/node-data-links/:linkId`（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:141-145`；`docs/sprint-artifacts/tech-spec-9-5-data-upload-node-linking.md:184-187`），但现有实现与调用为 `/api/data-assets/links`、`/api/data-assets/links:byNodes`、`DELETE /api/data-assets/links:destroy?nodeId&assetId`（`apps/api/src/modules/data-management/data-asset.controller.ts:195-239`；`apps/web/features/data-library/api/data-assets.ts:258-297`）。  
Impact: 合约冲突会导致前端/后端不同步；同时 AC4 要显示“关联类型”，现有 GET links 返回 assets 并丢失 linkType（`apps/api/src/modules/data-management/node-data-link.service.ts:56-59`）。

✗ FAIL — Database schema conflicts  
Evidence: Story/Tech-Spec 的 `DataFormat`/`LinkType` 枚举与当前 `DataAssetFormat`/`DataLinkType` 不一致（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:96-130`；`docs/sprint-artifacts/tech-spec-9-5-data-upload-node-linking.md:196-206` vs `packages/database/prisma/schema.prisma:426-519`；`packages/types/src/data-library-types.ts:13-33`）。  
Impact: 需要明确：是要迁移 schema+types+API 以支持 INPUT/OUTPUT/REFERENCE 与 CONTOUR/MESH，还是要按现有枚举实现并调整 AC（否则实现无法落地/测试无法通过）。

⚠ PARTIAL — Security vulnerabilities  
Evidence: Story 未要求上传端点设置大小限制/类型校验；而现有 FileController 有 MAX_FILE_SIZE + 校验（`apps/api/src/modules/file/file.controller.ts:23-76`）。  
Impact: 易被上传超大/恶意文件拖垮服务（即便 MVP 也需基本限制）。

⚠ PARTIAL — Performance disasters  
Evidence: Story 明确不做分片上传（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:34-39`），但也未要求后端采用流式写入/限流；复用 FileService 当前实现会将 buffer 写入磁盘（`apps/api/src/modules/file/file.service.ts:54-62`）。  
Impact: 多文件/大文件上传时可能造成 API 响应变慢、内存/磁盘 IO 压力峰值。

---

### Step 3.3: File Structure DISASTERS
Pass Rate: 1/4 (25.0%)

✗ FAIL — Wrong file locations  
Evidence: Story/Tech-Spec 将“节点详情面板”集成点写在 `apps/web/features/workspace/components/...`（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:295-301,478-483`；`docs/sprint-artifacts/tech-spec-9-5-data-upload-node-linking.md:231-233`），但当前实际 UI 结构是 `RightSidebar → PropertyPanel`（`apps/web/components/layout/RightSidebar.tsx:8-12,85-96`；`apps/web/components/PropertyPanel/index.tsx:3-6`）。  
Impact: 这会直接导致实现放错层级/不走现有渲染链路，属于必须修正的阻塞点。

✓ PASS — Coding standard violations  
Evidence: Story 明确要求基础 UI 来自 `@cdm/ui` 且遵守文件行数限制（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:388-417`；`docs/project-context.md:92-94,150-152`）。  

⚠ PARTIAL — Integration pattern breaks  
Evidence: RightSidebar 已在 7.8 中将逻辑下沉到 hooks 并通过 PropertyPanel 统一渲染（`apps/web/components/layout/RightSidebar.tsx:4-12,32-63`）；Story 未描述如何在 PropertyPanel 体系内新增“关联资产区域”（只写“RightSidebar 底部新增区域”）（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:219-239,295-301`）。  
Impact: Dev 可能绕开既有结构导致实现与其他 panel 不一致、难测试/难维护。

➖ N/A — Deployment failures  
Evidence: 不涉及部署/环境变量/构建流程变更。  

---

### Step 3.4: Regression DISASTERS
Pass Rate: 1/4 (25.0%)

⚠ PARTIAL — Breaking changes  
Evidence: 若为满足 AC3/AC4 将 `DataLinkType` 从 `reference/attachment/source` 改为 `input/output/reference`，需要同步更新后端 DTO 校验常量与可能的 seed 脚本（`apps/api/src/modules/data-management/dto/constants.ts:28-32`；`apps/api/scripts/create-story-9-data.ts:314-317`）。  
Impact: 可能导致已有组织视图/seed 数据/接口校验回归或迁移成本未被估计。

⚠ PARTIAL — Test failures  
Evidence: Story 的 E2E 计划大量断言 “format=STEP/MESH/CONTOUR/DOCUMENT/OTHER”（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:324-336`），但实际类型为 `DataAssetFormat`（无 MESH/CONTOUR/DOCUMENT）（`packages/types/src/data-library-types.ts:13-28`）。  
Impact: 测试断言将与实现/类型不一致，导致测试不可落地或持续失败。

✓ PASS — UX violations  
Evidence: UX 交互（上传、关联、详情面板展示、预览、解除）描述完整（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:181-240,72-83`）。  

⚠ PARTIAL — Learning failures  
Evidence: 既有 data-library 已实现“按节点展示关联资产”的查询链路（`apps/web/features/data-library/hooks/useTaskAssets.ts:1-62`），Story 未把该链路作为“必须复用”的实现护栏。  
Impact: 容易重复实现并导致行为不一致（Drawer 视图 vs 右侧面板）。

---

### Step 3.5: Implementation DISASTERS
Pass Rate: 1/4 (25.0%)

⚠ PARTIAL — Vague implementations  
Evidence: Story 仅说“节点搜索/选择（复用现有节点搜索逻辑）”但未规定数据来源（GraphContext/Yjs/后端查询）与筛选规则（TASK/DATA）（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:283-287`；`packages/database/prisma/schema.prisma:16-22`）。  
Impact: 容易做出“能搜但不对”的节点选择器（性能差/不全/类型不对）。

⚠ PARTIAL — Completion lies  
Evidence: Story 虽给出测试清单，但 upload API 未指定必须携带 graphId；而 DataAsset 在 schema 与 DTO 中 graphId 为必填（`packages/database/prisma/schema.prisma:478-483`；`packages/types/src/data-library-types.ts:102-114`）。  
Impact: 不补齐关键参数/约束，开发可能交付一个“局部可用但不符合数据模型”的实现。

✓ PASS — Scope creep  
Evidence: Story 明确 out-of-scope（批量进度条、分片上传、权限/密级、大文件）并限定范围（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:24-39`）。  

⚠ PARTIAL — Quality failures  
Evidence: Story 有测试与护栏，但关键合约/枚举不一致会让“质量要求”无法落地（`docs/sprint-artifacts/tech-spec-9-5-data-upload-node-linking.md:196-206` vs `packages/types/src/data-library-types.ts:13-33`）。  
Impact: Dev 可能在实现中被迫临时修改 schema/types，导致范围漂移与质量不可控。

---

### Step 4: LLM-Dev-Agent Optimization Analysis
Pass Rate: 1/5 (20.0%)

⚠ PARTIAL — Verbosity problems  
Evidence: Story 包含大量测试样例代码骨架与重复清单（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:530-627`）。  
Impact: 关键阻塞点（API/枚举/落点）可能被淹没，浪费 token。

⚠ PARTIAL — Ambiguity issues  
Evidence: 节点选择器复用点/数据源不明确，linkType 与 DataLinkType 语义不一致（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:283-287,69-70`；`packages/types/src/data-library-types.ts:31-33`）。  
Impact: Dev agent 可能做出多种互斥实现路径。

⚠ PARTIAL — Context overload  
Evidence: 同时给出了 guardrails、详细任务、测试矩阵、测试代码骨架（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:243-343,345-431,516-627`），但缺少“最关键的对齐点”（现有 API/类型）。  
Impact: 信息量大但信号不足，降低 LLM 执行效率。

⚠ PARTIAL — Missing critical signals  
Evidence: Story 关键合约（link endpoints 与 DataAssetFormat/DataLinkType）与现状不一致（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:134-145,96-130` vs `apps/api/src/modules/data-management/data-asset.controller.ts:195-239`；`packages/types/src/data-library-types.ts:13-33`）。  
Impact: 最关键的阻塞点会在实现时才暴露（构建失败/接口不通/验收无法满足）。

✓ PASS — Poor structure  
Evidence: 结构清晰：Scope → AC → Constraints → UI Spec → Tasks → Guardrails → Dev Notes → Testing（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:24-627`）。  

---

### Step 4: LLM Optimization Principles
Pass Rate: 1/5 (20.0%)

⚠ PARTIAL — Clarity over verbosity  
Evidence: 建议将“测试骨架代码”改为更短的可执行 checklist + 指向现有 E2E helper（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:530-627`；`apps/web/e2e/data-library.spec.ts:28-37`）。  
Impact: 精简后更利于 Dev agent 把 token 用在实现上。

⚠ PARTIAL — Actionable instructions  
Evidence: 文件落点与 API 合约错误会让指令不可执行（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:141-145,478-483`）。  
Impact: Dev agent 按指令执行会被 404/类型不匹配阻塞。

✓ PASS — Scannable structure  
Evidence: 小节/Phase 划分明确，含 data-testid 表与测试矩阵（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:243-343,494-527`）。  

⚠ PARTIAL — Token efficiency  
Evidence: 重复列出同一批文件结构与任务清单（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:243-343,454-483`）。  
Impact: 可合并为“唯一真源”章节并减少重复。

⚠ PARTIAL — Unambiguous language  
Evidence: “格式识别”目标用 MESH/CONTOUR/DOCUMENT 分类，而实际系统以 DataAssetFormat + 扩展名/标签判定 previewType（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:55-64`；`apps/web/features/data-library/hooks/useAssetPreview.ts:31-74`）。  
Impact: 语义不一致导致实现分歧（format vs previewType vs tag）。

---

### Step 5: Improvement Recommendations
Pass Rate: 4/4 (100.0%)

✓ PASS — Critical Misses (Must Fix)  
Evidence: 见下方 Failed Items 与 Must Fix。  

✓ PASS — Enhancement Opportunities (Should Add)  
Evidence: 见下方 Partial Items 与 Should Improve。  

✓ PASS — Optimization Suggestions (Nice to Have)  
Evidence: 见下方 Consider。  

✓ PASS — LLM Optimization Improvements  
Evidence: 见下方 Recommendations（把“合约/枚举/落点对齐”前置为强约束）。  

---

## Failed Items
- Wrong file locations (Critical Mistakes): 修正集成落点到 `apps/web/components/layout/RightSidebar.tsx` / `apps/web/components/PropertyPanel/*`，不要创建 `apps/web/features/workspace/...`（`docs/sprint-artifacts/9-5-data-upload-node-linking.md:478-483`；`apps/web/components/layout/RightSidebar.tsx:8-12,85-96`）。  
- API design patterns and contracts (Step 2.2): 对齐现有 `/api/data-assets/links*` 合约或明确迁移方案，并补齐“返回 linkType”的响应结构（`apps/api/src/modules/data-management/data-asset.controller.ts:195-239`；`apps/web/features/data-library/api/data-assets.ts:258-297`）。  
- Database schemas and relationships (Step 2.2): 将 Story/Tech-Spec 的 DataFormat/LinkType 改为当前 `DataAssetFormat/DataLinkType`（或明确要做 schema+types 迁移）并同步更新 AC（`packages/database/prisma/schema.prisma:426-519`；`packages/types/src/data-library-types.ts:13-33`）。  
- API contract violations (Step 3.2): 同上，避免引入重复/冲突端点；新增 upload 时记得路由转义（`data-assets\\:upload`）（`apps/api/src/modules/data-management/data-asset.controller.ts:12-14`）。  
- Database schema conflicts (Step 3.2): 同上，尤其是 format mapping 中的 `MESH/CONTOUR/DOCUMENT` 与 `DataAssetFormat` 不兼容（`docs/sprint-artifacts/tech-spec-9-5-data-upload-node-linking.md:196-206`）。  
- Wrong file locations (Step 3.3): 同上，RightSidebar 体系已固定为 PropertyPanel（`apps/web/components/layout/RightSidebar.tsx:85-96`）。  

## Partial Items (Key)
- 存储服务命名：Story 写 `AttachmentService`，实际复用点应为 `FileService`（`apps/api/src/modules/file/file.service.ts:29-61`）。  
- linkType 语义：需求是 输入/输出/参考，但当前类型为 `reference/attachment/source`（`docs/epics.md:1139-1144`；`packages/types/src/data-library-types.ts:31-33`）。  
- Upload API 参数：需明确 `graphId` 必填（`packages/types/src/data-library-types.ts:102-114`），Story 未体现。  
- 预览触发策略：现有 `getAssetPreviewType` 基于扩展名/标签识别 VTK（`apps/web/features/data-library/hooks/useAssetPreview.ts:50-74`），upload 的 format/tag 写入策略需对齐。  

## Recommendations
1. Must Fix:
   - 统一 Story + Tech-Spec 与当前实现的“类型/枚举/数据模型”：以 `DataAssetFormat` 为准（`packages/types/src/data-library-types.ts:13-28`），把 AC2 与 format-detection mapping 改为输出 `STEP/IGES/STL/OBJ/GLTF/PDF/DOCX/XLSX/JSON/XML/CSV/IMAGE/VIDEO/OTHER`；VTK/VTU/VTI/VTP 建议以 `format=OTHER`（或 `JSON`）+ 扩展名触发 `previewType='contour'`（`apps/web/features/data-library/hooks/useAssetPreview.ts:50-74`）。  
   - 对齐 Node-Asset link 合约：优先复用现有 `POST /api/data-assets/links` 与 `DELETE /api/data-assets/links:destroy`（`apps/api/src/modules/data-management/data-asset.controller.ts:215-239`），并为 AC4 增加一个“返回 linkType 的查询”（例如新增 `GET /api/data-assets/links:detail?nodeId=...` 返回 `{ links: [{ asset, linkType, id }] }`，或调整现有 GET 返回值）。  
   - 修正前端集成落点：把“关联资产区域”集成到 `PropertyPanel` 体系（RightSidebar 当前只渲染 PropertyPanel）（`apps/web/components/layout/RightSidebar.tsx:85-96`），不要创建不存在的 `apps/web/features/workspace` 目录。  
   - 上传端点实现要遵循 Nest 冒号路由转义与基本限制：新增 `POST data-assets\\:upload`，要求 `graphId` + file，并设置 max file size（参考 `FileController`）（`apps/api/src/modules/file/file.controller.ts:23-76`）。
2. Should Improve:
   - 明确“节点选择器”复用点：指定使用的数据源（GraphContext/Yjs/后端 nodes API）、仅允许 `NodeType.TASK|NodeType.DATA`（`packages/database/prisma/schema.prisma:16-22`），并给出建议文件位置与最小 UI/性能约束（搜索/分页/去抖）。  
   - 将关键阻塞点前置到 Story 的 “Must Follow” 与 Tasks：包括合约（links endpoints）、枚举（DataAssetFormat/DataLinkType）、RightSidebar 集成点（PropertyPanel）。  
   - 调整测试断言：把“format=CONTOUR/MESH/DOCUMENT”改为符合 `DataAssetFormat`，并用预览弹窗可见性验证“云图预览”而非 format 值。
3. Consider:
   - 上传安全策略：基础的 MIME/扩展名 allowlist、可配置 MAX_FILE_SIZE、失败回滚（文件写入成功但 DB 创建失败时清理文件）。  
   - LLM token 优化：将测试骨架代码压缩为列表 + 关键断言示例，减少重复信息。  
