# Validation Report

**Document:** docs/sprint-artifacts/9-7-context-aware-data-asset-interaction.md  
**Checklist:** _bmad/bmm/workflows/4-implementation/create-story/checklist.md  
**Date:** 2026-01-12T13-06-46+0800  
**Agent Model:** GPT-5.2 (Codex CLI)

## Summary

This story is directionally correct and matches Epic 9.7 intent, but it has several **implementation-blocking mismatches** with the current codebase and UI kit. Without fixes, a dev agent is likely to:

- Implement in the wrong files (no effect in UI)
- Use non-existent `@cdm/ui` components
- Miss required cache invalidations (folder badge won’t update)
- Ship an incomplete/ambiguous upload/link flow (wrong nodeId/linkType)

## Must Fix (Blocking)

1. **Wrong file locations for “右侧面板” work**
   - The story instructs updating `PbsTreeView.tsx` / `TaskGroupView.tsx` “右侧面板”, but these components only render the **left org panel**.
   - The right side that shows assets is rendered in:
     - `apps/web/features/data-library/components/data-library-drawer/DataLibraryDrawerContent.tsx`
     - (upload controls are in) `apps/web/features/data-library/components/data-library-drawer/DataLibraryDrawerToolbar.tsx`

2. **Wrong / non-existent UI library components**
   - Story requires `DropdownMenu`, `Popover`, `ToggleGroup`, `Checkbox`, `Collapsible` from `@cdm/ui`.
   - Current `@cdm/ui` exports are limited to `Select`, `Button`, `Input`, `Badge`, `ConfirmDialogProvider`, `CollapseToggle`, etc.
   - Evidence: `packages/ui/src/index.ts`
   - Action: Rewrite UI spec + tasks to use `Select` / `CollapseToggle` (or implement local lightweight modal like `LinkAssetDialog.tsx` does).

3. **`useContextAwareUpload` / `uploadConfig` type mismatch**
   - Proposed `uploadConfig` shape (`{ mode, nodeId?, folderId?, defaultLinkType? }`) cannot be spread into `useDataUpload()` which currently expects `{ graphId, folderId, onSuccess, onError }`.
   - Action: Either:
     - Make `useContextAwareUpload` return *derived* `{ folderId, nodeId, defaultLinkType }` + a `mode`, and keep `useDataUpload` unchanged; or
     - Create a new orchestrator hook/component that performs upload + link in one place.

4. **Ambiguous `selectedNodeId` (risk of linking to wrong node)**
   - The story uses a single `selectedNodeId`, but the drawer state tracks **three independent selections**: `selectedPbsId`, `selectedTaskId`, `selectedFolderId`.
   - Without explicit mapping, dev may rely on “tab switch resets” and accidentally link using a stale nodeId.
   - Action: Make the story require passing `orgView + selectedPbsId + selectedTaskId + selectedFolderId` (no implicit clearing).

5. **Folder badge update is already implemented; missing piece is query invalidation**
   - Folder nodes already display `assetCount` badges (`FolderTreeItem.tsx`).
   - Upload currently invalidates only `['data-assets', graphId]` (`useDataUpload.ts`), not `['data-folders', graphId]`.
   - Action: Add folder-tree invalidation on upload success (preferably in `useDataUpload.ts`, not `FolderTreeView.tsx`).

6. **PBS “包含子节点” mode can’t support linkType grouping with current API**
   - PBS include-sub-nodes currently uses `POST /api/data-assets/links:byNodes` which returns **assets only** (no `linkType`).
   - Grouping by `linkType` requires `GET /api/data-assets/links:detail` (single node).
   - Action: Clarify scope (grouping only for single-node selection), or add a batch “detail by nodes” endpoint.

## Should Improve (Quality)

- **Epic alignment note:** Epic 9.7 describes PBS upload as a “类型选择对话框”; story uses a “Dropdown 预选”. This is likely acceptable, but explicitly state the UX equivalence to avoid “AC mismatch” disputes.
- **Testing naming:** `LinkTypeDialog.test.tsx` is referenced but no such component is defined in this story (it mentions `UploadTypeDropdown` / `QuickTypePicker` instead).
- **Missing create-story template sections:** Add the standard validation note and `Dev Agent Record` section for consistent handoff and tracking.

## Recommended Story Edits (What to change)

- Move “右侧面板分组显示” tasks to `DataLibraryDrawerContent.tsx` (rendering) + a dedicated grouped component.
- Replace `DropdownMenu/Popover/ToggleGroup` with `Select` + simple modal (pattern: `LinkAssetDialog.tsx`).
- Define a concrete upload/link orchestration flow (upload → create link → invalidate queries → refresh grouped panel).
- Add explicit cache invalidation requirements:
  - `['data-assets', graphId]`
  - `['data-folders', graphId]`
  - link detail query key used by grouped panel (e.g. `['node-asset-links', nodeId]` if reusing `useAssetLinks`)

