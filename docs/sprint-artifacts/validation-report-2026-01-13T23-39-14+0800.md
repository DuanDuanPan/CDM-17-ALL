# Validation Report

**Document:** docs/sprint-artifacts/9-9-toolbar-redesign.md  
**Checklist:** _bmad/bmm/workflows/4-implementation/create-story/checklist.md  
**Date:** 2026-01-13T23-39-14+0800  
**Agent Model:** GPT-5.2 (Codex CLI)

## Summary
- Overall: 34/80 passed (42.5%); Partial: 41; Fail: 1; N/A: 4
- Critical Issues: 1

## Section Results

### Critical Mistakes to Prevent
Pass Rate: 3/8 (37.5%)

⚠ PARTIAL — Reinventing wheels  
Evidence: AC6/Task 5 asks to (re-)add batch unlink + Undo Toast (`docs/sprint-artifacts/9-9-toolbar-redesign.md:72-78,337-340`) but the repo already has a batch unlink + undo flow via `useNodeAssetUnlink` (Sonner action) and wiring through the drawer (`apps/web/features/data-library/hooks/useNodeAssetUnlink.ts:133-163`; `apps/web/features/data-library/components/DataLibraryDrawer.tsx:276-300`).  
Impact: Dev may redo working functionality (risking regressions) instead of focusing on the actual toolbar/filter redesign.

⚠ PARTIAL — Wrong libraries  
Evidence: Story marks manual debounce as “禁止” and recommends `@mantine/hooks` / `lodash-es` (`docs/sprint-artifacts/9-9-toolbar-redesign.md:438-450`) but `apps/web` uses Vitest and already has `use-debounce` installed (and existing manual debounce) (`apps/web/package.json:10,45`; `apps/web/features/data-library/components/DataLibraryDrawer.tsx:156-160`). Story also shows `jest.mock(...)` in web testing examples (`docs/sprint-artifacts/9-9-toolbar-redesign.md:550-556`).  
Impact: Dev may reach for non-existent deps / wrong test APIs, creating churn or broken builds/tests.

✓ PASS — Wrong file locations  
Evidence: Story lists concrete file touchpoints and uses correct repo paths under `apps/web/features/data-library/...` (`docs/sprint-artifacts/9-9-toolbar-redesign.md:567-581,664-681`).

⚠ PARTIAL — Breaking regressions  
Evidence: Current implementation already has a “dual search” state (`searchMode`) that controls whether we fetch global assets (`useDataAssets`) vs node-linked grouped assets (`useAssetLinks`) (`apps/web/features/data-library/components/DataLibraryDrawer.tsx:74-180`; `apps/web/features/data-library/components/data-library-drawer/DataLibraryDrawerContent.tsx:301-427`). The story mandates new independent node-search vs asset-search state (`docs/sprint-artifacts/9-9-toolbar-redesign.md:63-70,495-517`) but does not explicitly call out how to retire/replace the existing `DualSearch` + `searchMode` pathway.  
Impact: Dev can accidentally ship duplicated asset-search entry points or conflicting sources-of-truth for filtering.

✓ PASS — Ignoring UX  
Evidence: Extensive UX rationale + prototypes + visual specs are included (`docs/sprint-artifacts/9-9-toolbar-redesign.md:82-304,592-620`).

⚠ PARTIAL — Vague implementations  
Evidence: AC3 requires an “未关联资产” scope (`docs/sprint-artifacts/9-9-toolbar-redesign.md:39-45`) and state design includes `searchScope: ... | 'unlinked'` (`docs/sprint-artifacts/9-9-toolbar-redesign.md:633-642`), but API contracts do not define how to query unlinked assets (`docs/sprint-artifacts/9-9-toolbar-redesign.md:560-566`) and current `GET /api/data-assets` has no such query param (`apps/api/src/modules/data-management/data-asset.controller.ts:81-114`; `packages/types/src/data-library-types.ts:171-183`).  
Impact: Dev may implement “unlinked” incorrectly (slow client-side scans, wrong semantics) or invent ad-hoc backend params.

⚠ PARTIAL — Lying about completion  
Evidence: Test examples use Jest APIs (`jest.mock`) and a Jest-like `--grep` flag (`docs/sprint-artifacts/9-9-toolbar-redesign.md:550-556,843-850`) while the web project test runner is Vitest (`apps/web/package.json:10`).  
Impact: Even if the feature is implemented, the provided “how to test” guidance can mislead and cause avoidable failures.

✓ PASS — Not learning from past work  
Evidence: Story explicitly frames itself as follow-up to Story 9.8, explains what went wrong, and links to prior story + tech spec + exact files to change (`docs/sprint-artifacts/9-9-toolbar-redesign.md:13-17,656-681`).

---

### Step 1: Load and Understand the Target
Pass Rate: 6/6 (100.0%)

✓ PASS — Load the workflow configuration  
Evidence: Workflow config exists (`_bmad/bmm/workflows/4-implementation/create-story/workflow.yaml:1-58`).

✓ PASS — Load the story file  
Evidence: Story file exists with title + status (`docs/sprint-artifacts/9-9-toolbar-redesign.md:1-3`).

✓ PASS — Load validation framework  
Evidence: Validation framework defined (`_bmad/core/tasks/validate-workflow.xml:1-89`).

✓ PASS — Extract metadata (epic/story key/title)  
Evidence: Title indicates Story 9.9 and filename matches story key (`docs/sprint-artifacts/9-9-toolbar-redesign.md:1`; `docs/sprint-artifacts/9-9-toolbar-redesign.md:305-350`).

✓ PASS — Resolve workflow variables  
Evidence: `output_folder=docs` and `sprint_artifacts=docs/sprint-artifacts`; story is under sprint artifacts (`_bmad/bmm/config.yaml:12-14`; `_bmad/bmm/workflows/4-implementation/create-story/workflow.yaml:21-33`).

✓ PASS — Understand current status  
Evidence: Status `ready-for-dev` (`docs/sprint-artifacts/9-9-toolbar-redesign.md:3`).

---

### Step 2.1: Epics and Stories Analysis
Pass Rate: 3/6 (50.0%)

✓ PASS — Load epics file  
Evidence: Epic 9 exists in epics file (`docs/epics.md:1055-1276`).

✓ PASS — Epic objectives and business value  
Evidence: Epic 9 objective defined (`docs/epics.md:1055-1058`).

✓ PASS — ALL stories in this epic (cross-story context)  
Evidence: Epic 9 includes Story 9.1–9.8 with data library scope and “双搜索入口/解绑语义” (`docs/epics.md:1059-1276`).

⚠ PARTIAL — Story requirements and acceptance criteria alignment  
Evidence: Story 9.9 is not present in `docs/epics.md` (Epic 9 ends at 9.8) (`docs/epics.md:1216-1276`), so alignment must be inferred from Story 9.1’s baseline search/filter requirement and Story 9.8’s dual-search behavior (`docs/epics.md:1074-1075,1263-1269`).  
Impact: Without an explicit epic-entry for 9.9, “scope boundaries” (what must remain unchanged vs redesigned) are easier to misinterpret.

⚠ PARTIAL — Technical requirements and constraints  
Evidence: Story includes concrete file pointers and state isolation design (`docs/sprint-artifacts/9-9-toolbar-redesign.md:495-517,664-681`) but contains incorrect tool/library guidance (Jest APIs, `@mantine/hooks`, `lodash-es`) (`docs/sprint-artifacts/9-9-toolbar-redesign.md:444-450,550-556`).  
Impact: Dev can follow the story and still choose incompatible dependencies/testing approaches.

⚠ PARTIAL — Cross-story dependencies and prerequisites  
Evidence: Story calls out compatibility impacts and references key touchpoints (`docs/sprint-artifacts/9-9-toolbar-redesign.md:621-681`) but does not explicitly name the existing `DualSearch` component / `searchMode` state that will need a migration plan when moving asset search into a new filter bar (`apps/web/features/data-library/components/node-tree/DualSearch.tsx:1-40`; `apps/web/features/data-library/components/DataLibraryDrawer.tsx:74-166`).  
Impact: Incomplete refactor can leave duplicated UI/logic paths (hard-to-debug state).

---

### Step 2.2: Architecture Deep-Dive
Pass Rate: 3/10 (30.0%)

✓ PASS — Load architecture file  
Evidence: Architecture doc exists and describes Epic 9 module, APIs, and data model concepts (`docs/architecture.md:714-858`).

⚠ PARTIAL — Technical stack with versions  
Evidence: Story links to `project-context.md` and `architecture.md` but does not summarize the key constraints (Next 16 / React 19 / Vitest in web) and instead shows mismatched tooling (Jest snippets, `@mantine/hooks`) (`docs/sprint-artifacts/9-9-toolbar-redesign.md:675-676,444-450,550-556`; `docs/project-context.md:21-43`).  
Impact: Dev may drift from existing stack conventions or install unnecessary deps.

✓ PASS — Code structure and organization patterns  
Evidence: Story’s proposed paths align with current feature-sliced structure (`apps/web/features/data-library/...`) and includes a “关键改动落点” table (`docs/sprint-artifacts/9-9-toolbar-redesign.md:567-581`).

⚠ PARTIAL — API design patterns and contracts  
Evidence: Story correctly identifies existing APIs (`GET /api/data-assets`, `links:detailByNodes`, `links:destroyByNodes`) (`docs/sprint-artifacts/9-9-toolbar-redesign.md:560-565`), but scope selector introduces “未关联资产” without a defined contract; current API does not support it (`docs/sprint-artifacts/9-9-toolbar-redesign.md:39-45,633-642`; `apps/api/src/modules/data-management/data-asset.controller.ts:81-114`).  
Impact: High risk of ad-hoc backend params or slow client-side workarounds.

➖ N/A — Database schemas and relationships  
Evidence: Story calls for UI/state refactor only; no schema change requested (`docs/sprint-artifacts/9-9-toolbar-redesign.md:359-364`).

✓ PASS — Security requirements and patterns  
Evidence: Explicitly calls out escaping special characters for search (`escapeRegex`) and references Story 9.8 approach (`docs/sprint-artifacts/9-9-toolbar-redesign.md:469`; `apps/web/features/data-library/components/node-tree/DualSearch.tsx:45-52`).

⚠ PARTIAL — Performance requirements and optimization strategies  
Evidence: Provides performance rules (debounce, lazy-load heavy picker, P95 targets) (`docs/sprint-artifacts/9-9-toolbar-redesign.md:475-493`), but does not reconcile with existing pagination/data-fetching realities or define how “unlinked” will be retrieved efficiently.  
Impact: Implementation may over-fetch and become slow on large graphs.

⚠ PARTIAL — Testing standards and frameworks  
Evidence: Test matrix and file structure are detailed (`docs/sprint-artifacts/9-9-toolbar-redesign.md:682-708`), but testing guidance includes Jest APIs and Jest-like flags (`docs/sprint-artifacts/9-9-toolbar-redesign.md:550-556,843-850`) while web uses Vitest (`apps/web/package.json:10`; `docs/project-context.md:39-43`).  
Impact: Test guidance is not reliably executable as written.

➖ N/A — Deployment and environment patterns  
Evidence: No deployment or environment changes are in scope.

⚠ PARTIAL — Integration patterns and external services  
Evidence: Story points to `useDataAssets` and drawer components (`docs/sprint-artifacts/9-9-toolbar-redesign.md:677-681`) but does not describe how the new filter bar integrates with the existing React Query query keys and the current `searchMode` gating logic (`apps/web/features/data-library/hooks/useDataAssets.ts:1-96`; `apps/web/features/data-library/components/DataLibraryDrawer.tsx:162-180`).  
Impact: Refactor can create caching inconsistencies or stale results.

---

### Step 2.3: Previous Story Intelligence
Pass Rate: 5/7 (71.4%)

✓ PASS — Load previous story file  
Evidence: Explicit links to Story 9.8 and its tech spec are provided (`docs/sprint-artifacts/9-9-toolbar-redesign.md:672-674`).

✓ PASS — Dev notes and learnings  
Evidence: Story includes “与 Story 9.8 的关系” and a compatibility table that explains what 9.9 is fixing (`docs/sprint-artifacts/9-9-toolbar-redesign.md:621-663`).

✓ PASS — Review feedback and corrections needed  
Evidence: Strong “Engineering Guardrails”, anti-pattern table, and edge-case list reduce ambiguity (`docs/sprint-artifacts/9-9-toolbar-redesign.md:367-384,464-474`).

✓ PASS — Files created/modified and their patterns  
Evidence: Provides both a structural tree and a “关键改动落点” table for files (`docs/sprint-artifacts/9-9-toolbar-redesign.md:241-259,567-581`).

⚠ PARTIAL — Testing approaches that worked/didn’t  
Evidence: New unit/integration/E2E plan exists (`docs/sprint-artifacts/9-9-toolbar-redesign.md:682-866`) but it does not explicitly call out that existing tests currently assert toolbar search/date inputs and will need updating (`apps/web/features/data-library/__tests__/DataLibraryDrawer.test.tsx:156-203`; `apps/web/e2e/data-library.spec.ts:126-163`).  
Impact: Dev may add new tests but still break existing CI coverage.

✓ PASS — Problems encountered and solutions found  
Evidence: Edge cases include special character handling, node-not-selected behavior, folder-view scope behavior (`docs/sprint-artifacts/9-9-toolbar-redesign.md:464-473`).

⚠ PARTIAL — Code patterns and conventions established  
Evidence: Story pushes hook-first and `@cdm/types` reuse (`docs/sprint-artifacts/9-9-toolbar-redesign.md:402-421,495-517`) but includes incorrect “禁止/正确” guidance for debounce and test mocking (`docs/sprint-artifacts/9-9-toolbar-redesign.md:438-450,550-556`).  
Impact: Even with good structure, dev may adopt the wrong implementation primitives.

---

### Step 2.4: Git History Analysis
Pass Rate: 0/5 (0.0%)

⚠ PARTIAL — Files created/modified in previous work  
Evidence: Story links to files but does not reference recent commits/PRs or “what changed recently” (`docs/sprint-artifacts/9-9-toolbar-redesign.md:670-681`).  
Impact: Dev may miss subtle recent refactors around Data Library search/filter logic.

⚠ PARTIAL — Code patterns and conventions used  
Evidence: No git history citations for conventions (e.g., how prior refactors structured hooks/components).  
Impact: Implementation may drift from the most current patterns.

⚠ PARTIAL — Library dependencies added/changed  
Evidence: No commit references or dependency-change notes (and story suggests non-present deps) (`docs/sprint-artifacts/9-9-toolbar-redesign.md:444-450`).  
Impact: Confusion over what is already available vs what needs adding.

⚠ PARTIAL — Architecture decisions implemented  
Evidence: No “recent architectural decision” citations (e.g., how dual-search and fetch gating were implemented).  
Impact: Harder to correctly refactor without breaking behavior.

⚠ PARTIAL — Testing approaches used  
Evidence: No reference to existing test patterns/updates in git history for Data Library changes.  
Impact: Increased chance of incomplete or misaligned test updates.

---

### Step 2.5: Latest Technical Research
Pass Rate: 0/4 (0.0%)

⚠ PARTIAL — Identify libraries/frameworks mentioned  
Evidence: Story links to `project-context.md` but does not pull forward key framework constraints; includes mismatched libs (`docs/sprint-artifacts/9-9-toolbar-redesign.md:675-676,444-450`; `docs/project-context.md:21-43`).  
Impact: Missing pointers can lead to wrong dependency choices.

⚠ PARTIAL — Breaking changes or security updates  
Evidence: No version/release-note references beyond linking docs; no note on Next/React major-version implications.  
Impact: Compatibility surprises when adding UI primitives.

⚠ PARTIAL — Performance improvements or deprecations  
Evidence: No research pointer for server-side filtering vs client-side filtering tradeoffs for “unlinked” scope.  
Impact: Risk of slow filtering or excessive requests.

⚠ PARTIAL — Best practices for current versions  
Evidence: Does not reference existing React Query query-key conventions or how the drawer currently gates global fetches via `searchMode` (`apps/web/features/data-library/components/DataLibraryDrawer.tsx:162-180`).  
Impact: Inconsistent caching or stale UI after refactor.

---

### Step 3.1: Reinvention Prevention Gaps
Pass Rate: 0/3 (0.0%)

⚠ PARTIAL — Wheel reinvention  
Evidence: Story proposes a new `useAssetFilterState` plus new filter bar, but does not state how to remove the existing toolbar-level search/filter state and the existing left-panel asset-search mode (`docs/sprint-artifacts/9-9-toolbar-redesign.md:324-336,633-654`; `apps/web/features/data-library/components/DataLibraryDrawer.tsx:74-80`; `apps/web/features/data-library/components/node-tree/DualSearch.tsx:22-40`).  
Impact: Parallel state paths can persist and cause inconsistent behavior.

⚠ PARTIAL — Code reuse opportunities not identified  
Evidence: Story does not reference the existing `filterAssets` helper already used for search/format/date filtering (`apps/web/features/data-library/components/data-library-drawer/filterAssets.ts:24-47`).  
Impact: Dev may duplicate filtering logic or introduce inconsistent date parsing.

⚠ PARTIAL — Existing solutions not mentioned  
Evidence: Story references `GroupedAssetList` but does not specify how the new filters apply to grouped link results vs flat results, and does not mention `useAssetLinks` (single-node links query) which drives the grouped view (`docs/sprint-artifacts/9-9-toolbar-redesign.md:363-364,414-421`; `apps/web/features/data-library/hooks/useAssetLinks.ts:1-72`; `apps/web/features/data-library/components/data-library-drawer/DataLibraryDrawerContent.tsx:316-427`).  
Impact: Filtering may only work in some modes (global assets) but not in grouped node view.

---

### Step 3.2: Technical Specification DISASTERS
Pass Rate: 1/5 (20.0%)

✗ FAIL — Wrong libraries/frameworks  
Evidence: Web-side examples use Jest APIs (`jest.mock`) (`docs/sprint-artifacts/9-9-toolbar-redesign.md:550-556`) but the web test runner is Vitest (`apps/web/package.json:10`; `docs/project-context.md:39-40`). Debounce guidance recommends `@mantine/hooks` / `lodash-es` (`docs/sprint-artifacts/9-9-toolbar-redesign.md:444-450`) but those are not in `apps/web` deps (while `use-debounce` is) (`apps/web/package.json:15-47`). The story also references `DateRangePicker` export from `@cdm/ui` in an example, which is not exported (`docs/sprint-artifacts/9-9-toolbar-redesign.md:489-492`; `packages/ui/src/index.ts:1-38`).  
Impact: Following the story “as written” can lead to missing-module errors, wrong mocking APIs, and wasted time.

⚠ PARTIAL — API contract violations  
Evidence: Scope selector introduces “未关联资产” but API contracts don’t define an endpoint/param, and the current list endpoint does not support link-status filtering (`docs/sprint-artifacts/9-9-toolbar-redesign.md:39-45,560-566`; `apps/api/src/modules/data-management/data-asset.controller.ts:81-114`).  
Impact: Dev may invent an inconsistent contract or implement a slow client-side workaround.

➖ N/A — Database schema conflicts  
Evidence: No schema changes are requested; story is UI/state-only (`docs/sprint-artifacts/9-9-toolbar-redesign.md:359-364`).

✓ PASS — Security vulnerabilities  
Evidence: Explicitly requires regex escaping for search (`escapeRegex`) (`docs/sprint-artifacts/9-9-toolbar-redesign.md:469`; `apps/web/features/data-library/components/node-tree/DualSearch.tsx:45-52`).

⚠ PARTIAL — Performance disasters  
Evidence: “Unlinked assets” likely requires counting links (or filtering by `_count.nodeLinks===0`) and can be expensive if implemented naïvely; story doesn’t specify server-side strategy (`docs/sprint-artifacts/9-9-toolbar-redesign.md:39-45,560-566`).  
Impact: The “unlinked” scope can degrade into fetching many assets then filtering client-side.

---

### Step 3.3: File Structure DISASTERS
Pass Rate: 2/4 (50.0%)

✓ PASS — Wrong file locations  
Evidence: Story points to correct refactor targets (`DataLibraryDrawerToolbar.tsx`, `DataLibraryDrawerContent.tsx`) and lists exact paths (`docs/sprint-artifacts/9-9-toolbar-redesign.md:567-581,677-678`).

✓ PASS — Coding standard violations  
Evidence: Enforces TypeScript-first, hook-first, and shared types from `@cdm/types` (`docs/sprint-artifacts/9-9-toolbar-redesign.md:388-399,402-421`).

⚠ PARTIAL — Integration pattern breaks  
Evidence: Story mandates separating node search and asset search (`docs/sprint-artifacts/9-9-toolbar-redesign.md:63-70,495-517`) but does not explicitly specify how to remove/modify existing left-panel “asset search” mode (DualSearch + `searchMode`) to avoid duplicate entry points (`apps/web/features/data-library/components/node-tree/DualSearch.tsx:22-40`; `apps/web/features/data-library/components/data-library-drawer/DataLibraryDrawerContent.tsx:483-525`).  
Impact: Users may face two different asset-search UIs with inconsistent state.

➖ N/A — Deployment failures  
Evidence: No deployment changes are in scope.

---

### Step 3.4: Regression DISASTERS
Pass Rate: 2/4 (50.0%)

⚠ PARTIAL — Breaking changes  
Evidence: Moving filters out of `DataLibraryDrawerToolbar` affects state shape and fetch gating; story doesn’t explicitly map how current `searchQuery/formatFilter/createdAfter/createdBefore` and `searchMode` migrate to `useAssetFilterState` + scope selector (`docs/sprint-artifacts/9-9-toolbar-redesign.md:324-336,633-654`; `apps/web/features/data-library/components/DataLibraryDrawer.tsx:74-180`).  
Impact: Partial refactors can break global searching or grouped node view.

⚠ PARTIAL — Test failures  
Evidence: Existing unit/E2E tests expect toolbar search input placeholder “搜索” and date range inputs with aria-labels (`apps/web/features/data-library/__tests__/DataLibraryDrawer.test.tsx:156-203`; `apps/web/e2e/data-library.spec.ts:139-163`). Story does not call out updating these existing tests explicitly.  
Impact: CI will fail or coverage will be misleading unless existing tests are updated alongside new ones.

✓ PASS — UX violations  
Evidence: UX rules are explicit (heights, control counts, scope options, state reset behavior) (`docs/sprint-artifacts/9-9-toolbar-redesign.md:21-61`).

✓ PASS — Learning failures  
Evidence: Story explicitly documents prior confusion and makes “node vs asset search” separation a primary goal (`docs/sprint-artifacts/9-9-toolbar-redesign.md:13-17,660-663`).

---

### Step 3.5: Implementation DISASTERS
Pass Rate: 2/4 (50.0%)

⚠ PARTIAL — Vague implementations  
Evidence: Story says “筛选结果实时更新” and “选择全部资产时隐藏 linkType 分组” (`docs/sprint-artifacts/9-9-toolbar-redesign.md:33-46`) but does not define the concrete data flow across all modes (single-node grouped, multi-node union, folder view) and how filters are applied to grouped link results.  
Impact: Dev may implement filters only for global assets, leaving grouped node views unfiltered.

✓ PASS — Completion lies  
Evidence: Explicit tasks + AC mapping + test coverage matrix and file structure are present (`docs/sprint-artifacts/9-9-toolbar-redesign.md:305-350,682-708`).

✓ PASS — Scope creep  
Evidence: Scope is constrained to toolbar/filter refactor, search scope selector, and state behavior; no backend changes are mandated beyond “MAY NEED” notes (`docs/sprint-artifacts/9-9-toolbar-redesign.md:21-79,560-566`).  
Impact: Work remains bounded if “unlinked” scope contract is clarified.

⚠ PARTIAL — Quality failures  
Evidence: Some “hard guardrail” examples conflict with repo reality (debounce and test mocking) (`docs/sprint-artifacts/9-9-toolbar-redesign.md:438-450,550-556`).  
Impact: Even a careful dev can be nudged into incorrect patterns by the story itself.

---

### Step 4: LLM-Dev-Agent Optimization Analysis
Pass Rate: 1/5 (20.0%)

⚠ PARTIAL — Verbosity problems  
Evidence: Story includes extensive prototype descriptions, style tables, and large test matrices (866 lines) (`docs/sprint-artifacts/9-9-toolbar-redesign.md:82-304,540-866`).  
Impact: In token-limited contexts, critical integration constraints may be missed.

⚠ PARTIAL — Ambiguity issues  
Evidence: “未关联资产” scope lacks defined backend contract; filter behavior for grouped node views is underspecified (`docs/sprint-artifacts/9-9-toolbar-redesign.md:39-45,560-566`).  
Impact: Multiple plausible implementations → inconsistent UX/perf.

⚠ PARTIAL — Context overload  
Evidence: Implementation instructions and UX specs are mixed with large visual-prototype detail (`docs/sprint-artifacts/9-9-toolbar-redesign.md:82-304,592-720`).  
Impact: Harder to find “must change these files / states” quickly.

⚠ PARTIAL — Missing critical signals  
Evidence: Story does not explicitly name the existing `DualSearch`/`searchMode` path that currently routes asset search in the left panel (even though it links the files) (`docs/sprint-artifacts/9-9-toolbar-redesign.md:677-679`; `apps/web/features/data-library/components/node-tree/DualSearch.tsx:22-40`; `apps/web/features/data-library/components/DataLibraryDrawer.tsx:74-166`).  
Impact: Dev may not realize a migration/removal is needed, leaving duplicate behavior.

✓ PASS — Poor structure  
Evidence: Clear ACs, tasks, dev notes/guardrails, references, and test design sections exist (`docs/sprint-artifacts/9-9-toolbar-redesign.md:19-79,305-720,682-866`).

---

### Step 4: LLM Optimization Principles
Pass Rate: 2/5 (40.0%)

⚠ PARTIAL — Clarity over verbosity  
Evidence: Critical “must change” technical migrations (searchMode/DualSearch) are not stated as top-level “do this first” steps; much space is spent on UI spec details (`docs/sprint-artifacts/9-9-toolbar-redesign.md:82-304,305-350`).  
Impact: Dev may implement UI but miss core state migration.

✓ PASS — Actionable instructions  
Evidence: Task list is explicit and maps to ACs (`docs/sprint-artifacts/9-9-toolbar-redesign.md:305-350`).

✓ PASS — Scannable structure  
Evidence: Uses headings, tables, file lists, and a test matrix (`docs/sprint-artifacts/9-9-toolbar-redesign.md:241-259,567-590,682-708`).

⚠ PARTIAL — Token efficiency  
Evidence: Many long tables and prototype blocks are included; some can be pushed to the linked PRD and summarized here (`docs/sprint-artifacts/9-9-toolbar-redesign.md:82-304,592-620`).  
Impact: Increased chance of truncation/missed constraints in smaller contexts.

⚠ PARTIAL — Unambiguous language  
Evidence: “实时更新” and scope interactions need explicit mapping to existing fetch flows and grouped views; otherwise ambiguous (`docs/sprint-artifacts/9-9-toolbar-redesign.md:33-46`).  
Impact: Divergent implementations and inconsistent behavior.

---

### Step 5: Improvement Recommendations
Pass Rate: 4/4 (100.0%)

✓ PASS — Critical Misses (Must Fix)  
Evidence: Addressed in “Recommendations” section below (per checklist `_bmad/bmm/workflows/4-implementation/create-story/checklist.md:193-199`).

✓ PASS — Enhancement Opportunities (Should Add)  
Evidence: Addressed in “Recommendations” section below (per checklist `_bmad/bmm/workflows/4-implementation/create-story/checklist.md:200-206`).

✓ PASS — Optimization Suggestions (Nice to Have)  
Evidence: Addressed in “Recommendations” section below (per checklist `_bmad/bmm/workflows/4-implementation/create-story/checklist.md:207-212`).

✓ PASS — LLM Optimization Improvements  
Evidence: Addressed in “Recommendations” section below (per checklist `_bmad/bmm/workflows/4-implementation/create-story/checklist.md:213-218`).

---

## Failed Items
- ✗ Wrong libraries/frameworks: Replace Jest/Vitest confusion and debounce guidance (`docs/sprint-artifacts/9-9-toolbar-redesign.md:438-450,550-556,843-850`).

## Partial Items
- Search migration clarity: explicitly retire/modify `DualSearch` + `searchMode` after introducing the new filter bar (`apps/web/features/data-library/components/node-tree/DualSearch.tsx:22-40`; `apps/web/features/data-library/components/DataLibraryDrawer.tsx:74-166`).
- “Unlinked assets” contract: define server-side filtering approach (query param or endpoint) (`apps/api/src/modules/data-management/data-asset.controller.ts:81-114`).
- Filtering across grouped views: define how filters apply to `useAssetLinks` / `GroupedAssetList` and multi-node union (`apps/web/features/data-library/components/data-library-drawer/DataLibraryDrawerContent.tsx:316-427`).
- Existing tests to update: `DataLibraryDrawer.test.tsx` and `data-library.spec.ts` currently assert toolbar search/date inputs (`apps/web/features/data-library/__tests__/DataLibraryDrawer.test.tsx:156-203`; `apps/web/e2e/data-library.spec.ts:139-163`).
- Performance strategy for “unlinked”: avoid “fetch-all then filter” approaches; specify pagination and caching.

## Recommendations
1. Must Fix:
   - Fix the “Wrong libraries” guidance:
     - Replace `jest.mock` examples with `vi.mock` (Vitest) and remove `--grep` references (use Vitest-supported filtering).
     - Replace `@mantine/hooks` / `lodash-es` guidance with primitives already present (`use-debounce`, or keep the current local debounce pattern).
     - Remove/replace the `DateRangePicker` example unless `@cdm/ui` actually exports one (`packages/ui/src/index.ts:1-38`).
   - Define the “unlinked assets” API contract (e.g., `GET /api/data-assets?linkStatus=unlinked` or `unlinkedOnly=true`) and confirm response shape; update `DataAssetQueryDto` accordingly (`packages/types/src/data-library-types.ts:171-183`).
   - Add an explicit “Search Migration Plan” section:
     - Specify what happens to the existing left-panel `DualSearch` asset mode and `searchMode` state once the new filter bar exists.
2. Should Improve:
   - Add an “Update existing tests” checklist: name the exact unit/E2E tests that must be updated for the new placeholders/layout.
   - Specify how filter state applies to each mode: single-node grouped view, multi-node union, folder view, and “all assets”.
3. Consider:
   - Reduce story token weight by moving most prototype/detail tables to the linked PRD and keeping this story focused on contracts + file touchpoints.
   - Consider keeping the existing native date inputs (currently in toolbar) as the initial DateRangeFilter implementation to avoid new UI deps.

