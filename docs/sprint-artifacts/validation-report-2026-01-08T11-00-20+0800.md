# Validation Report

**Document:** docs/sprint-artifacts/story-8-6-node-order-persistence.md  
**Checklist:** _bmad/bmm/workflows/4-implementation/create-story/checklist.md  
**Date:** 2026-01-08T11-00-20+0800  
**Agent Model:** GPT-5.2 (Codex CLI)

## Summary
- Overall: 26/80 passed (32.5%); Partial: 45; Fail: 3; N/A: 6
- Critical Issues: 2

## Section Results

### Critical Mistakes to Prevent
Pass Rate: 2/8 (25.0%)

⚠ PARTIAL — Reinventing wheels  
Evidence: Story notes `NodeData` already has `order?: number` (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:46-47`) but still plans to “add `order?: number` to MindNodeData” in `packages/types/src/node-types.ts` (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:189-193`). Also misses that layout already prioritizes `data.order` (`packages/plugins/plugin-layout/src/utils/sortNodes.ts:20-31,58-69`).  
Impact: Dev may waste time editing the wrong file or duplicating existing behavior, increasing regression risk.

✓ PASS — Wrong libraries  
Evidence: Uses repo-standard stack (Prisma, X6, Yjs) and correct primitives like `graph.batchUpdate()` (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:171-173,259-270`).

⚠ PARTIAL — Wrong file locations  
Evidence: Tasks point to `packages/types/src/node-types.ts` for `MindNodeData` (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:189-193`) but `MindNodeData` extends `NodeData` in `packages/types/src/index.ts` (`packages/types/src/index.ts:2-42`). Several impact-matrix paths are placeholders (`plugin-mindmap-core/...`, `plugin-template/...`) (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:33-38`).  
Impact: Developers may patch the wrong file or miss required touchpoints.

⚠ PARTIAL — Breaking regressions  
Evidence: Adds `order Int @default(0)` (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:165-166`) while also relying on “missing order ⇒ `Infinity`” fallbacks (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:169-170,252-257`). Backend “relational → Yjs init” currently omits `order` entirely (`apps/api/src/modules/collab/collab.service.ts:140-160`).  
Impact: Legacy/new graphs that load via relational fallback can lose ordering; default-0 may also distort “missing vs explicit” semantics.

✓ PASS — Ignoring UX  
Evidence: Clear user intent + ACs cover creation, navigation, outline drag reorder, template import, and reopen persistence (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:9-13,116-159,375-383`).

⚠ PARTIAL — Vague implementations  
Evidence: Template save task says “find subtree save logic” without a concrete file path (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:217-221`); Playwright plan is a skeleton without assertions or harness alignment (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:334-354`).  
Impact: Dev may stall or implement incorrectly; tests may be flaky or not validate ACs.

⚠ PARTIAL — Lying about completion  
Evidence: Story claims layout sorts children by Y and needs change (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:41-42`), but layout already prioritizes `data.order` (`packages/plugins/plugin-layout/src/utils/sortNodes.ts:20-31,58-69`). It also flags “MindNodeData missing order” in matrix (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:32-33`) while `NodeData.order` already exists (`packages/types/src/index.ts:2-10`).  
Impact: Misleading statements can drive unnecessary changes or wrong fixes.

⚠ PARTIAL — Not learning from past work  
Evidence: Story references Outline (8.4) as “already uses order” (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:36,49-58`) but does not incorporate critical system behavior: first-open may initialize Yjs from relational DB (`docs/project-context.md:222-225`; `apps/api/src/modules/collab/collab.service.ts:126-162`) where `order` is currently not persisted/mapped.  
Impact: “Order persistence” may still fail in common flows (template-created graphs, yjsState-missing graphs).

---

### Step 1: Load and Understand the Target
Pass Rate: 6/6 (100.0%)

✓ PASS — Load the workflow configuration  
Evidence: Workflow config exists (`_bmad/bmm/workflows/4-implementation/create-story/workflow.yaml:1-41`) and points to config (`_bmad/bmm/config.yaml:11-13`).

✓ PASS — Load the story file  
Evidence: Story exists and links tech spec + impact analysis (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:1-5`).

✓ PASS — Load validation framework  
Evidence: Validation framework defined (`_bmad/core/tasks/validate-workflow.xml:1-63`).

✓ PASS — Extract metadata (epic/story key/title)  
Evidence: Title indicates Story 8.6 “兄弟节点顺序持久化” (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:1`).

✓ PASS — Resolve workflow variables  
Evidence: `output_folder=docs` and `sprint_artifacts=docs/sprint-artifacts` are defined (`_bmad/bmm/config.yaml:11-13`); story resides under `docs/sprint-artifacts/` (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:1`).

✓ PASS — Understand current status  
Evidence: Status is `ready-for-dev` (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:3`).

---

### Step 2.1: Epics and Stories Analysis
Pass Rate: 2/6 (33.3%)

✓ PASS — Load epics file  
Evidence: Epics file exists (`docs/epics.md`).

✗ FAIL — Epic objectives and business value  
Evidence: Story numbering is inconsistent: `docs/epics.md` defines **Story 8.6** as “分组 Frame (Grouping Frame)” (`docs/epics.md:865-882`), but the target story file claims **Story 8.6** is “兄弟节点顺序持久化” (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:1`).  
Impact: Epic-level value/priority is unclear; development may target the wrong feature.

✗ FAIL — ALL stories in this epic (cross-story context)  
Evidence: Epic 8 story list contains 8.1–8.9 including 8.6=Grouping Frame (`docs/epics.md:765-899`), but “Node Order Persistence” is not present in Epic 8.  
Impact: Cross-story dependencies and sequencing cannot be trusted; sprint tracking may be incorrect.

✗ FAIL — Story requirements and acceptance criteria alignment  
Evidence: Epic 8.6 AC describes multi-select → “创建分组 Frame” (`docs/epics.md:873-882`), while this story’s ACs are about sibling ordering, templates, and navigation (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:118-159`).  
Impact: Stakeholders/PM expectations will diverge from what dev ships.

⚠ PARTIAL — Technical requirements and constraints  
Evidence: Story includes key decisions (Prisma `order`, compat fallback, batchUpdate) (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:163-176,246-274`) but misses core constraint from project context: first-open may initialize Yjs from relational DB (`docs/project-context.md:222-225`), requiring backend mapping for `order`.  
Impact: Implementation can “work locally” but fail in realistic lifecycle flows (template-created graphs, missing yjsState).

✓ PASS — Cross-story dependencies and prerequisites  
Evidence: Dependencies listed (Stories 5.1/5.2 template system, 8.4 outline reorder) (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:292-312`).

---

### Step 2.2: Architecture Deep-Dive
Pass Rate: 1/10 (10.0%)

✓ PASS — Load architecture file  
Evidence: Architecture exists and describes dual-store (relational + Yjs blob) (`docs/architecture.md:99-112`).

⚠ PARTIAL — Technical stack with versions  
Evidence: Story references X6/Yjs/Prisma but does not pin versions or cite project context (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:292-296`; `docs/project-context.md:16-43`).  
Impact: Dev may overlook version-specific API behavior or constraints.

⚠ PARTIAL — Code structure and organization patterns  
Evidence: Story has a file map (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:275-287`) but includes incorrect type file guidance (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:189-193`) and placeholder paths (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:33-38`).  
Impact: Misplaced edits can break shared types or miss required updates.

➖ N/A — API design patterns and contracts  
Evidence: No new HTTP endpoints described; changes are internal persistence + ordering.

⚠ PARTIAL — Database schemas and relationships  
Evidence: Adds `Node.order` (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:183-187`) but does not cover the backend sync/mapping path that currently persists only a subset of fields to Node table (`apps/api/src/modules/collab/collab.service.ts:322-350`; `apps/api/src/modules/graphs/graph.repository.ts:15-29,117-147`).  
Impact: The new column can remain unused; relational fallback load may still lose ordering.

➖ N/A — Security requirements and patterns  
Evidence: No auth/permission changes in scope.

⚠ PARTIAL — Performance requirements and optimization strategies  
Evidence: Mentions batchUpdate and a generic performance note (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:259-270,371-372`) but no complexity/limits guidance for large sibling sets.  
Impact: Reorder operations can become O(n) hot paths in large graphs.

⚠ PARTIAL — Testing standards and frameworks  
Evidence: Test plan exists (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:315-364`) but E2E is placeholder and lacks repo Playwright harness conventions. Unit test filenames are inconsistent with current layout (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:229-233`; `packages/plugins/plugin-mindmap-core/src/commands/commands.test.ts:1-230`).  
Impact: Dev may write failing/flaky tests or miss critical verification.

➖ N/A — Deployment and environment patterns  
Evidence: No deployment changes described.

⚠ PARTIAL — Integration patterns and external services  
Evidence: Notes Yjs sync “no extra handling” (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:272-274`) but ignores the backend’s relational init and node-table sync boundaries (`apps/api/src/modules/collab/collab.service.ts:126-162,322-350`).  
Impact: Cross-client and first-open ordering can diverge from the story’s intent.

---

### Step 2.3: Previous Story Intelligence
Pass Rate: 2/7 (28.6%)

✓ PASS — Load previous story file  
Evidence: Story 8.5 exists (`docs/sprint-artifacts/story-8-5-focus-mode.md:1-5`). Also relevant precedent: Story 8.4 Outline View implements order normalization (`apps/web/components/graph/hooks/useOutlineData.ts:239-278`).

⚠ PARTIAL — Dev notes and learnings  
Evidence: Story includes guardrails (fallback, batchUpdate) and references Outline sorting (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:246-274,299-304`) but does not explicitly reuse the proven `normalizeOrder` approach from Outline reorder (`apps/web/components/graph/hooks/useOutlineData.ts:239-278`).  
Impact: Multiple ordering algorithms can diverge, causing subtle bugs.

⚠ PARTIAL — Review feedback and corrections needed  
Evidence: No explicit “pitfalls / prior review feedback” section (contrast Story 8.4 includes explicit AI-review notes) (`docs/sprint-artifacts/story-8-4-outline-view.md:295-299`).  
Impact: Known sharp edges may be rediscovered during implementation.

⚠ PARTIAL — Files created/modified and their patterns  
Evidence: File map exists but misses key backend integration points (CollabService / GraphRepository) (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:275-287`; `apps/api/src/modules/collab/collab.service.ts:126-162,322-350`).  
Impact: Implementation may not achieve end-to-end persistence.

⚠ PARTIAL — Testing approaches that worked/didn’t  
Evidence: No reference to existing Playwright helpers, and E2E is only a skeleton (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:334-354`).  
Impact: Tests may not reflect real user flows and can be flaky.

⚠ PARTIAL — Problems encountered and solutions found  
Evidence: Story lists symptoms (Y-based ordering, template order loss) (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:17-24`) but misses that layout already supports order, and that backend relational init drops order (`packages/plugins/plugin-layout/src/utils/sortNodes.ts:20-31`; `apps/api/src/modules/collab/collab.service.ts:140-160`).  
Impact: Root causes may be misdiagnosed; fixes may not stick.

✓ PASS — Code patterns and conventions established  
Evidence: Uses established patterns: `order ?? Infinity` fallback and `graph.batchUpdate()` (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:252-270`), aligned with Outline hook (`apps/web/components/graph/hooks/useOutlineData.ts:86-92,246-278`).

---

### Step 2.4: Git History Analysis
Pass Rate: 0/5 (0.0%)

⚠ PARTIAL — Files created/modified in previous work  
Evidence: Story includes no git commit references; only file pointers (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:275-304`).  
Impact: May miss recent refactors that affect touchpoints.

⚠ PARTIAL — Code patterns and conventions used  
Evidence: No `git log`/`git blame` evidence in story.  
Impact: Risk of diverging from newest conventions.

⚠ PARTIAL — Library dependencies added/changed  
Evidence: No dependency history or rationale; only implicit usage (Prisma/X6/Yjs) (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:292-296`).  
Impact: Missed compatibility context.

⚠ PARTIAL — Architecture decisions implemented  
Evidence: Dual-store constraint not connected to acceptance criteria in story (`docs/architecture.md:99-112`; `docs/sprint-artifacts/story-8-6-node-order-persistence.md:155-159`).  
Impact: Implementation may not respect “Yjs-first” persistence boundaries.

⚠ PARTIAL — Testing approaches used  
Evidence: No git-based evidence of current Playwright/Vitest patterns.  
Impact: Test plan may miss repo conventions and helpers.

---

### Step 2.5: Latest Technical Research
Pass Rate: 1/4 (25.0%)

✓ PASS — Identify libraries/frameworks mentioned  
Evidence: Prisma, X6, Yjs explicitly referenced (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:171-173,292-296`).

⚠ PARTIAL — Breaking changes or security updates  
Evidence: No changelog/release note references for Prisma/X6/Yjs.  
Impact: Potential hidden breaking changes unaccounted for.

⚠ PARTIAL — Performance improvements or deprecations  
Evidence: No research into ordering strategies at scale; only a generic note (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:371-372`).  
Impact: Could ship an O(n) reorder hot path without guardrails.

⚠ PARTIAL — Best practices for current versions  
Evidence: No pointers to official patterns (e.g., CRDT+relational sync boundaries) beyond internal guardrails.  
Impact: Implementation may be ad-hoc and inconsistent across modules.

---

### Step 3.1: Reinvention Prevention Gaps
Pass Rate: 0/3 (0.0%)

⚠ PARTIAL — Wheel reinvention  
Evidence: Story proposes changing type definitions already containing `order` (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:46-47,189-193`; `packages/types/src/index.ts:2-10`).  
Impact: Unnecessary work and potential type regressions.

⚠ PARTIAL — Code reuse opportunities not identified  
Evidence: Outline reorder already normalizes `order` atomically (`apps/web/components/graph/hooks/useOutlineData.ts:246-278`), but story doesn’t mandate reuse of that helper/pattern for AddSibling insertion.  
Impact: Multiple subtly different reorder implementations increase bug surface.

⚠ PARTIAL — Existing solutions not mentioned  
Evidence: Layout already prioritizes `data.order` (`packages/plugins/plugin-layout/src/utils/sortNodes.ts:20-31`), but story claims layout sorts by Y and needs change (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:41-42`).  
Impact: Dev may “fix” something that’s already solved, or miss the real missing links (creation + persistence).

---

### Step 3.2: Technical Specification DISASTERS
Pass Rate: 0/5 (0.0%)

⚠ PARTIAL — Wrong libraries/frameworks  
Evidence: Type/file pointers are inconsistent (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:46-47,189-193`).  
Impact: Dev may implement in the wrong layer (types vs runtime vs persistence).

➖ N/A — API contract violations  
Evidence: No API contract changes described.

⚠ PARTIAL — Database schema conflicts  
Evidence: Adds `Node.order` without specifying how CollabService should read/write it in relational sync (`apps/api/src/modules/collab/collab.service.ts:126-162,322-350`). Uses `@default(0)` while also treating missing order as `Infinity` (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:165-170`).  
Impact: Can cause “all siblings order=0” collisions and make fallback semantics inconsistent unless fully normalized.

➖ N/A — Security vulnerabilities  
Evidence: No security changes in scope.

⚠ PARTIAL — Performance disasters  
Evidence: Sibling insertion requires shifting all subsequent siblings (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:171-173,202-206`) with no threshold/renormalization strategy.  
Impact: Large sibling sets can cause noticeable UI jank if implemented naïvely.

---

### Step 3.3: File Structure DISASTERS
Pass Rate: 1/4 (25.0%)

⚠ PARTIAL — Wrong file locations  
Evidence: Story directs changes to `packages/types/src/node-types.ts` for `MindNodeData` (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:189-193`), but the actual `NodeData/MindNodeData` live in `packages/types/src/index.ts` (`packages/types/src/index.ts:2-42`).  
Impact: Wrong edits can break shared types or be no-ops.

✓ PASS — Coding standard violations  
Evidence: No instruction that violates repo TS patterns; suggests `batchUpdate` + safe fallbacks (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:246-270`).

⚠ PARTIAL — Integration pattern breaks  
Evidence: Project requires “Yjs-first” and supports relational init when Yjs empty (`docs/project-context.md:75-78,222-225`), but story omits required backend integration touchpoints to preserve order in that path (`apps/api/src/modules/collab/collab.service.ts:126-162`).  
Impact: Order persistence can break on first open or in server-created graphs.

➖ N/A — Deployment failures  
Evidence: No deployment changes in scope.

---

### Step 3.4: Regression DISASTERS
Pass Rate: 1/4 (25.0%)

⚠ PARTIAL — Breaking changes  
Evidence: Introducing `order` column with default 0 and changing navigation ordering affects selection flows and could reorder existing graphs (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:165-173,131-135`).  
Impact: Users may see different navigation/ordering after upgrade if legacy graphs aren’t normalized/reset.

⚠ PARTIAL — Test failures  
Evidence: Story’s unit-test task list names files that don’t exist (`AddChildCommand.test.ts`, `AddSiblingCommand.test.ts`) (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:229-233`), while current tests live in `commands.test.ts` (`packages/plugins/plugin-mindmap-core/src/commands/commands.test.ts:1-230`).  
Impact: Dev could add redundant tests or miss updating the real suite; CI failures likely.

✓ PASS — UX violations  
Evidence: UX behavior is explicit and constrained (order changes are invisible but must reflect in outline/navigation) (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:118-159,377-383`).

⚠ PARTIAL — Learning failures  
Evidence: Story doesn’t address known system behavior: relational init is a real path and currently discards `order` (`apps/api/src/modules/collab/collab.service.ts:126-162`; `docs/project-context.md:222-225`).  
Impact: Regression/bug may reappear in “fresh graph” and “template import” scenarios.

---

### Step 3.5: Implementation DISASTERS
Pass Rate: 1/4 (25.0%)

⚠ PARTIAL — Vague implementations  
Evidence: AddSibling insertion assumes `selectedNode.order` exists (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:171-173,204-206`) but does not specify how to handle missing/duplicate orders or gaps consistently across modules.  
Impact: Implementation may be inconsistent between commands, outline reorder, and templates.

⚠ PARTIAL — Completion lies  
Evidence: Story declares some components “已完成/已就绪” (Outline) and flags others as incomplete; however it misstates layout behavior and type gaps (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:36,41-42,46-47`).  
Impact: Dev may trust incorrect assumptions and skip necessary verification.

✓ PASS — Scope creep  
Evidence: Out-of-scope boundaries are explicit (canvas drag reorder, bulk UI, cross-parent move) (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:109-113`).

⚠ PARTIAL — Quality failures  
Evidence: Persistence AC7 is stated (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:155-159`) but no concrete end-to-end test plan exists for “relational init” or “first open with empty yjsState”.  
Impact: Feature can “seem to work” while failing in real lifecycle paths.

---

### Step 4: LLM-Dev-Agent Optimization Analysis
Pass Rate: 3/5 (60.0%)

✓ PASS — Verbosity problems  
Evidence: Story is concise (~400 lines) with focused code snippets (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:46-93,246-270`).

⚠ PARTIAL — Ambiguity issues  
Evidence: Contradiction: “types already include order” vs task to add it to a different file (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:46-47,189-193`). Scope mismatch vs tech spec around template-save AC (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:136-140`; `docs/sprint-artifacts/tech-spec-8-6-node-order-persistence.md:26-36,252-262`).  
Impact: Dev agent may implement the wrong changes or miss required ACs.

✓ PASS — Context overload  
Evidence: Context is structured and scoped; includes guardrails and file map (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:246-296`).

⚠ PARTIAL — Missing critical signals  
Evidence: Missing explicit mention of backend relational init and node-table sync requirements for order (`apps/api/src/modules/collab/collab.service.ts:126-162,322-350`; story file list omits apps/api entirely: `docs/sprint-artifacts/story-8-6-node-order-persistence.md:275-287`).  
Impact: Dev can finish all listed tasks and still not satisfy persistence in key flows.

✓ PASS — Poor structure  
Evidence: Clear headings, phased tasks, and ACs (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:97-242`).

---

### Step 4: LLM Optimization Principles
Pass Rate: 2/5 (40.0%)

⚠ PARTIAL — Clarity over verbosity  
Evidence: Contains contradictory statements about type work and layout behavior (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:41-42,46-47,189-193`).  
Impact: Dev agent may waste tokens resolving conflicts.

⚠ PARTIAL — Actionable instructions  
Evidence: Some tasks are actionable, but key ones lack precise touchpoints (template save path, backend persistence path) (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:217-221,275-287`).  
Impact: Increased churn and back-and-forth.

✓ PASS — Scannable structure  
Evidence: Uses ACs, phases, file table, guardrails (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:116-176,179-304`).

✓ PASS — Token efficiency  
Evidence: Uses short code blocks and references rather than huge embedded files (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:49-93,334-364`).

⚠ PARTIAL — Unambiguous language  
Evidence: “order 持久化/从数据库恢复” is underspecified vs dual-store reality (Graph.yjsState vs Node table vs relational init) (`docs/architecture.md:99-112`; `docs/sprint-artifacts/story-8-6-node-order-persistence.md:155-159`).  
Impact: Different devs can implement different “persistence” definitions.

---

### Step 5: Improvement Recommendations
Pass Rate: 4/4 (100.0%)

✓ PASS — Critical Misses (Must Fix)  
Evidence: Addressed in “Recommendations” section below (per checklist `_bmad/bmm/workflows/4-implementation/create-story/checklist.md:193-199`).

✓ PASS — Enhancement Opportunities (Should Add)  
Evidence: Addressed in “Recommendations” section below (per checklist `_bmad/bmm/workflows/4-implementation/create-story/checklist.md:200-206`).

✓ PASS — Optimization Suggestions (Nice to Have)  
Evidence: Addressed in “Recommendations” section below (per checklist `_bmad/bmm/workflows/4-implementation/create-story/checklist.md:207-212`).

✓ PASS — LLM Optimization Improvements  
Evidence: Addressed in “Recommendations” section below (per checklist `_bmad/bmm/workflows/4-implementation/create-story/checklist.md:213-218`).

---

## Failed Items
- ✗ Epic/story mismatch: Epic 8.6 is “分组 Frame”, but story file claims “兄弟节点顺序持久化” (`docs/epics.md:865-882`; `docs/sprint-artifacts/story-8-6-node-order-persistence.md:1`).
- ✗ Cross-story context cannot be trusted: “Node Order Persistence” not present in Epic 8 story list (`docs/epics.md:765-899`).
- ✗ Acceptance criteria do not align with Epic 8.6: Frame grouping AC vs order persistence ACs (`docs/epics.md:873-882`; `docs/sprint-artifacts/story-8-6-node-order-persistence.md:118-159`).

## Partial Items
- Type/task contradiction: says `NodeData` already has order but still asks to add it to `node-types.ts` (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:46-47,189-193`; `packages/types/src/index.ts:2-10`).
- Layout misinformation: claims layout sorts by Y and needs change, but order is already prioritized in layout sorting (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:41-42`; `packages/plugins/plugin-layout/src/utils/sortNodes.ts:20-31`).
- Persistence definition gap: “DB restore” not reconciled with dual-store + relational init path; backend mapping/sync omits order (`docs/architecture.md:99-112`; `apps/api/src/modules/collab/collab.service.ts:126-162,322-350`; `apps/api/src/modules/graphs/graph.repository.ts:15-29,117-147`).
- Template save touchpoint not specified: subtree extraction likely loses order today due to unsorted child selection and missing `order` on TemplateNode (`apps/web/lib/subtree-extractor.ts:110-156,121-128`; `packages/types/src/template-types.ts:24-32`).
- Testing plan is incomplete: E2E skeleton lacks assertions and harness conventions; unit test file list mismatches repo layout (`docs/sprint-artifacts/story-8-6-node-order-persistence.md:229-233,334-354`; `packages/plugins/plugin-mindmap-core/src/commands/commands.test.ts:1-230`).

## Recommendations
1. Must Fix:
   - **Fix story numbering/epic alignment**: either (a) update `docs/epics.md` so Story 8.6 matches “Node Order Persistence”, or (b) rename this story/key to the correct epic/story slot and update links (tech spec + impact analysis).
   - **Clarify persistence source of truth**: decide whether “database restore” means (a) Graph `yjsState` only, or (b) Node table `order` column + full backend round-trip. If (b), explicitly add tasks to update CollabService relational init and Yjs→Node sync to include `order` (`apps/api/src/modules/collab/collab.service.ts`, `apps/api/src/modules/graphs/graph.repository.ts`).
   - **Remove/repair wrong type tasks**: do not edit `packages/types/src/node-types.ts` for `MindNodeData.order`; it already exists via `NodeData` in `packages/types/src/index.ts`. Update story tasks/file map accordingly.
   - **Make template-save order concrete**: add explicit tasks + file paths to update `apps/web/lib/subtree-extractor.ts` to (1) sort children by `data.order` (fallback id), and (2) write `TemplateNode.order`.
2. Should Improve:
   - **Define order invariants**: specify how to handle missing/duplicate/gapped orders and when to “normalize” (e.g., on insert or on load).
   - **Strengthen tests**: update existing unit tests (`commands.test.ts`, `NavigationCommand.test.ts`, `templates.service.spec.ts`) and add at least one integration/E2E path that validates “first open from relational init” preserves order.
   - **Revisit DB default semantics**: consider `order Int?` (nullable) or a migration/normalization strategy to avoid “implicit 0” collisions with the `Infinity` fallback contract.
3. Consider:
   - **Performance guardrails**: document expected sibling-set sizes; if large, consider sparse ordering (fractional keys) + periodic renormalization.
   - **LLM ergonomics**: remove contradictory statements, replace `...` placeholders with exact file paths, and keep one canonical algorithm reference (prefer reusing the Outline `normalizeOrder` pattern).
