# Validation Report

**Document:** `docs/sprint-artifacts/story-7-9-approval-status-panel-refactor.md`  
**Checklist:** `_bmad/bmm/workflows/4-implementation/create-story/checklist.md`  
**Date:** 2026-01-01T12-11-18+0800

## Summary

- Overall: **7/19 passed** (36.8%)
- Critical Issues: **2** (scope/accuracy + UX regression risk)
- Totals: 7 ✓ PASS, 10 ⚠ PARTIAL, 2 ✗ FAIL

## Section Results

### A) 模板与可执行性

Pass Rate: 4/6 (66.7%)

[✓ PASS] 1) Story 标题/编号明确  
Evidence:
- `docs/sprint-artifacts/story-7-9-approval-status-panel-refactor.md:1` `# Story 7.9: ApprovalStatusPanel 组件拆分`

[✓ PASS] 2) Status 明确且为 `ready-for-dev`  
Evidence:
- `docs/sprint-artifacts/story-7-9-approval-status-panel-refactor.md:3` `Status: ready-for-dev`

[✓ PASS] 3) User Story 三段式清晰（As / I want / so that）  
Evidence:
- `docs/sprint-artifacts/story-7-9-approval-status-panel-refactor.md:7-9` `As a ... I want ... so that ...`

[⚠ PARTIAL] 4) AC 可验证，但“功能保持正常”覆盖范围不够细  
Evidence:
- `docs/sprint-artifacts/story-7-9-approval-status-panel-refactor.md:29-31` 仅列出“提交/审批/驳回、交付物上传、历史查看”
- 现有组件还包含：交付物 **下载/预览/删除**、未配置时 **配置流程** 等能力：
  - `apps/web/components/PropertyPanel/ApprovalStatusPanel.tsx:525-533` “配置流程”按钮
  - `apps/web/components/PropertyPanel/ApprovalStatusPanel.tsx:197-203` deliverable download/preview handler
  - `apps/web/components/PropertyPanel/ApprovalStatusPanel.tsx:412-421` deliverable delete button
Impact:
- Dev 可能在“满足 AC#5”的同时，意外破坏下载/预览/删除/配置流程等既有能力而不自知。

[✓ PASS] 5) Tasks 与 AC 显式映射（可执行的拆分步骤）  
Evidence:
- `docs/sprint-artifacts/story-7-9-approval-status-panel-refactor.md:35-65` 每个 Task 都标注了 (AC: #)

[⚠ PARTIAL] 6) Dev Notes 有，但缺少“新文件的精确路径/导出策略”  
Evidence:
- `docs/sprint-artifacts/story-7-9-approval-status-panel-refactor.md:68-70` 仅给出当前文件路径
- `docs/sprint-artifacts/story-7-9-approval-status-panel-refactor.md:85-87` 同时出现“保留在 PropertyPanel/”与“可考虑创建子目录”的可选项
Impact:
- 可能导致文件放置不一致（同目录 vs 新子目录），并引入额外的 barrel/export 调整风险。

### B) 与 Epic/现状一致性

Pass Rate: 1/3 (33.3%)

[✓ PASS] 7) AC 与 Epic 7.9 一致  
Evidence:
- Epic 7.9 AC：`docs/epics.md:752-756`
- Story 7.9 AC：`docs/sprint-artifacts/story-7-9-approval-status-panel-refactor.md:13-31`

[⚠ PARTIAL] 8) 已识别关键依赖（`useApproval` / `@cdm/ui`），但缺少“防回退”硬约束  
Evidence:
- `docs/sprint-artifacts/story-7-9-approval-status-panel-refactor.md:81-83` 提到 `useApproval` 和 `@cdm/ui`
- 当前实现确实依赖 hook：`apps/web/components/PropertyPanel/ApprovalStatusPanel.tsx:450-466`
- Story 7.2 明确该模块的目标是“组件不再包含 fetch/API 状态管理”：`docs/sprint-artifacts/story-7-2-frontend-hook-first-extraction.md:7-14`
Impact:
- 拆分时可能把 API 行为/副作用重新塞回子组件，破坏 Hook-First 初衷（需要在 Story 7.9 里明确“不得新增 fetch/副作用”）。

[✗ FAIL] 9) “ApprovalHistory”要求与当前实现不匹配/不够清晰，存在增功能或误拆风险  
Evidence:
- Story 声明需要独立 `ApprovalHistory.tsx`：`docs/sprint-artifacts/story-7-9-approval-status-panel-refactor.md:25-28`
- Tasks 还提到“历史记录时间轴”“展开/收起逻辑”：`docs/sprint-artifacts/story-7-9-approval-status-panel-refactor.md:56-60`
- 但当前 `ApprovalStatusPanel` 主要由 stepper + deliverables + actions 构成，并未存在“时间轴/展开收起”的历史区块：
  - `apps/web/components/PropertyPanel/ApprovalStatusPanel.tsx:571-680`（Stepper/Deliverables/Buttons/RejectForm/Status message）
Impact:
- Dev 无法判断 ApprovalHistory 的真实含义（是把 stepper 抽出？还是新增历史 UI？），容易造成范围漂移或实现偏差。

### C) 灾难预防（Checklist 关键风险覆盖）

Pass Rate: 1/8 (12.5%)

[⚠ PARTIAL] 10) 防止“重复造轮子”（已有 hook / 子组件可抽取）  
Evidence:
- 现有文件已包含可抽取的内嵌组件：`apps/web/components/PropertyPanel/ApprovalStatusPanel.tsx:163-431` `DeliverablesSection(...)`
- Story 指出依赖 `useApproval`：`docs/sprint-artifacts/story-7-9-approval-status-panel-refactor.md:81`
Impact:
- 仍需在 Dev Notes 明确：不得新增新的审批 API 封装/不得复制 `useApproval` 逻辑。

[✓ PASS] 11) 避免“错误库”（明确使用 `@cdm/ui`）  
Evidence:
- `docs/sprint-artifacts/story-7-9-approval-status-panel-refactor.md:82-83` 指定 `@cdm/ui`

[⚠ PARTIAL] 12) 避免“错误文件位置”（给出当前目录，但新文件位置仍有歧义）  
Evidence:
- 当前文件明确：`docs/sprint-artifacts/story-7-9-approval-status-panel-refactor.md:68-70`
- 但新文件仅给出文件名（未给全路径）：`docs/sprint-artifacts/story-7-9-approval-status-panel-refactor.md:19-27`
Impact:
- 容易出现 `ApprovalStatus.tsx` 等散落到其他目录，或引入不必要的 index/barrel 改动。

[⚠ PARTIAL] 13) 防回归（仅要求“功能正常”，缺少明确验证清单）  
Evidence:
- `docs/sprint-artifacts/story-7-9-approval-status-panel-refactor.md:29-31` 功能验证较粗
- 代码中关键交互点较多（配置流程、上传、预览、下载、删除、提交、驳回表单等）：`apps/web/components/PropertyPanel/ApprovalStatusPanel.tsx:520-665`
Impact:
- Dev 容易遗漏某些交互路径；建议补充“手动验证步骤/最小测试用例清单”。

[✗ FAIL] 14) UX 约束缺失（未明确“UI/行为不得变化”或“允许的 UI 变化”）  
Evidence:
- Story 未在 AC 或 Dev Notes 中声明“视觉/交互保持不变”或列出允许变更范围：`docs/sprint-artifacts/story-7-9-approval-status-panel-refactor.md`
Impact:
- 纯重构 Story 最常见的事故是 UX/交互细节被改动（按钮禁用条件、文案、布局、loading 状态等）。

[⚠ PARTIAL] 15) 实现细节仍偏抽象（缺少 props 边界/责任分配约束）  
Evidence:
- Tasks 仅描述“迁移/整合”：`docs/sprint-artifacts/story-7-9-approval-status-panel-refactor.md:41-65`
- 当前容器内含权限/按钮显隐判断（建议明确保留在容器层）：`apps/web/components/PropertyPanel/ApprovalStatusPanel.tsx:477-483`
Impact:
- 容易把权限计算/副作用散落到子组件，导致逻辑重复或状态错乱。

[⚠ PARTIAL] 16) 防“虚假完成”（可量化行数目标 OK，但其他 AC 未定义到“不可歧义”）  
Evidence:
- 行数目标明确：`docs/sprint-artifacts/story-7-9-approval-status-panel-refactor.md:13-16`
- 但“正常工作”未定义到可复现路径：`docs/sprint-artifacts/story-7-9-approval-status-panel-refactor.md:29-31`
Impact:
- 容易在边界场景（无 steps、无 deliverables、loading 中、驳回输入为空等）出现回归。

[⚠ PARTIAL] 17) “从过往故事学习”有引用，但未提炼成可执行约束  
Evidence:
- 引用 Story 7.2：`docs/sprint-artifacts/story-7-9-approval-status-panel-refactor.md:91-92`
- Story 7.2 的核心教训/目标：Hook-First + 禁止 fetch：`docs/sprint-artifacts/story-7-2-frontend-hook-first-extraction.md:7-14`
Impact:
- 建议把这些“教训”直接固化为 Story 7.9 的 Dev Notes/DoD 条目。

### D) LLM 可读性/结构优化

Pass Rate: 1/2 (50.0%)

[✓ PASS] 18) 结构清晰、信息密度高，适合 dev agent 执行  
Evidence:
- Story 内容短、结构完整：`docs/sprint-artifacts/story-7-9-approval-status-panel-refactor.md`

[⚠ PARTIAL] 19) 存在可选项/歧义点（子目录方案、ApprovalHistory 含义）  
Evidence:
- `docs/sprint-artifacts/story-7-9-approval-status-panel-refactor.md:86-87` “可考虑创建子目录”
- `docs/sprint-artifacts/story-7-9-approval-status-panel-refactor.md:25-28` `ApprovalHistory.tsx` 未定义其内容/边界
Impact:
- LLM/Dev 在关键结构决策上缺少确定性，容易分歧实现。

## Failed Items

1) ✗ FAIL — ApprovalHistory 要求与现状不匹配/不清晰（见 #9）  
Recommendation:
- 明确 `ApprovalHistory` 的内容来源与 UI（例如：直接把现有 `ApprovalStepper` 抽成 `ApprovalHistory`，或新增真正的历史 timeline；两者不可混淆）。

2) ✗ FAIL — UX 约束缺失（见 #14）  
Recommendation:
- 在 AC 或 Dev Notes 增加“UI/行为保持不变”的声明，并列出必须回归的交互路径清单。

## Partial Items

- #4, #6, #8, #10, #12, #13, #15, #16, #17, #19

## Recommendations

1) Must Fix
   - **澄清 `ApprovalHistory` 的定义**：它是对现有 stepper 的抽取/重命名，还是新增“历史时间轴”？如果是新增，必须写清数据来源、展示内容、展开/收起交互与验收点。
   - **补上 UX/回归约束**：明确“纯重构，不改变 UI/交互/文案/禁用条件/loading 行为”，并把现有能力列成回归清单（配置流程、提交、通过、驳回（含输入校验）、上传、删除、下载、预览等）。

2) Should Improve
   - **指定新文件的完整路径与导出策略**（建议优先放在 `apps/web/components/PropertyPanel/` 同目录；如要建子目录则一次性说明并明确不会影响 `PropertyPanel/index.tsx` 的现有 import 方式）。
   - **明确容器/展示边界**：`ApprovalStatusPanel` 作为 container 负责 `useApproval` + 权限计算（`canSubmit/canApprove/canReject`），子组件尽量做 presentational（只收 props + 回调）。
   - **补充最小验证步骤或测试建议**：至少列出手动回归脚本；如可行，考虑为拆出的子组件加快照/基础渲染测试（参考 `docs/architecture.md:661-665`）。

3) Consider
   - 将 `getStatusBadge` / `BadgeVariant` 等与 UI 展示强相关的逻辑聚合到 `ApprovalStatus`（或单独 `approvalStatus.utils.ts`）以减少主文件噪音。
