# Validation Report

**Document:** docs/sprint-artifacts/9-8-node-view-merge.md  
**Checklist:** _bmad/bmm/workflows/4-implementation/create-story/checklist.md  
**Date:** 2026-01-13T14-19-16+0800  
**Agent Model:** GPT-5.2 (Codex CLI)

## Summary
- Overall: 27/80 passed (33.8%); Partial: 48; Fail: 1; N/A: 4
- Critical Issues: 1

## Section Results

### Critical Mistakes to Prevent
Pass Rate: 2/8 (25.0%)

⚠ PARTIAL — Reinventing wheels  
Evidence: Story proposes a new batch link endpoint `POST /links:batch` (`docs/sprint-artifacts/9-8-node-view-merge.md:125-132`) while the codebase already has batch-by-nodes primitives (`POST /api/data-assets/links:byNodes` returns assets; repo already supports `findByNodeIds`) (`apps/api/src/modules/data-management/data-asset.controller.ts:329-338`; `apps/api/src/modules/data-management/node-data-link.repository.ts:65-80`).  
Impact: Dev may add redundant/incorrect endpoints instead of extending existing ones (higher integration + maintenance risk).

⚠ PARTIAL — Wrong libraries  
Evidence: AC7 requires “Undo Toast” (`docs/sprint-artifacts/9-8-node-view-merge.md:82-90,272-283`) but the shared `@cdm/ui` toast system currently has no action/undo payload (only `title/description/duration`) (`packages/ui/src/toast.tsx:74-82`).  
Impact: Dev may either implement a second toast system or expand UI primitives mid-story (scope creep + inconsistent UX).

⚠ PARTIAL — Wrong file locations  
Evidence: Task 1.3 points to `DataLibraryDrawer.tsx` for “视图切换逻辑” (`docs/sprint-artifacts/9-8-node-view-merge.md:105-109`), but the actual org-panel view switching and right-panel rendering live in `DataLibraryDrawerContent.tsx` (`apps/web/features/data-library/components/data-library-drawer/DataLibraryDrawerContent.tsx:210-259`).  
Impact: Dev may change the wrong file and see no UI effect, or miss required changes in `DataLibraryDrawerContent`.

⚠ PARTIAL — Breaking regressions  
Evidence: Current behavior is split by `orgView === 'pbs'|'task'|'folder'` in both upload config (`apps/web/features/data-library/hooks/useContextAwareUpload.ts:70-86`) and grouped-right-panel logic (`apps/web/features/data-library/components/data-library-drawer/DataLibraryDrawerContent.tsx:103-123`). Story merges views into `'node'|'folder'` (`docs/sprint-artifacts/9-8-node-view-merge.md:105-109`) but does not call out updates to these shared flows.  
Impact: Upload defaults, grouped view, and selection-scoped fetching can silently break after tab merge.

✓ PASS — Ignoring UX  
Evidence: High-fidelity UI specs + interaction details provided (`docs/sprint-artifacts/9-8-node-view-merge.md:158-288`).

⚠ PARTIAL — Vague implementations  
Evidence: AC2 requires preserving “原始树同级顺序” (`docs/sprint-artifacts/9-8-node-view-merge.md:33-37`) but does not map it to the existing `NodeData.order` field (`packages/types/src/index.ts:2-14`). Breadcrumb clickability is also underspecified for hidden nodes (DATA/ORDINARY) (`docs/sprint-artifacts/9-8-node-view-merge.md:39-46`).  
Impact: Dev may sort by label (like current PBS/TASK hooks do) or implement inconsistent navigation for hidden nodes.

✓ PASS — Lying about completion  
Evidence: AC-to-tests coverage is explicitly designed (unit/integration/E2E + matrices) (`docs/sprint-artifacts/9-8-node-view-merge.md:358-600`).

⚠ PARTIAL — Not learning from past work  
Evidence: Story references tech spec + architecture + types (`docs/sprint-artifacts/9-8-node-view-merge.md:311-356`) but does not explicitly call out existing Story 9.7 patterns it will impact (context-aware upload + grouped links query) (`apps/web/features/data-library/hooks/useContextAwareUpload.ts:55-93`; `apps/web/features/data-library/components/data-library-drawer/DataLibraryDrawerContent.tsx:103-173`).  
Impact: Known working patterns may be duplicated or accidentally regressed.

---

### Step 1: Load and Understand the Target
Pass Rate: 6/6 (100.0%)

✓ PASS — Load the workflow configuration  
Evidence: Workflow config exists (`_bmad/bmm/workflows/4-implementation/create-story/workflow.yaml:1-32`).

✓ PASS — Load the story file  
Evidence: Story file exists with title + status (`docs/sprint-artifacts/9-8-node-view-merge.md:1-3`).

✓ PASS — Load validation framework  
Evidence: Validation framework defined (`_bmad/core/tasks/validate-workflow.xml:1-88`).

✓ PASS — Extract metadata (epic/story key/title)  
Evidence: Story title indicates 9.8 (`docs/sprint-artifacts/9-8-node-view-merge.md:1`).

✓ PASS — Resolve workflow variables  
Evidence: `output_folder` and `sprint_artifacts` are defined and story is under that path (`_bmad/bmm/config.yaml:8-14`; `_bmad/bmm/workflows/4-implementation/create-story/workflow.yaml:6-13`; `docs/sprint-artifacts/9-8-node-view-merge.md:1`).

✓ PASS — Understand current status  
Evidence: Status `ready-for-dev` (`docs/sprint-artifacts/9-8-node-view-merge.md:3`).

---

### Step 2.1: Epics and Stories Analysis
Pass Rate: 4/6 (66.7%)

✓ PASS — Load epics file  
Evidence: Epic 9 / Story 9.8 present (`docs/epics.md:1055-1076,1216-1270`).

✓ PASS — Epic objectives and business value  
Evidence: Epic 9 objective defined (`docs/epics.md:1055-1058`).

✓ PASS — ALL stories in this epic (cross-story context)  
Evidence: Story list exists in Epic 9 section and includes 9.1–9.8 (`docs/epics.md:1059-1216`).

✓ PASS — Story requirements and acceptance criteria alignment  
Evidence: Story 9.8 ACs match the epic definition (tab merge, projection, breadcrumb, multi-select, search, unlink) (`docs/epics.md:1216-1269`; `docs/sprint-artifacts/9-8-node-view-merge.md:20-90`).

⚠ PARTIAL — Technical requirements and constraints  
Evidence: Story references core types/models (`NodeType.PBS/TASK`, `NodeDataLink`) and “纯前端投影” (`docs/sprint-artifacts/9-8-node-view-merge.md:316-321`), but does not specify the concrete ordering source (`NodeData.order`) for “同级顺序” (`packages/types/src/index.ts:2-14`).  
Impact: Incorrect ordering choices can yield unstable UI (and regress “SoT” browsing).

⚠ PARTIAL — Cross-story dependencies and prerequisites  
Evidence: Story plans a tab merge (`docs/sprint-artifacts/9-8-node-view-merge.md:105-109`) but does not explicitly list the shared flows that must be updated (upload defaults + grouped-right-panel logic) (`apps/web/features/data-library/hooks/useContextAwareUpload.ts:55-93`; `apps/web/features/data-library/components/data-library-drawer/DataLibraryDrawerContent.tsx:103-173`).  
Impact: Dev may “pass” AC1 but ship broken upload/grouped display from earlier stories.

---

### Step 2.2: Architecture Deep-Dive
Pass Rate: 4/10 (40.0%)

✓ PASS — Load architecture file  
Evidence: Architecture file exists and covers Epic 9 Data Management module (`docs/architecture.md:714-823`).

⚠ PARTIAL — Technical stack with versions  
Evidence: Story does not capture relevant stack/version constraints (Next.js/React/X6/React Query) (contrast project context) (`docs/project-context.md:14-43`; story references focus on local files/types: `docs/sprint-artifacts/9-8-node-view-merge.md:316-356`).  
Impact: Dev may assume missing primitives (e.g., UI components/toast actions) or miss existing stack conventions.

✓ PASS — Code structure and organization patterns  
Evidence: Proposed file layout matches current `apps/web/features/data-library/{components,hooks}` conventions (`docs/sprint-artifacts/9-8-node-view-merge.md:290-305`; `apps/web/features/data-library/components/OrganizationTabs.tsx:1-131`).

⚠ PARTIAL — API design patterns and contracts  
Evidence: Story requests a batch API (`docs/sprint-artifacts/9-8-node-view-merge.md:126-132`) but does not align naming/path with existing endpoints (`/api/data-assets/links:byNodes`, `/api/data-assets/links:detail`) (`apps/web/features/data-library/api/data-assets.ts:278-300,336-357`; `apps/api/src/modules/data-management/data-asset.controller.ts:318-338`).  
Impact: Implementation may introduce inconsistent routes or require refactoring existing callers/tests.

➖ N/A — Database schemas and relationships  
Evidence: No schema changes are described; story explicitly says to use existing `NodeDataLink` model (`docs/sprint-artifacts/9-8-node-view-merge.md:316-320`).

✓ PASS — Security requirements and patterns  
Evidence: Explicit injection defense for search input (`escapeRegex`) (`docs/sprint-artifacts/9-8-node-view-merge.md:68-76,143-150`).

⚠ PARTIAL — Performance requirements and optimization strategies  
Evidence: Some guardrails exist (depth limit + roots warning + provenance cap) (`docs/sprint-artifacts/9-8-node-view-merge.md:110-116,334-341`), but no constraints for multi-node selection scaling (e.g., large `nodeIds` payload, link explosion) or UI virtualization plan.  
Impact: Performance may degrade with many selected nodes / dense link graphs.

✓ PASS — Testing standards and frameworks  
Evidence: Detailed unit/integration/E2E plan consistent with repo frameworks (Vitest/Playwright) (`docs/sprint-artifacts/9-8-node-view-merge.md:358-600`; `docs/project-context.md:39-43`).

➖ N/A — Deployment and environment patterns  
Evidence: No deployment/environment changes in scope.

⚠ PARTIAL — Integration patterns and external services  
Evidence: Story implies GraphContext-based traversal (parent chain) but does not name the integration touchpoints (GraphContext/X6 node data access), unlike existing hooks (`apps/web/features/data-library/hooks/usePbsNodes.ts:14-58`; `apps/web/features/data-library/hooks/useTaskNodes.ts:14-58`).  
Impact: Dev may diverge from established graph subscription/debounce patterns.

---

### Step 2.3: Previous Story Intelligence
Pass Rate: 1/7 (14.3%)

⚠ PARTIAL — Load previous story file  
Evidence: Story references “复用现有” components but does not cite prior Story 9.7 explicitly (`docs/sprint-artifacts/9-8-node-view-merge.md:343-348`).  
Impact: Dev misses concrete precedent for grouped links + upload context that must be preserved.

⚠ PARTIAL — Dev notes and learnings  
Evidence: Dev Notes exist (`docs/sprint-artifacts/9-8-node-view-merge.md:309-357`) but do not include the key “tab merge fallout” learnings (e.g., update `useContextAwareUpload`, `DataLibraryDrawerContent` grouping logic, and existing tests).  
Impact: High regression probability when merging view modes.

⚠ PARTIAL — Review feedback and corrections needed  
Evidence: No explicit “pitfalls” / “known gotchas” section beyond Red Team table (`docs/sprint-artifacts/9-8-node-view-merge.md:334-341`).  
Impact: Known repo-specific pitfalls (API paths, test locations, toast capabilities) may be discovered late.

✓ PASS — Files created/modified and their patterns  
Evidence: Concrete file structure tables for components/hooks/tests (`docs/sprint-artifacts/9-8-node-view-merge.md:290-305,362-373`).

⚠ PARTIAL — Testing approaches that worked/didn’t  
Evidence: Story defines new tests but does not call out existing E2E that will break on tab merge (`apps/web/e2e/data-library-views.spec.ts:115-129`). It also uses mixed test directory conventions (project context notes `apps/web/__tests__/`) (`docs/project-context.md:116-120`; story uses `apps/web/features/data-library/__tests__`: `docs/sprint-artifacts/9-8-node-view-merge.md:358-373`).  
Impact: Increased chance of “green local” but broken CI / orphaned tests.

⚠ PARTIAL — Problems encountered and solutions found  
Evidence: Story includes defenses (depth/roots/provenance) (`docs/sprint-artifacts/9-8-node-view-merge.md:334-341`) but does not address a predictable migration issue: orgView localStorage currently persists `'pbs'|'task'|'folder'` (`apps/web/features/data-library/components/OrganizationTabs.tsx:102-117`).  
Impact: Users with stored `'pbs'/'task'` can hit invalid view state after merging.

⚠ PARTIAL — Code patterns and conventions established  
Evidence: References reuse of `DataLibraryDrawer` / `AssetCard` (`docs/sprint-artifacts/9-8-node-view-merge.md:343-348`) but omits existing “grouped links query” and “upload config” patterns which are central to this epic (`apps/web/features/data-library/components/data-library-drawer/DataLibraryDrawerContent.tsx:103-173`; `apps/web/features/data-library/hooks/useContextAwareUpload.ts:55-93`).  
Impact: Duplicate logic and inconsistent behavior across features.

---

### Step 2.4: Git History Analysis
Pass Rate: 0/5 (0.0%)

⚠ PARTIAL — Files created/modified in previous work  
Evidence: No commit references or “recent changes” note in story (`docs/sprint-artifacts/9-8-node-view-merge.md:350-356`).  
Impact: Dev may miss recently introduced patterns (e.g., Story 9.7 grouped view + upload hook changes).

⚠ PARTIAL — Code patterns and conventions used  
Evidence: No git history citations (`docs/sprint-artifacts/9-8-node-view-merge.md:350-356`).  
Impact: Implementation may diverge from current conventions.

⚠ PARTIAL — Library dependencies added/changed  
Evidence: No dependency/version rationale linked to commits (`docs/sprint-artifacts/9-8-node-view-merge.md:309-357`).  
Impact: Dev may add new UI libs for tooltip/toast instead of reusing existing.

⚠ PARTIAL — Architecture decisions implemented  
Evidence: No commit references or “latest state” notes (`docs/sprint-artifacts/9-8-node-view-merge.md:309-357`).  
Impact: Might contradict current API routing/layout decisions.

⚠ PARTIAL — Testing approaches used  
Evidence: No mention of existing Playwright coverage to update (`apps/web/e2e/data-library-views.spec.ts:115-129`).  
Impact: Tab merge will break existing E2E unless explicitly updated.

---

### Step 2.5: Latest Technical Research
Pass Rate: 0/4 (0.0%)

⚠ PARTIAL — Identify libraries/frameworks mentioned  
Evidence: Story focuses on feature behavior but does not mention key underlying frameworks (X6 GraphContext, React Query) that shape implementation (`docs/sprint-artifacts/9-8-node-view-merge.md:18-156`).  
Impact: Missing pointers can lead to wrong API usage/patterns.

⚠ PARTIAL — Breaking changes or security updates  
Evidence: No version/release-note references (contrast project context enumerating versions) (`docs/project-context.md:14-43`).  
Impact: Dev may hit compatibility surprises when adding UI primitives.

⚠ PARTIAL — Performance improvements or deprecations  
Evidence: No research pointers for handling large trees / virtualization / query limits.  
Impact: May ship a slow UI for large graphs.

⚠ PARTIAL — Best practices for current versions  
Evidence: No pointers for X6 graph event subscriptions or query-key conventions, despite existing patterns in hooks (`apps/web/features/data-library/hooks/usePbsNodes.ts:33-58`; `apps/web/features/data-library/hooks/useAssetLinks.ts:35-61`).  
Impact: Dev may implement inconsistent subscriptions/caching.

---

### Step 3.1: Reinvention Prevention Gaps
Pass Rate: 0/3 (0.0%)

⚠ PARTIAL — Wheel reinvention  
Evidence: Story calls for a new `POST /links:batch` endpoint (`docs/sprint-artifacts/9-8-node-view-merge.md:126-132`) even though batch link data already exists at repository level (`apps/api/src/modules/data-management/node-data-link.repository.ts:65-80`).  
Impact: Duplicated backend logic and inconsistent API surface.

⚠ PARTIAL — Code reuse opportunities not identified  
Evidence: Story requires stable sibling order (`docs/sprint-artifacts/9-8-node-view-merge.md:33-37`) but does not reference the existing `NodeData.order` field intended for that (`packages/types/src/index.ts:2-14`).  
Impact: Higher chance of unstable/incorrect projection ordering.

⚠ PARTIAL — Existing solutions not mentioned  
Evidence: Existing `useAssetLinks` + `GroupedAssetList` cover single-node linkType grouping (`apps/web/features/data-library/hooks/useAssetLinks.ts:35-61`; `apps/web/features/data-library/components/data-library-drawer/DataLibraryDrawerContent.tsx:103-173`), but story does not state whether to extend/replace these for multi-node union.  
Impact: Dev may duplicate grouping UI and caching logic.

---

### Step 3.2: Technical Specification DISASTERS
Pass Rate: 1/5 (20.0%)

⚠ PARTIAL — Wrong libraries/frameworks  
Evidence: Undo Toast requirement is strong UX coupling (`docs/sprint-artifacts/9-8-node-view-merge.md:272-283`) but no guidance on which toast system to extend (repo uses both `sonner` and `@cdm/ui` toasts) (`apps/web/features/data-library/components/DataLibraryDrawer.tsx:190-200`; `packages/ui/src/toast.tsx:74-120`).  
Impact: Inconsistent notifications, or new dependency churn.

✗ FAIL — API contract violations  
Evidence: Story specifies `POST /links:batch` (`docs/sprint-artifacts/9-8-node-view-merge.md:126-132,322-332`) but the existing API namespace is `/api/data-assets/...` and current batch endpoint is `POST /api/data-assets/links:byNodes` (assets only) (`apps/web/features/data-library/api/data-assets.ts:278-300`; `apps/api/src/modules/data-management/data-asset.controller.ts:329-338`).  
Impact: If implemented literally, the frontend and backend will not interoperate; multi-node provenance (requires `linkType`) cannot be computed from the existing `links:byNodes` response without a new, correctly scoped endpoint.

➖ N/A — Database schema conflicts  
Evidence: No schema changes requested; link uniqueness already exists (`docs/architecture.md:771-785`; story uses existing model: `docs/sprint-artifacts/9-8-node-view-merge.md:316-320`).

✓ PASS — Security vulnerabilities  
Evidence: Explicitly requires escaping regex meta-characters in search (`escapeRegex`) (`docs/sprint-artifacts/9-8-node-view-merge.md:68-76,143-150`).

⚠ PARTIAL — Performance disasters  
Evidence: Multi-node union + provenance can explode combinatorially but the story only caps display (10) and warns on roots, without defining query sizing or batch response shape (`docs/sprint-artifacts/9-8-node-view-merge.md:57-66,110-116,334-341`).  
Impact: Large selections can cause slow renders or large payloads that time out.

---

### Step 3.3: File Structure DISASTERS
Pass Rate: 1/4 (25.0%)

⚠ PARTIAL — Wrong file locations  
Evidence: Story focuses on `DataLibraryDrawer.tsx` (`docs/sprint-artifacts/9-8-node-view-merge.md:105-109`) but the view branching lives in `DataLibraryDrawerContent.tsx` (`apps/web/features/data-library/components/data-library-drawer/DataLibraryDrawerContent.tsx:210-244`). Backend endpoint work also lacks module/file pointers (NestJS module-per-feature).  
Impact: Changes may be placed where they don’t get executed, or backend work may land outside the `data-management` module conventions.

✓ PASS — Coding standard violations  
Evidence: Story stays TypeScript-first and hook-first, and references shared types from `@cdm/types` (`docs/sprint-artifacts/9-8-node-view-merge.md:316-321`; `docs/project-context.md:50-58`).

⚠ PARTIAL — Integration pattern breaks  
Evidence: Dual Search is specified as a new component (`docs/sprint-artifacts/9-8-node-view-merge.md:143-150,252-269`) but the drawer already has a toolbar-level search input wired into `useDataAssets` (`apps/web/features/data-library/components/DataLibraryDrawer.tsx:151-174`; `apps/web/features/data-library/components/data-library-drawer/DataLibraryDrawerToolbar.tsx:86-122`).  
Impact: Dev may create parallel search states, causing inconsistent filtering/results.

➖ N/A — Deployment failures  
Evidence: No deployment changes.

---

### Step 3.4: Regression DISASTERS
Pass Rate: 0/4 (0.0%)

⚠ PARTIAL — Breaking changes  
Evidence: Org view type changes from `'pbs'|'task'|'folder'` to `'node'|'folder'` (`docs/sprint-artifacts/9-8-node-view-merge.md:105-109`) will require migrations in persisted localStorage (`apps/web/features/data-library/components/OrganizationTabs.tsx:102-117`) and in upload/grouped view logic (`apps/web/features/data-library/hooks/useContextAwareUpload.ts:55-93`; `apps/web/features/data-library/components/data-library-drawer/DataLibraryDrawerContent.tsx:103-173`).  
Impact: Users may land in invalid view; upload/link defaults may silently regress.

⚠ PARTIAL — Test failures  
Evidence: Existing unit/E2E tests assert PBS/Task tabs and `org-tab-task` presence (`apps/web/features/data-library/__tests__/OrganizationViews.test.tsx:86-129`; `apps/web/e2e/data-library-views.spec.ts:115-129`). Story notes updating one unit test but does not mention updating the existing E2E.  
Impact: CI will fail (or coverage gaps will appear) unless test updates are explicitly planned.

⚠ PARTIAL — UX violations  
Evidence: Breadcrumb includes hidden nodes (`docs/sprint-artifacts/9-8-node-view-merge.md:39-46`) but expected click behavior for hidden nodes is unspecified.  
Impact: UX can become confusing (clickable items that cannot be “located” in the node tree).

⚠ PARTIAL — Learning failures  
Evidence: Story does not explicitly reference Story 9.7’s context-aware behavior contracts (upload defaults differ by view) (`docs/epics.md:1186-1214`; `apps/web/features/data-library/hooks/useContextAwareUpload.ts:46-54`).  
Impact: Regression in the “smart behavior” epic intent is likely.

---

### Step 3.5: Implementation DISASTERS
Pass Rate: 1/4 (25.0%)

⚠ PARTIAL — Vague implementations  
Evidence: The story does not define the selection model when both “单节点 breadcrumb” (AC3) and “多节点并集” (AC4) coexist (`docs/sprint-artifacts/9-8-node-view-merge.md:39-56`).  
Impact: Dev may implement conflicting states (active node vs selected set), breaking breadcrumb/provenance.

✓ PASS — Completion lies  
Evidence: AC coverage is anchored by explicit test matrix + examples (`docs/sprint-artifacts/9-8-node-view-merge.md:570-583,586-600`).

⚠ PARTIAL — Scope creep  
Evidence: Story bundles tab merge + projection + multi-select + provenance + dual search + undo + batch unlink (`docs/sprint-artifacts/9-8-node-view-merge.md:20-156`).  
Impact: High implementation surface may delay delivery; unclear MVP slicing.

⚠ PARTIAL — Quality failures  
Evidence: Several items are specified without concrete API contracts (batch link query + batch unlink) (`docs/sprint-artifacts/9-8-node-view-merge.md:125-156`).  
Impact: Dev may implement ad-hoc contracts that are hard to test and maintain.

---

### Step 4: LLM-Dev-Agent Optimization Analysis
Pass Rate: 1/5 (20.0%)

⚠ PARTIAL — Verbosity problems  
Evidence: Story includes large inline test code blocks and extended design prose (`docs/sprint-artifacts/9-8-node-view-merge.md:158-305,394-420`).  
Impact: In token-limited contexts, critical integration constraints may be missed.

⚠ PARTIAL — Ambiguity issues  
Evidence: Upload behavior after merging PBS/Task tabs is not defined (previously differed by tab) (`docs/epics.md:1186-1207`; story has no replacement rule).  
Impact: Dev may implement the wrong default linkType or wrong upload target for multi-select.

⚠ PARTIAL — Context overload  
Evidence: UI prototype sections are comprehensive but mixed with implementation tasks/tests (`docs/sprint-artifacts/9-8-node-view-merge.md:158-600`).  
Impact: Harder for dev agent to locate the “must implement” contracts quickly.

⚠ PARTIAL — Missing critical signals  
Evidence: Story does not call out required updates to `useContextAwareUpload` and existing tests that key on `'pbs'|'task'` (`apps/web/features/data-library/hooks/useContextAwareUpload.ts:55-93`; `apps/web/__tests__/features/data-library/useContextAwareUpload.test.ts:43-80`).  
Impact: High chance of incomplete implementation and failing tests.

✓ PASS — Poor structure  
Evidence: Clear headings, ACs, tasks, design, dev notes, and test matrix are present (`docs/sprint-artifacts/9-8-node-view-merge.md:18-156,158-357,358-614`).

---

### Step 4: LLM Optimization Principles
Pass Rate: 2/5 (40.0%)

⚠ PARTIAL — Clarity over verbosity  
Evidence: Key integration decisions (API contracts, upload defaults) are not prioritized above UI details (`docs/sprint-artifacts/9-8-node-view-merge.md:158-305`).  
Impact: Dev may implement UI correctly but miss cross-story contract changes.

✓ PASS — Actionable instructions  
Evidence: Task list is explicit and maps to ACs (`docs/sprint-artifacts/9-8-node-view-merge.md:103-156`).

✓ PASS — Scannable structure  
Evidence: Structured sections + tables + matrices (`docs/sprint-artifacts/9-8-node-view-merge.md:158-305,322-357,570-583`).  

⚠ PARTIAL — Token efficiency  
Evidence: Inline test code blocks can likely be reduced to key assertions + file paths (compare other validated stories that avoid long snippets).  
Impact: Increased chance of truncation/missed constraints.

⚠ PARTIAL — Unambiguous language  
Evidence: Breadcrumb clickability for hidden nodes and upload default behavior in merged tab are underspecified (`docs/sprint-artifacts/9-8-node-view-merge.md:39-46`; `docs/epics.md:1186-1207`).  
Impact: Multiple plausible implementations → inconsistent UX/regressions.

---

### Step 5: Improvement Recommendations
Pass Rate: 4/4 (100.0%)

✓ PASS — Critical Misses (Must Fix)  
Evidence: Addressed in “Recommendations” section below (per checklist `_bmad/bmm/workflows/4-implementation/create-story/checklist.md:193-199`).

✓ PASS — Enhancement Opportunities (Should Add)  
Evidence: Addressed in “Recommendations” section below (per checklist `_bmad/bmm/workflows/4-implementation/create-story/checklist.md:200-206`).

✓ PASS — Optimization Suggestions (Nice to Have)  
Evidence: Addressed in “Recommendations” section below (per checklist `_bmad/bmm/workflows/4-implementation/create-story/checklist.md:207-212`).

✓ PASS — LLM Optimization Improvements  
Evidence: Addressed in “Recommendations” section below (per checklist `_bmad/bmm/workflows/4-implementation/create-story/checklist.md:213-218`).

---

## Failed Items
- ✗ API contract violations: `POST /links:batch` is not aligned with existing `/api/data-assets/...` routes, and current batch endpoint returns assets only (no `linkType`) (`docs/sprint-artifacts/9-8-node-view-merge.md:126-132`; `apps/web/features/data-library/api/data-assets.ts:278-300`; `apps/api/src/modules/data-management/data-asset.controller.ts:329-338`).

## Partial Items
- Missing selection model: need explicit `activeNodeId` vs `selectedNodeIds` rules for breadcrumb/provenance (`docs/sprint-artifacts/9-8-node-view-merge.md:39-56`).
- Sibling order implementation not pinned to `NodeData.order` (risk of sorting-by-label like current hooks) (`docs/sprint-artifacts/9-8-node-view-merge.md:33-37`; `packages/types/src/index.ts:2-14`; `apps/web/features/data-library/hooks/usePbsNodes.ts:94-109`).
- Tab merge regression surface not enumerated: update `useContextAwareUpload` + existing unit tests (`docs/sprint-artifacts/9-8-node-view-merge.md:105-109`; `apps/web/features/data-library/hooks/useContextAwareUpload.ts:55-93`; `apps/web/__tests__/features/data-library/useContextAwareUpload.test.ts:43-80`).
- Missing localStorage migration note for stored orgView values (`apps/web/features/data-library/components/OrganizationTabs.tsx:102-117`).
- Dual search integration unclear vs existing toolbar search (risk of duplicated state) (`docs/sprint-artifacts/9-8-node-view-merge.md:143-150`; `apps/web/features/data-library/components/data-library-drawer/DataLibraryDrawerToolbar.tsx:86-122`).
- Existing E2E “organization views” test will break and is not called out (`apps/web/e2e/data-library-views.spec.ts:115-129`).
- Undo toast feasibility not grounded in current UI primitives (`docs/sprint-artifacts/9-8-node-view-merge.md:272-283`; `packages/ui/src/toast.tsx:74-82`).

## Recommendations
1. Must Fix:
   - Fix the batch links API contract: either add a new endpoint under the existing namespace (e.g., `POST /api/data-assets/links:detailByNodes`) returning `links: NodeDataLinkWithAsset[]`, or extend `links:byNodes` with a non-breaking “includeLinkDetails” option; ensure it supports provenance (nodeId + linkType + asset).
   - Define node selection semantics: introduce explicit concepts like `activeNodeId` (drives breadcrumb) and `selectedNodeIds` (drives union/provenance) and specify how clicks/checkboxes affect both.
   - Preserve original sibling order using `NodeData.order` as primary sort (fallback to label only when missing) to satisfy AC2’s “同级顺序”.
   - Call out required migrations/updates: orgView localStorage migration (`pbs/task` → `node`), update `useContextAwareUpload` behavior for merged node view, and update existing unit + Playwright tests that assert PBS/Task tabs.
2. Should Improve:
   - Clarify breadcrumb click behavior for hidden nodes (DATA/ORDINARY): whether it selects the canvas node, scrolls tree to nearest semantic descendant, or is non-clickable for hidden nodes.
   - Clarify “Dual Search” integration with existing toolbar search to avoid duplicated search state (keep one source of truth for asset search).
   - Add explicit file pointers for core touchpoints: `DataLibraryDrawerContent.tsx`, `DataLibraryDrawerToolbar.tsx`, `useContextAwareUpload.ts`, and backend `data-asset.controller.ts`.
3. Consider:
   - Re-evaluate Undo Toast complexity: simplest path is “unlink immediately + undo by re-link (create link)” or adopt a single toast system that supports actions.
   - Reduce story token weight by moving long test snippets into the tech spec and keeping only key assertions + file paths in the story.
   - Add optional virtualization for large projected trees / long asset lists if performance becomes an issue.

