# Story 4.5: æ™ºèƒ½é€šçŸ¥ä¸­å¿ƒ (Smart Notification Center)

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

Story Key (sprint-status.yaml): `4-5-smart-notification-center`  
Epic Reference (docs/epics.md): Story 4.2 (Smart Notification Center)  
Note: `docs/epics.md` story numbering differs from sprint artifacts (sprint includes `4-2-rich-node-design`). Treat this file as the implementation source of truth for â€œSmart Notification Centerâ€.

## Story

As a **ç”¨æˆ· (User)**,
I want **æ¥æ”¶é‡è¦æ¶ˆæ¯çš„é€šçŸ¥ï¼Œä½†ç³»ç»Ÿèƒ½è‡ªåŠ¨è¿‡æ»¤å™ªéŸ³ (receive important notifications while the system automatically filters noise)**,
so that **æˆ‘èƒ½å…³æ³¨é‡è¦äº‹é¡¹ï¼Œé¿å…ä¿¡æ¯è¿‡è½½ (I can focus on important matters and avoid information overload).**

## Acceptance Criteria

1. **Given** ç³»ç»Ÿä¸­çŸ­æ—¶é—´å†…å‘ç”Ÿäº†å¤§é‡å˜æ›´æ“ä½œï¼ˆå¦‚æ‰¹é‡ä¿®æ”¹ï¼‰
   * **When** ç³»ç»Ÿç”Ÿæˆé€šçŸ¥æ—¶
   * **Then** é’ˆå¯¹åŒä¸€å¯¹è±¡çš„åŒç±»äº‹ä»¶åº”åœ¨ 5 åˆ†é’Ÿçª—å£å†…è¿›è¡Œå»é‡å’Œæ±‡æ€»ï¼ˆä¾‹å¦‚æ˜¾ç¤ºä¸º"å¼ ä¸‰ä¿®æ”¹äº† 5 ä¸ªèŠ‚ç‚¹"ï¼‰

2. **When** æ”¶åˆ° `@æåŠ` æˆ– `å®¡æ‰¹è¯·æ±‚` ç­‰é«˜ä¼˜å…ˆçº§äº‹ä»¶æ—¶
   * **Then** åº”ç»•è¿‡èŠ‚æµæœºåˆ¶ï¼Œé€šè¿‡å®æ—¶é€šé“ç«‹å³é€è¾¾

3. **And** é€šçŸ¥ä¸­å¿ƒåº”æ¸…æ™°åŒºåˆ†"æœªè¯»"å’Œ"å·²è¯»"çŠ¶æ€ï¼Œæ”¯æŒä¸€é”®æ ‡ä¸ºå·²è¯»

## Tasks / Subtasks

### Task 1: Shared Types - Priority + Query Contract (AC: 3)

- [x] Update shared notification types (`packages/types/src/notification-types.ts`)
    - Verify `NotificationType` already covers: `TASK_*`, `APPROVAL_*`, `MENTION`, `WATCH_UPDATE`
    - Add `NotificationPriority`: `HIGH | NORMAL | LOW`
    - Add `getNotificationPriority(type: NotificationType): NotificationPriority` (shared mapping)
    - Extend `NotificationListQuery` to support optional: `page`, `limit`, `unreadOnly`, `priority` (keep existing `isRead` for backward-compat)
    - Add `priority?: NotificationPriority` to `Notification` as a **computed** API field (do not add a Prisma column for this story)

### Task 2: Backend - Notification REST API (AC: 3)

- [x] Preserve existing endpoints already consumed by the web app:
    - `GET /api/notifications` (returns `Notification[]`)
    - `GET /api/notifications/unread-count` (returns `{ count }`)
    - `PATCH /api/notifications/:id:markRead`
    - `PATCH /api/notifications/markAllRead`
- [x] Extend `GET /api/notifications` (`apps/api/src/modules/notification/notification.controller.ts`)
    - Support query params: `page`, `limit`, `unreadOnly`, `priority` (plus existing `isRead`)
    - Default `limit` stays at 50 when not specified (maintain current behavior)
    - Populate computed `priority` in the response using `getNotificationPriority(notification.type)`
- [x] (Optional but recommended) Add `GET /api/notifications/count` returning:
    - `{ total, high, normal, low }` derived from `Notification.type` sets (no DB column)
- [x] Update repository/service accordingly:
    - `apps/api/src/modules/notification/notification.repository.ts` (add `findPaginated`, `countByPriority`)
    - `apps/api/src/modules/notification/notification.service.ts` (map priority + orchestration)

### Task 3: Backend - 5-Minute Noise Aggregation (AC: 1, 2)

- [x] Reuse WATCH_UPDATE throttling implementation in:
    - `apps/api/src/modules/subscriptions/subscription.listener.ts`
- [x] Align WATCH_UPDATE behavior with AC#1:
    - Production window: **5 minutes** (configurable via `NOTIFICATION_THROTTLE_MS`; tests/dev can override to shorter)
    - Debounce within the window and emit **one** summarized notification per `recipientId + mindmapId`
    - Cap buffered unique node names to avoid memory blowups (keep total counts even when capped)
    - Summary templates (examples):
      - Single actor known: `"{actorName} ä¿®æ”¹äº† {nodeCount} ä¸ªèŠ‚ç‚¹"`
      - Multiple/unknown actors: `"å¤šäººä¿®æ”¹äº† {nodeCount} ä¸ªèŠ‚ç‚¹"`
- [x] AC#2 "bypass throttling":
    - Ensure `MENTION` + `APPROVAL_REQUESTED` (and other approval results) remain immediate via `NotificationService.createAndNotify()` (generated by plugin services; must never enter WATCH_UPDATE throttle path)

### Task 4: Frontend - Smart Notification Center UX (AC: 3)

- [x] Enhance existing notification UI (avoid creating parallel `NotificationCenter` / extra hooks):
    - `apps/web/components/notifications/NotificationList.tsx`
      - Add filter tabs: `å…¨éƒ¨ | é«˜ä¼˜å…ˆçº§ | æœªè¯»` (client-side filter with `getNotificationPriority` + `isRead`)
      - Group by time buckets: `ä»Šå¤© / æ˜¨å¤© / æ›´æ—©` (use `date-fns`, already installed)
      - High-priority styling: red urgency indicator; WATCH_UPDATE uses amber; keep task/approval readable and distinct
    - `apps/web/hooks/useNotifications.ts`
      - Support optional filters by passing query params to `/api/notifications`
      - On `notification:new` socket event: if HIGH priority, trigger toast via `sonner` (already used elsewhere in the app)
    - `apps/web/components/notifications/NotificationBell.tsx`
      - Add subtle pulse/shake when a HIGH notification arrives (persist until user opens the panel or marks all read)

### Task 5: Tests / Verification

- [x] Backend (Jest)
    - Extend throttling tests to validate debounce aggregation + configurable throttle window:
      - `apps/api/src/modules/subscriptions/__tests__/subscription.listener.spec.ts`
    - Add tests for new filters and `/count` (if implemented):
      - `apps/api/src/modules/notification/__tests__/notification.service.spec.ts` (or add a controller spec under `apps/api/src/modules/notification/__tests__/`)
- [x] Frontend (Vitest)
    - Add a component test for filtering/grouping rendering:
      - `apps/web/__tests__/components/notifications/NotificationList.test.tsx` (new)
    - Add a hook test for HIGH toast trigger:
      - `apps/web/__tests__/hooks/useNotifications.test.ts` (new)
- [x] E2E (Playwright)
    - Added `apps/web/e2e/notification-center.spec.ts` with 18 test cases covering:
      - Filter tabs (å…¨éƒ¨ | é«˜ä¼˜å…ˆçº§ | æœªè¯») - TC-4.5.01, TC-4.5.02
      - Empty state and header actions - TC-4.5.03, TC-4.5.04, TC-4.5.05
      - API endpoints (list, count, unread-count, markAllRead) - TC-4.5.06 to TC-4.5.12
      - Integration tests (mark all read, priority filter, unread filter) - TC-4.5.13 to TC-4.5.15
      - Error handling (invalid params) - TC-4.5.16 to TC-4.5.18
    - Mention/approval "immediate delivery" is already covered by their stories

### Review Follow-ups (AI)

- [x] [AI-Review][HIGH] CRITICAL: Task 3 æ ‡è®° [x] ä½† AC#1 æœªè¾¾æ ‡ï¼ˆçª—å£å†…ä»ä¼šå‘å¤šæ¡/æ—  actor æ±‡æ€»ï¼‰ [apps/api/src/modules/subscriptions/subscription.listener.ts:207]
- [x] [AI-Review][HIGH] AC#1 â€œdebounce within window, emit oneâ€ æœªå®ç°ï¼ˆå½“å‰æ˜¯çª—å£èµ·å§‹ç«‹åˆ»å‘ + çª—å£ç»“æŸå†å‘ï¼‰ [apps/api/src/modules/subscriptions/subscription.listener.ts:207]
- [x] [AI-Review][HIGH] AC#1 æ±‡æ€»æ¨¡æ¿ç¼º actorName/actor ç»Ÿè®¡ï¼Œæ— æ³•äº§å‡º â€œ{actorName} ä¿®æ”¹äº† {nodeCount} ä¸ªèŠ‚ç‚¹â€ [apps/api/src/modules/subscriptions/subscription.listener.ts:270]
- [x] [AI-Review][HIGH] Story Status ä¸ sprint-status ä¸ä¸€è‡´ï¼ˆStory ä» in-progressï¼Œä½† sprint-status å·² doneï¼‰ [docs/sprint-artifacts/4-5-smart-notification-center.md:3]
- [x] [AI-Review][HIGH] Story File List/Test è®¡åˆ’ä¸ git ç°å®ä¸ä¸€è‡´ï¼ˆç¼ºå¤±/è·¯å¾„é”™è¯¯/æœªæ‰©å±•ï¼‰ [docs/sprint-artifacts/4-5-smart-notification-center.md:350]
- [x] [AI-Review][MEDIUM] æ±‡æ€»è®¡æ•°åœ¨ cap åœºæ™¯å¯èƒ½å¤±çœŸï¼ˆmessage ç”¨ changedNodeNames.length è€Œéæ€»å˜æ›´æ•°ï¼‰ [apps/api/src/modules/subscriptions/subscription.listener.ts:284]
- [x] [AI-Review][MEDIUM] WATCH_UPDATE çš„ nodeId/refNodeId å¯èƒ½ä¸ºç©ºï¼Œå¯¼è‡´é€šçŸ¥é¢æ¿æ— æ³•å¯¼èˆª/å–æ¶ˆå…³æ³¨ [apps/api/src/modules/subscriptions/subscription.listener.ts:299]
- [x] [AI-Review][MEDIUM] `GET /api/notifications` åˆ†é¡µå‚æ•°ç¼ºè¾¹ç•Œæ ¡éªŒï¼ˆpage/limit å¯ä¸ºè´Ÿæˆ–æ— é™å¤§ï¼‰ [apps/api/src/modules/notification/notification.controller.ts:47]
- [x] [AI-Review][MEDIUM] æ–°å¢ NotificationList ç»„ä»¶æµ‹è¯•ç±»å‹ä¸åˆæ³•ï¼ˆNotificationContent ç¼ºå¿…å¡«å­—æ®µï¼‰ [apps/web/__tests__/components/notifications/NotificationList.test.tsx:24]
- [x] [AI-Review][LOW] `animate-[swing_...]` æœªå®šä¹‰ keyframesï¼ŒåŠ¨ç”»å¯èƒ½æ— æ•ˆ [apps/web/components/notifications/NotificationBell.tsx:80]

---

## Technical Specification

### 1. Data Model (Prisma)

**Notification æ¨¡å‹å·²å­˜åœ¨** (`packages/database/prisma/schema.prisma`) å¹¶åŒ…å«èšåˆæ”¯æŒå­—æ®µï¼ˆStory 4.4ï¼‰ï¼š

```prisma
model Notification {
  id          String   @id @default(cuid())
  recipientId String
  recipient   User     @relation(fields: [recipientId], references: [id])

  type      String
  title     String
  content   Json
  refNodeId String?
  isRead    Boolean  @default(false)

  // Aggregation fields (Story 4.4)
  groupKey         String?
  batchCount       Int       @default(1)
  lastAggregatedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
```

- æœ¬ Story **ä¸è¦æ±‚æ–°å¢ `priority` æ•°æ®åº“å­—æ®µ**ï¼›ä¼˜å…ˆçº§ä» `Notification.type` è®¡ç®—ï¼ˆshared mapping: `getNotificationPriority`ï¼‰ã€‚
- WATCH_UPDATE çš„â€œå»é‡/æ±‡æ€»â€å¯é€‰ä½¿ç”¨ `groupKey/batchCount/lastAggregatedAt`ï¼ˆæ— éœ€è¿ç§»ï¼‰ã€‚

### 2. API è®¾è®¡ï¼ˆä¿æŒç°æœ‰å¥‘çº¦ + å…¼å®¹æ‰©å±•ï¼‰

> æ³¨æ„ï¼šWeb ç«¯å½“å‰ `useNotifications` é»˜è®¤æœŸæœ› `GET /api/notifications` è¿”å› `Notification[]`ï¼ˆæ•°ç»„ï¼‰ã€‚

```bash
# é€šçŸ¥åˆ—è¡¨ï¼ˆå…¼å®¹ç°æœ‰ + æ–°å¢è¿‡æ»¤ï¼‰
GET /api/notifications?userId=test1
GET /api/notifications?userId=test1&isRead=false
GET /api/notifications?userId=test1&unreadOnly=true&priority=HIGH&page=1&limit=50

# æœªè¯»è®¡æ•°ï¼ˆç°æœ‰ï¼‰
GET /api/notifications/unread-count?userId=test1

# æ ‡è®°å·²è¯»ï¼ˆç°æœ‰ï¼‰
PATCH /api/notifications/:id:markRead
PATCH /api/notifications/markAllRead?userId=test1

# ï¼ˆå¯é€‰ï¼‰ä¼˜å…ˆçº§åˆ†æ¡¶è®¡æ•°
GET /api/notifications/count?userId=test1
```

### 3. å»é‡/æ±‡æ€»ç®—æ³•ï¼ˆWATCH_UPDATEï¼ŒAC#1ï¼‰

ç›®æ ‡ï¼šåœ¨ **5 åˆ†é’Ÿçª—å£** å†…æŠŠå¤§é‡å˜æ›´â€œé™å™ªâ€ä¸º **1 æ¡æ±‡æ€»é€šçŸ¥**ã€‚

- ä»…å¯¹ä½ä¼˜å…ˆçº§å™ªéŸ³æºï¼š`WATCH_UPDATE`ï¼ˆè®¢é˜…å˜æ›´ï¼‰ã€‚
- é«˜ä¼˜å…ˆçº§ï¼ˆä¾‹å¦‚ `MENTION`ã€`APPROVAL_REQUESTED`ï¼‰å¿…é¡»å®æ—¶é€è¾¾ï¼Œä¸è¿›å…¥ WATCH_UPDATE çš„èŠ‚æµè·¯å¾„ï¼ˆAC#2ï¼‰ã€‚

å»ºè®®å®ç°ï¼ˆDebounce èšåˆï¼Œä¼ªä»£ç ï¼‰ï¼š

```ts
// key = `${recipientId}:${mindmapId}`
buffer[key].nodeNames.add(nodeName)
buffer[key].actorIds.add(userId) // optional
buffer[key].count++

if (!timer[key]) {
  timer[key] = setTimeout(() => flush(key), THROTTLE_WINDOW_MS)
}

flush(key):
  message = formatSummary(buffer[key]) // "å¼ ä¸‰ä¿®æ”¹äº† 5 ä¸ªèŠ‚ç‚¹" / "å¤šäººä¿®æ”¹äº† 5 ä¸ªèŠ‚ç‚¹"
  NotificationService.createAndNotify({ type: 'WATCH_UPDATE', title: ..., content: ... })
  clear buffer + timer
```

å®ç°è¦ç‚¹ï¼š

- `THROTTLE_WINDOW_MS`ï¼šç”Ÿäº§é»˜è®¤ `5 * 60 * 1000`ï¼Œå…è®¸ç”¨ `NOTIFICATION_THROTTLE_MS` è¦†ç›–ï¼ˆdev/tests ç”¨çŸ­çª—å£ï¼‰ã€‚
- `MAX_CHANGED_NODES`ï¼šé™åˆ¶ç¼“å­˜çš„ `nodeNames` æ•°é‡ï¼ˆé¿å…å†…å­˜çˆ†ç‚¸ï¼‰ï¼Œä½† `count` ä»ä¿æŒçœŸå®æ€»æ•°ã€‚

### 4. å‰ç«¯è¡Œä¸ºï¼ˆAC#3ï¼‰

- Socket äº‹ä»¶åï¼š`notification:new`ï¼ˆä¿æŒç°çŠ¶ï¼‰ã€‚
- è¿‡æ»¤/åˆ†ç»„ï¼š
  - `priority = getNotificationPriority(notification.type)`ï¼ˆè‹¥ API æœªè¿”å› `priority`ï¼Œå‰ç«¯å¯ fallback è®¡ç®—ï¼‰ã€‚
  - Tabsï¼š`å…¨éƒ¨ | é«˜ä¼˜å…ˆçº§ | æœªè¯»`
  - æ—¶é—´åˆ†ç»„ï¼š`ä»Šå¤© / æ˜¨å¤© / æ›´æ—©`ï¼ˆç”¨ `date-fns`ï¼‰ã€‚
- é«˜ä¼˜å…ˆçº§ Toastï¼š
  - åœ¨ `useNotifications` æ”¶åˆ° HIGH äº‹ä»¶æ—¶ç”¨ `sonner` å¼¹å‡º Toastï¼ˆæ— éœ€å¼•å…¥æ–°ä¾èµ–ï¼‰ã€‚

---

## Dev Notes

### æ¶æ„åˆè§„æ€§ / å¤ç”¨ä¼˜å…ˆ

- **Kernel é€šçŸ¥åŸºç¡€è®¾æ–½ï¼ˆå·²å­˜åœ¨ï¼‰**:
  - `apps/api/src/modules/notification/notification.service.ts`: å†™åº“ + WebSocket æ¨é€ `notification:new`
  - `apps/api/src/modules/notification/notification.gateway.ts`: Socket.io namespace `/notifications` + user room (`join`)
  - `apps/api/src/modules/notification/notification.controller.ts`: REST endpointsï¼ˆWeb ç«¯å·²åœ¨ä½¿ç”¨ï¼‰
- **æ’ä»¶ä¾§ä¼šäº§ç”Ÿé€šçŸ¥ï¼ˆä¸è¦é‡å¤é€ è½®å­ï¼‰**:
  - `packages/plugins/plugin-comments/src/server/comments/comments.service.ts` â†’ `MENTION`
  - `packages/plugins/plugin-workflow-approval/src/server/approval/approval.listener.ts` â†’ `APPROVAL_*`
  - `packages/plugins/plugin-mindmap-core/src/server/nodes/services/task.service.ts` â†’ `TASK_*`
- **WATCH_UPDATE çš„èŠ‚æµ/æ±‡æ€»åœ¨è®¢é˜…æ¨¡å—**:
  - `apps/api/src/modules/subscriptions/subscription.listener.ts`

### å…³é”®çº¦æŸï¼ˆé¿å…è¸©å‘ï¼‰

- **äº‹ä»¶åå¿…é¡»ä¿æŒä¸€è‡´**ï¼šå®¢æˆ·ç«¯ç›‘å¬ `notification:new`ï¼ˆä¸æ˜¯ `notification.new`ï¼‰ã€‚
- **REST å¥‘çº¦å¿…é¡»å…¼å®¹**ï¼š`apps/web/hooks/useNotifications.ts` ä¾èµ– `/api/notifications` è¿”å› `Notification[]`ã€‚
- **ä¸æ–°å¢ Prisma å­—æ®µ**ï¼š`priority` ç”¨ `type` è®¡ç®—ï¼ˆshared mappingï¼‰ï¼Œé¿å…è¿ç§»ä¸æ•°æ®å›å¡«ã€‚
- **Next.js å·²ä»£ç† /api**ï¼šè§ `apps/web/next.config.ts`ï¼Œå‰ç«¯ `fetch('/api/...')` ä¼šè¢« rewrite åˆ° `NEXT_PUBLIC_API_BASE_URL`ã€‚

### Project Structure Notesï¼ˆå»ºè®®æ”¹åŠ¨èŒƒå›´ï¼‰

**åç«¯ï¼ˆä¼˜å…ˆä¿®æ”¹æ—¢æœ‰æ–‡ä»¶ï¼‰**

- `apps/api/src/modules/notification/notification.controller.ts`
- `apps/api/src/modules/notification/notification.repository.ts`
- `apps/api/src/modules/notification/notification.service.ts`
- `apps/api/src/modules/subscriptions/subscription.listener.ts`
- `packages/types/src/notification-types.ts`

**å‰ç«¯ï¼ˆå¢å¼ºæ—¢æœ‰é€šçŸ¥ä½“éªŒï¼‰**

- `apps/web/hooks/useNotifications.ts`
- `apps/web/components/notifications/NotificationBell.tsx`
- `apps/web/components/notifications/NotificationList.tsx`

### References

- [Source: docs/epics.md#Epic-4] - Story 4.2 åŸå§‹éœ€æ±‚å®šä¹‰
- [Source: docs/architecture.md#4-äº‹ä»¶é©±åŠ¨æ¶æ„] - äº‹ä»¶é©±åŠ¨æ¨¡å¼å‚è€ƒ
- [Source: apps/api/src/modules/notification/] - Kernel é€šçŸ¥æ¨¡å—
- [Source: apps/api/src/modules/subscriptions/subscription.listener.ts] - WATCH_UPDATE æ±‡æ€»å®ç°

---

## Test Design

### Risk Assessment

| Risk ID | Category | Description | Probability | Impact | Score | Mitigation |
|---------|----------|-------------|-------------|--------|-------|------------|
| R-001 | PERF | **é€šçŸ¥é£æš´**: æ‰¹é‡æ“ä½œäº§ç”Ÿå¤§é‡é€šçŸ¥å¯¼è‡´ç³»ç»Ÿè¿‡è½½ | High | High | **Critical** | èŠ‚æµæœºåˆ¶ + ç¼“å†²é™åˆ¶ (MAX_BUFFER_SIZE) |
| R-002 | UX | **é«˜ä¼˜å»¶è¿Ÿ**: é«˜ä¼˜å…ˆçº§é€šçŸ¥è¢«é”™è¯¯èŠ‚æµ | Medium | High | **High** | ä¼˜å…ˆçº§æ£€æŸ¥åœ¨èŠ‚æµå‰æ‰§è¡Œ |
| R-003 | DATA | **æœªè¯»è®¡æ•°ä¸ä¸€è‡´**: å¤šè®¾å¤‡é—´æœªè¯»çŠ¶æ€ä¸åŒæ­¥ | Medium | Medium | **Medium** | Socket å¹¿æ’­ + polling åˆ·æ–°ï¼ˆ`useNotifications` fallbackï¼‰ |
| R-004 | MEM | **å†…å­˜æ³„æ¼**: èŠ‚æµ Timer æœªæ¸…ç† | Low | High | **Medium** | OnModuleDestroy æ¸…ç† |

### Test Coverage Plan

#### P0 (Critical) - æ¯æ¬¡æäº¤è¿è¡Œ

| éœ€æ±‚ | æµ‹è¯•çº§åˆ« | é£é™©é“¾æ¥ | æµ‹è¯•æ•° | å¤‡æ³¨ |
|------|---------|---------|--------|------|
| **èŠ‚æµé€»è¾‘** | Unit | R-001 | 4 | 5 åˆ†é’Ÿçª—å£æ±‡æ€»ã€äº‹ä»¶è®¡æ•°ã€æ±‡æ€»æ¶ˆæ¯æ ¼å¼ |
| **ä¼˜å…ˆçº§ç»•è¿‡** | Unit | R-002 | 2 | HIGH ä¼˜å…ˆçº§ç«‹å³å‘é€ã€ä¸è¿›å…¥ç¼“å†² |
| **API ç«¯ç‚¹** | Integration | - | 5 | GET list(filters), GET unread-count, (opt) GET count, PATCH markRead, PATCH markAllRead |

#### P1 (High) - PR æ—¶è¿è¡Œ

| éœ€æ±‚ | æµ‹è¯•çº§åˆ« | æµ‹è¯•æ•° | å¤‡æ³¨ |
|------|---------|--------|------|
| **å®æ—¶æ¨é€** | E2E | 2 | Socket æ¥æ”¶é€šçŸ¥ã€æ›´æ–° UI |
| **æœªè¯»çŠ¶æ€** | E2E | 2 | æ ‡è®°å·²è¯»åŒæ­¥ã€å…¨éƒ¨å·²è¯» |
| **UI äº¤äº’** | Component | 3 | é€šçŸ¥é¡¹ç‚¹å‡»ã€hoverã€badgeã€ç­›é€‰ tabs |

### Quality Gate Criteria

- [ ] **Performance**: èŠ‚æµåé€šçŸ¥æ•°é‡å‡å°‘ 80%+
- [ ] **Reliability**: é«˜ä¼˜å…ˆçº§é€šçŸ¥å»¶è¿Ÿ < 500ms
- [ ] **Code Coverage**: Service å±‚ > 85%

---

## UI/UX Design

### 1. é€šçŸ¥ä¸­å¿ƒå¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”” é€šçŸ¥ä¸­å¿ƒ            [å…¨éƒ¨å·²è¯»] [X] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [å…¨éƒ¨] [é«˜ä¼˜å…ˆçº§] [æœªè¯»]              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä»Šå¤©                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ ğŸ”´ @å¼ ä¸‰ æåˆ°äº†ä½               â”‚   â”‚
â”‚ â”‚    "è¯·çœ‹ä¸€ä¸‹è¿™ä¸ªèŠ‚ç‚¹çš„è®¾è®¡..."  â”‚   â”‚
â”‚ â”‚    2 åˆ†é’Ÿå‰                â— â”€â”¤   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ ğŸ”µ ä»»åŠ¡å·²æ¥æ”¶                   â”‚   â”‚
â”‚ â”‚    æå››æ¥æ”¶äº† "åç«¯APIå¼€å‘"     â”‚   â”‚
â”‚ â”‚    15 åˆ†é’Ÿå‰                    â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚ æ˜¨å¤©                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ ğŸŸ¡ å…³æ³¨å†…å®¹æ›´æ–°                 â”‚   â”‚
â”‚ â”‚    "äº§å“è®¾è®¡" ç­‰ 3 ä¸ªèŠ‚ç‚¹æœ‰æ›´æ–° â”‚   â”‚
â”‚ â”‚    æ˜¨å¤© 18:30                   â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. é€šçŸ¥ Badge åŠ¨ç”»

- **æ™®é€šé€šçŸ¥**: æ•°å­—æ¸å˜æ˜¾ç¤º
- **é«˜ä¼˜å…ˆçº§**: `animate-pulse` + é“ƒé“›è½»å¾®æ™ƒåŠ¨
- **ç©ºçŠ¶æ€**: ç°è‰²é“ƒé“›ï¼Œæ—  badge

### 3. Toast é€šçŸ¥ (é«˜ä¼˜å…ˆçº§)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”´ @å¼ ä¸‰ æåˆ°äº†ä½                â”‚
â”‚ "è¯·çœ‹ä¸€ä¸‹è¿™ä¸ªèŠ‚ç‚¹..."           â”‚
â”‚                    [æŸ¥çœ‹] [å¿½ç•¥] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- è‡ªåŠ¨ 5 ç§’åæ¶ˆå¤±
- ç‚¹å‡»"æŸ¥çœ‹"è·³è½¬åˆ°ç›¸å…³èŠ‚ç‚¹
- ç‚¹å‡»"å¿½ç•¥"ç«‹å³å…³é—­

---

## UI Prototypes

High fidelity mockups have been verified to guide the implementation.

### 1. Notification Center Panel
**Visual Spec**:
- **Glassmorphism**: Backdrop blur with white/translucent background (`backdrop-blur-md bg-background/95`).
- **Tabs**: Segmented control for "All", "High Priority" (with Red dot indicator), "Unread".
- **List Styling**:
  - **High Priority**: Red/Pink subtle background `bg-red-50/50`, distinct border or indicator.
  - **Grouped**: Amber background `bg-amber-50/50` for consolidated updates.
  - **Standard**: Clean white/gray background with hover effects.

### 2. High Priority Toast
**Visual Spec**:
- **Position**: Top-right floating overlay (`z-50`).
- **Style**: Glassmorphism with `border-l-4 border-red-500` urgency indicator.
- **Actions**: Direct "View" (Primary) and "Dismiss" (Ghost) buttons.
- **Animation**: Slide-in from right with spring physics.

### 3. Navigation Bell
**Visual Spec**:
- **Badge**: Red circular badge with count, positioned top-right.
- **Animation**: `animate-pulse` or `animate-swing` effect when `High Priority` notifications arrive.
- **State**: Persistent indicator until all notifications are read.

## Dev Agent Record

### Agent Model Used

GPT-5.2 (Codex CLI)

### Debug Log References

### Completion Notes List

- å®ç° WATCH_UPDATE å»å™ªæ±‡æ€»ï¼šæŒ‰ `recipientId + mindmapId` åš debounceï¼Œä»…å‘ 1 æ¡æ±‡æ€»é€šçŸ¥ï¼ˆæ”¯æŒ actorName/å¤šäººæ¨¡æ¿ã€æ€»æ•°ä¿çœŸã€cap é˜²çˆ†ï¼‰
- æ‰©å±•é€šçŸ¥ REST APIï¼šæ”¯æŒåˆ†é¡µ/è¿‡æ»¤ï¼ˆ`page/limit/unreadOnly/priority`ï¼‰ä¸ `/count` è®¡æ•°æ¥å£ï¼Œå¹¶è¡¥é½è¾“å…¥æ ¡éªŒ
- å‰ç«¯é€šçŸ¥ä¸­å¿ƒå¢å¼ºï¼štabs è¿‡æ»¤ã€æŒ‰æ—¶é—´åˆ†ç»„ã€æŒ‰ä¼˜å…ˆçº§æ ·å¼ã€HIGH toastã€é“ƒé“›é«˜ä¼˜æé†’åŠ¨ç”»è”åŠ¨
- è¡¥é½å•æµ‹ï¼šAPI/serviceã€SubscriptionListenerã€types ä¸ web ç»„ä»¶/Hook

### File List

**åç«¯ï¼ˆKernel + Subscription èšåˆï¼‰**

- `apps/api/src/modules/notification/notification.controller.ts`
- `apps/api/src/modules/notification/notification.repository.ts`
- `apps/api/src/modules/notification/notification.service.ts`
- `apps/api/src/modules/subscriptions/subscription.listener.ts`
- `apps/api/src/modules/subscriptions/__tests__/subscription.listener.spec.ts`
- `apps/api/src/modules/notification/__tests__/notification.service.spec.ts`

**å…±äº«ç±»å‹**

- `packages/types/src/notification-types.ts` - æ·»åŠ  `NotificationPriority` + `getNotificationPriority`
- `packages/types/__tests__/notification-types.test.ts`
- `packages/config/tailwind.config.ts`

**å‰ç«¯ï¼ˆå¢å¼ºæ—¢æœ‰é€šçŸ¥ä½“éªŒï¼‰**

- `apps/web/components/layout/TopBar.tsx`
- `apps/web/hooks/useNotifications.ts`
- `apps/web/components/notifications/NotificationBell.tsx`
- `apps/web/components/notifications/NotificationList.tsx`

**æµ‹è¯•ï¼ˆWebï¼‰**

- `apps/web/__tests__/components/notifications/NotificationList.test.tsx` (new)
- `apps/web/__tests__/hooks/useNotifications.test.ts` (new)

**æ–‡æ¡£**

- `docs/sprint-artifacts/4-5-smart-notification-center.md`
- `docs/sprint-artifacts/sprint-status.yaml`
- `docs/sprint-artifacts/validation-report-2026-01-01T144636.md`

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-01-01 | Implemented Story 4.5 (API filters + priority, debounce aggregation, UI tabs/grouping/styling, tests) | GPT-5.2 (Codex CLI) |
| 2026-01-01 | Resolved Review Follow-ups (AI) + synced sprint status | GPT-5.2 (Codex CLI) |
