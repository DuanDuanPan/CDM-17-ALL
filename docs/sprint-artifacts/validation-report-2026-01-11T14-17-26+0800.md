# Validation Report

**Document:** docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md  
**Checklist:** _bmad/bmm/workflows/4-implementation/create-story/checklist.md  
**Date:** 2026-01-11T14-17-26+0800  
**Agent Model:** GPT-5.2 (Codex CLI)

## Summary
- Overall: 43/80 passed (53.8%); Partial: 29; Fail: 1; N/A: 7
- Critical Issues: 1

## Section Results

### Critical Mistakes to Prevent
Pass Rate: 4/8 (50.0%)

✓ PASS — Reinventing wheels  
Evidence: Story明确要求扩展现有 `industrial-viewer` 并复用 Story 9.3 的 `ModelViewerModal` + `useOnline3DViewer` 模式（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:16-17,32,40-43`；`docs/sprint-artifacts/tech-spec-9-4-lightweight-viewer-mesh-contour.md:20-23,44-68`）。  
Impact: 降低重复造轮子与改错层的风险。

⚠ PARTIAL — Wrong libraries  
Evidence: Story/Tech-Spec 选择了 Online3DViewer + VTK.js（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:296-302,395-403`；`docs/sprint-artifacts/tech-spec-9-4-lightweight-viewer-mesh-contour.md:20-23,72-77`），但存在关键不一致/错误：  
- `online-3d-viewer` 版本：Story 写 `^0.12.x`（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:397-400`），实际为 `^0.18.0`（`apps/web/package.json:37-41`）。  
- 线框/实体：Tech-Spec 指向 `OV.ShadingType.Lines`（`docs/sprint-artifacts/tech-spec-9-4-lightweight-viewer-mesh-contour.md:308-310`），但当前 `online-3d-viewer` 的 `ShadingType` 仅有 `Phong/Physical`（`apps/web/node_modules/online-3d-viewer/build/engine/o3dv.module.d.ts:1348-1353`）。  
- VTK 包名/导入风格混用：依赖写 `vtk.js`（`docs/sprint-artifacts/tech-spec-9-4-lightweight-viewer-mesh-contour.md:235-241`），示例却从 `@kitware/vtk.js/...` 导入（`docs/sprint-artifacts/tech-spec-9-4-lightweight-viewer-mesh-contour.md:245-253`）。  
Impact: 高概率出现“按文档实现但 API 不存在/构建失败”的阻塞。

✓ PASS — Wrong file locations  
Evidence: Story 指定的落点与现有目录结构一致（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:150-191,356-383`），且关键既有集成点文件真实存在（`apps/web/features/industrial-viewer/components/ViewerToolbar.tsx:1-94`；`apps/web/features/data-library/components/DataLibraryDrawer.tsx:193-314`）。  
Impact: 降低在错误层/错误目录开发导致返工的风险。

⚠ PARTIAL — Breaking regressions  
Evidence: Story 有依赖说明 + 工程护栏（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:40-43,209-289`），但未显式强调“不得回归 Story 9.3 的现有预览行为/测试（尤其 ModelViewerModal/ViewerToolbar 的边线开关语义）”。现有 Drawer 仅挂载 `ModelViewerModal`（`apps/web/features/data-library/components/DataLibraryDrawer.tsx:193-314`），新增第二类 modal/previewType 若处理不当可能影响既有路径。  
Impact: 可能引入预览入口失效、toolbar 行为改变、E2E 回归等问题。

✓ PASS — Ignoring UX  
Evidence: UI 规范明确描述网格模式按钮、云图色条面板位置/样式与控件（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:79-106`）。  
Impact: UI 预期清晰，减少“做出来但不像”的返工。

⚠ PARTIAL — Vague implementations  
Evidence: 任务分解详细（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:109-207`），但两个关键点仍不够可执行：  
1) 线框/实体实现路径不正确/不明确（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:138-142`；`docs/sprint-artifacts/tech-spec-9-4-lightweight-viewer-mesh-contour.md:152-156,303-310`；`apps/web/node_modules/online-3d-viewer/build/engine/o3dv.module.d.ts:1348-1353`）。  
2) 云图格式（VTK/VTP/VTU/VTI）与现有 `DataAssetFormat` 枚举不匹配（`packages/database/prisma/schema.prisma:426-443`），但 Story 未给出“如何标识/判定云图资产以触发预览”的策略（仅提“识别 VTK/JSON 云图格式”）（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:184-191`）。  
Impact: Dev 可能在实现中被迫临时补设计（schema/extension 识别/preview gating），导致 scope 漂移或实现不一致。

✓ PASS — Lying about completion  
Evidence: Story 有明确 AC（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:46-76`）、测试要求（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:421-501`）、状态为 `ready-for-dev`（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:3`），Tech-Spec 也为 Ready（`docs/sprint-artifacts/tech-spec-9-4-lightweight-viewer-mesh-contour.md:4-5`）。  
Impact: 可验证闭环存在（AC + tests + data-testid）。

⚠ PARTIAL — Not learning from past work  
Evidence: Story 引用并复用 9.3（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:40-43,413-416`），但未显式复用既有 E2E harness/seed 模式（`apps/web/e2e/model-viewer.spec.ts:10-45`），且未提及需要同步更新列表视图预览路径（`apps/web/features/data-library/components/AssetList.tsx:38-53`）。  
Impact: 测试与 UI 行为容易在 Grid/List 之间出现不一致，且新 E2E 更可能偏离既有惯例而变脆。

---

### Step 1: Load and Understand the Target
Pass Rate: 6/6 (100.0%)

✓ PASS — Load the workflow configuration  
Evidence: Workflow 配置存在且定义了变量/校验入口（`_bmad/bmm/workflows/4-implementation/create-story/workflow.yaml:1-27`）。  

✓ PASS — Load the story file  
Evidence: Story 文件存在，包含 status + tech spec 链接（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:1-5`）。  

✓ PASS — Load validation framework  
Evidence: Validation framework 存在并定义输出格式（`_bmad/core/tasks/validate-workflow.xml:1-88`）。  

✓ PASS — Extract metadata (epic/story key/title)  
Evidence: 标题为 “Story 9.4 …”（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:1`）。  

✓ PASS — Resolve workflow variables  
Evidence: `output_folder`/`sprint_artifacts` 在 config 中分别指向 `docs/` 与 `docs/sprint-artifacts/`（`_bmad/bmm/config.yaml:8-14`；`_bmad/bmm/workflows/4-implementation/create-story/workflow.yaml:6-13`）。  

✓ PASS — Understand current status  
Evidence: Story 为 `ready-for-dev`，Tech-Spec 为 Ready（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:3`；`docs/sprint-artifacts/tech-spec-9-4-lightweight-viewer-mesh-contour.md:4-5`）。  

---

### Step 2.1: Epics and Stories Analysis
Pass Rate: 6/6 (100.0%)

✓ PASS — Load epics file  
Evidence: Epics 文件存在且包含 Epic 9（`docs/epics.md:1055-1063`）。  

✓ PASS — Epic objectives and business value  
Evidence: Epic 9 目标包含“数据资源库 + 工业格式在线预览（STEP/网格/云图）”（`docs/epics.md:1055-1058`）。  

✓ PASS — ALL stories in this epic (cross-story context)  
Evidence: Epic 9 枚举 9.1–9.6，并包含 9.4（`docs/epics.md:1059-1165`）。  

✓ PASS — Story requirements and acceptance criteria alignment  
Evidence: Epic 中 Story 9.4 的 AC 与当前 Story 的 AC1–AC5 一致（`docs/epics.md:1110-1125`；`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:46-76`）。  

✓ PASS — Technical requirements and constraints  
Evidence: Story 定义了 scope、护栏（Hook-first、300 行、SSR 禁用、UI 组件来源等）（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:20-43,209-289`）。  
Impact: 约束对实现路线与质量有直接约束力。

✓ PASS — Cross-story dependencies and prerequisites  
Evidence: Story 明确依赖 9.3 的 `industrial-viewer` 与 `ModelViewerModal` 框架（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:40-43,133-135`），且 Epic 9.3 在同一 Epic 中（`docs/epics.md:1095-1109`）。  

---

### Step 2.2: Architecture Deep-Dive
Pass Rate: 4/10 (40.0%)

✓ PASS — Load architecture file  
Evidence: Architecture 文档存在并定义工程规范（`docs/architecture.md:645-673`）。  

⚠ PARTIAL — Technical stack with versions  
Evidence: Story 给出依赖版本，但与 repo 不一致（Story 写 `online-3d-viewer ^0.12.x`）（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:395-403`），实际为 `^0.18.0`（`apps/web/package.json:37-41`）。VTK 仅写 `^30.x`（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:395-403`）且包名/导入风格混用（`docs/sprint-artifacts/tech-spec-9-4-lightweight-viewer-mesh-contour.md:235-253`）。  
Impact: 版本/API 假设错误会直接导致实现偏航或构建失败。

✓ PASS — Code structure and organization patterns  
Evidence: Story 的文件落点与仓库结构一致（`apps/web/features/...`）（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:150-207,356-383`），并指向真实集成点（`apps/web/features/data-library/components/DataLibraryDrawer.tsx:193-314`）。  

➖ N/A — API design patterns and contracts  
Evidence: Story 9.4 未新增 HTTP/WebSocket 合约；工作聚焦前端预览与本地渲染（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:20-39`）。  

⚠ PARTIAL — Database schemas and relationships  
Evidence: 现有 `DataAssetFormat` 不包含 VTK/VTP/VTU/VTI（`packages/database/prisma/schema.prisma:426-443`），但 Story 要求支持这些格式（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:24-29,60-64`），且当前预览 gating 基于 format 枚举（`apps/web/features/data-library/components/AssetCard.tsx:36-51`；`apps/web/features/data-library/components/AssetList.tsx:38-53`）。  
Impact: 若不明确“格式表示/识别策略”，云图预览入口可能无法触发或引入不合理的 schema 扩展。

➖ N/A — Security requirements and patterns  
Evidence: Story 未涉及鉴权/RBAC/敏感数据保护变更；属于本地前端渲染能力增强（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:20-39`）。  

⚠ PARTIAL — Performance requirements and optimization strategies  
Evidence: Story 仅将“大型网格分块加载”放入 out-of-scope（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:35-38`），Tech-Spec 提到 WebGL context/内存（`docs/sprint-artifacts/tech-spec-9-4-lightweight-viewer-mesh-contour.md:323-325`），但缺少明确的性能护栏（如：最大文件/点数建议、VTK pipeline 释放、避免重复 init）。  
Impact: 在真实仿真网格/云图数据上容易出现卡顿或内存泄漏导致崩溃。

✓ PASS — Testing standards and frameworks  
Evidence: Story 明确使用 Vitest + Playwright 并给出测试文件位置（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:192-206,421-501`；`apps/web/package.json:9-13`）。  

➖ N/A — Deployment and environment patterns  
Evidence: Story 不涉及部署/CI/CD 变更。  

✓ PASS — Integration patterns and external services  
Evidence: Story 复用 `ModelViewerModal` 框架并在 Data Library Drawer 集成懒加载 modal（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:32-33,188-191`；`apps/web/features/data-library/components/DataLibraryDrawer.tsx:193-314`）。  

---

### Step 2.3: Previous Story Intelligence
Pass Rate: 4/7 (57.1%)

✓ PASS — Load previous story file  
Evidence: Story 明确依赖 9.3，且引用前序 Story 文档（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:40-43,413-416`；`docs/sprint-artifacts/9-3-lightweight-viewer-step-gltf.md:1-6`）。  

✓ PASS — Dev notes and learnings  
Evidence: Story 复用 9.3 的 modal/hook 模式，并在 Dev Notes 给出 VTK 关键 API/JSON 格式（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:292-355`）。  

➖ N/A — Review feedback and corrections needed  
Evidence: 当前未看到与本 Story 直接相关的 “review feedback/impact analysis” 产物被引用或要求遵循。  

✓ PASS — Files created/modified and their patterns  
Evidence: Story 给出明确文件落点与新建/修改清单（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:150-207,356-383`）。  

⚠ PARTIAL — Testing approaches that worked/didn’t work  
Evidence: 既有 9.3 E2E 使用 `createTestGraph/makeTestGraphUrl` 并通过点击标题打开 Drawer（`apps/web/e2e/model-viewer.spec.ts:10-45`），但 Story 9.4 的示例 E2E 采用 `Meta+d` 与假设的选择器/属性（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:423-468`）。  
Impact: 新测试更可能偏离既有 suite 习惯与选择器稳定性，导致 flake/维护成本上升。

⚠ PARTIAL — Problems encountered and solutions found  
Evidence: 现有 `useOnline3DViewer.ts` 已包含复杂的 PBR/环境逻辑（`apps/web/features/industrial-viewer/hooks/useOnline3DViewer.ts:158-214`），但 Story/Tech-Spec 的“线框/实体”方案基于不存在的 `ShadingType.Lines`（`docs/sprint-artifacts/tech-spec-9-4-lightweight-viewer-mesh-contour.md:308-310`）。  
Impact: 开发会在实现阶段重新发现并纠正关键 API 误解（阻塞/返工）。

✓ PASS — Code patterns and conventions established  
Evidence: Story 护栏引用 project-context 的 Hook-first 与 300 行限制（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:209-244`；`docs/project-context.md:84-94`）。  

---

### Step 2.4: Git History Analysis
Pass Rate: 5/5 (100.0%)

✓ PASS — Files created/modified in previous work  
Evidence: 相关文件的 git history 显示 3D viewer 与 data library 的连续演进（例如 `2bf6d52 feat: ... add industrial viewer implementation`；`a31750e Fix(3DViewer): ...`）。  

✓ PASS — Code patterns and conventions used  
Evidence: 9.3 的模式（Hook-first + dynamic import + data-testid）在现有代码中可见（`apps/web/features/industrial-viewer/components/ViewerToolbar.tsx:1-94`；`apps/web/e2e/model-viewer.spec.ts:10-45`）。  

✓ PASS — Library dependencies added/changed  
Evidence: Online3DViewer 依赖在历史/当前均为 `^0.18.0`（`apps/web/package.json:37-41`；`git show 2bf6d52:apps/web/package.json` 也包含 `online-3d-viewer: ^0.18.0`）。  

✓ PASS — Architecture decisions implemented  
Evidence: Data Library + Industrial Viewer 的 feature 目录结构与集成点已落地（`apps/web/features/data-library/components/DataLibraryDrawer.tsx:258-317`；`apps/web/features/industrial-viewer/components/ViewerToolbar.tsx:1-94`）。  

✓ PASS — Testing approaches used  
Evidence: 既有 E2E 使用 API seed + testUtils（`apps/web/e2e/model-viewer.spec.ts:13-45`），可作为 9.4 扩展的基准模式。  

---

### Step 2.5: Latest Technical Research
Pass Rate: 1/4 (25.0%)

✓ PASS — Identify libraries/frameworks mentioned  
Evidence: Story/Tech-Spec 明确依赖 Online3DViewer、VTK.js、Lucide、@cdm/ui（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:292-336,395-403`；`docs/sprint-artifacts/tech-spec-9-4-lightweight-viewer-mesh-contour.md:20-23,245-253`）。  

⚠ PARTIAL — Breaking changes or security updates  
Evidence: 未提供 Online3DViewer / VTK.js / Next.js 的 release notes 或版本差异注意事项（仅给出粗版本范围）（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:395-403`）。  
Impact: 可能在实现时遇到 API/构建变化（尤其是 VTK ESM/SSR/worker 相关）。

⚠ PARTIAL — Performance improvements or deprecations  
Evidence: 未引用任何 VTK.js 的性能建议或对大数据的实践（Story 仅 out-of-scope 分块加载）（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:35-38`）。  
Impact: 性能风险可能在后期才暴露。

⚠ PARTIAL — Best practices for current versions  
Evidence: Story 有工程护栏，但缺少针对 VTK.js 生命周期（dispose/renderWindow cleanup）与资源管理的最佳实践条目（`docs/sprint-artifacts/tech-spec-9-4-lightweight-viewer-mesh-contour.md:323-325` 未落到 Story 的 Tasks/Guardrails）。  
Impact: 容易出现 WebGL context 泄漏/重复初始化问题。

---

### Step 3.1: Reinvention Prevention Gaps
Pass Rate: 1/3 (33.3%)

✓ PASS — Wheel reinvention  
Evidence: 明确复用 9.3 `ModelViewerModal` 框架与 `useOnline3DViewer` hook（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:16-17,32,40-43`）。  

⚠ PARTIAL — Code reuse opportunities not identified  
Evidence: 既有 E2E 已提供 `createTestGraph/makeTestGraphUrl` 与 Drawer 打开助手模式（`apps/web/e2e/model-viewer.spec.ts:10-45`），但 Story 9.4 的测试示例未复用这些惯例（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:425-468`）。  
Impact: 新增测试更可能重复造轮子与产生不稳定选择器。

⚠ PARTIAL — Existing solutions not mentioned  
Evidence: 预览 gating 同时存在于 `AssetCard` 与 `AssetList`（`apps/web/features/data-library/components/AssetCard.tsx:36-51`；`apps/web/features/data-library/components/AssetList.tsx:38-53`），Story 任务仅提 `AssetCard.tsx`（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:184-191`）。  
Impact: Grid/List 视图行为可能不一致（一个能预览，一个不能）。

---

### Step 3.2: Technical Specification DISASTERS
Pass Rate: 0/5 (0.0%)

✗ FAIL — Wrong libraries/frameworks  
Evidence: Tech-Spec 将“线框”实现为 `innerViewer.SetShadingType(OV.ShadingType.Lines)`（`docs/sprint-artifacts/tech-spec-9-4-lightweight-viewer-mesh-contour.md:308-310`），但当前 Online3DViewer 的 `ShadingType` 仅包含 `Phong/Physical`（`apps/web/node_modules/online-3d-viewer/build/engine/o3dv.module.d.ts:1348-1353`）。此外 VTK 依赖声明为 `vtk.js`（`docs/sprint-artifacts/tech-spec-9-4-lightweight-viewer-mesh-contour.md:235-241`）而导入示例使用 `@kitware/vtk.js/...`（`docs/sprint-artifacts/tech-spec-9-4-lightweight-viewer-mesh-contour.md:245-253`）。  
Impact: Dev 按 Tech-Spec 实现会直接被“API 不存在/模块解析失败”阻塞，属于必须修正的致命规格错误。

➖ N/A — API contract violations  
Evidence: 无新增后端接口合约。  

⚠ PARTIAL — Database schema conflicts  
Evidence: `DataAssetFormat` 无 VTK 系列枚举（`packages/database/prisma/schema.prisma:426-443`），但 Story/Tech-Spec 要求预览 `.vtk/.vtu/.vti/.vtp`（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:24-29,60-64`；`docs/sprint-artifacts/tech-spec-9-4-lightweight-viewer-mesh-contour.md:172-180`）。  
Impact: 若不明确“存储/识别”策略（扩展 enum vs 依赖文件扩展名），实现将卡在数据模型与 UI preview gating 的一致性上。

➖ N/A — Security vulnerabilities  
Evidence: 不涉及安全/鉴权变更。  

⚠ PARTIAL — Performance disasters  
Evidence: Tech-Spec 提示 WebGL context/内存管理（`docs/sprint-artifacts/tech-spec-9-4-lightweight-viewer-mesh-contour.md:323-325`），但 Story 未要求在 hook unmount 时释放 VTK 资源或限制大数据渲染策略。  
Impact: 在真实云图数据下可能出现严重内存泄漏/渲染卡死。

---

### Step 3.3: File Structure DISASTERS
Pass Rate: 3/4 (75.0%)

✓ PASS — Wrong file locations  
Evidence: Story 的新增文件均落在 `apps/web/features/industrial-viewer/{hooks,components}` 与 `packages/ui/src`（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:150-181,123-127`），符合当前项目结构（`apps/web/features/industrial-viewer/components/ViewerToolbar.tsx:1-94`）。  

✓ PASS — Coding standard violations  
Evidence: Story 将超 300 行作为前置重构任务，并引用 project-context 的规则（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:111-135,230-244`；`docs/project-context.md:92-94`）。  
Impact: 降低继续膨胀大文件导致维护风险的概率。

✓ PASS — Integration pattern breaks  
Evidence: Story 明确 VTK.js 需禁用 SSR 并使用 dynamic import（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:262-276`），且强制 UI 使用 `@cdm/ui`（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:246-258`）。  
Impact: 符合 Next.js 与 monorepo 约束，减少运行时/样式漂移。

➖ N/A — Deployment failures  
Evidence: 不涉及部署脚本/环境变更。  

---

### Step 3.4: Regression DISASTERS
Pass Rate: 1/4 (25.0%)

⚠ PARTIAL — Breaking changes  
Evidence: DataLibraryDrawer 当前预览流为 `previewAsset -> ModelViewerModal`（`apps/web/features/data-library/components/DataLibraryDrawer.tsx:193-314`）。Story 计划加入 `previewType` 并切换 modal（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:188-191`），但未明确“保持旧路径不变/优先兼容 STEP/GLTF/现有边线开关”的回归护栏。  
Impact: 可能回归 Story 9.3 的预览打开/关闭/toolbar 行为与现有 E2E。

⚠ PARTIAL — Test failures  
Evidence: Story 给出的 E2E 示例与现有 suite 的 seed/打开 Drawer 方式不一致（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:425-468` vs `apps/web/e2e/model-viewer.spec.ts:13-45`），且未提及同时更新 `AssetList`。  
Impact: 测试更容易 flake 或出现“只测到了 Grid 没测到 List”的覆盖缺口。

✓ PASS — UX violations  
Evidence: Story 明确要求复用 9.3 的 `ModelViewerModal` 布局并在 toolbar 中扩展按钮（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:83-89,92-106`），与现有 toolbar 样式一致（`apps/web/features/industrial-viewer/components/ViewerToolbar.tsx:25-93`）。  

⚠ PARTIAL — Learning failures  
Evidence: Tech-Spec 对 Online3DViewer 的 ShadingType 做出错误假设（`docs/sprint-artifacts/tech-spec-9-4-lightweight-viewer-mesh-contour.md:308-310` vs `apps/web/node_modules/online-3d-viewer/build/engine/o3dv.module.d.ts:1348-1353`）。  
Impact: 团队会重复踩“未核对真实 API”的坑。

---

### Step 3.5: Implementation DISASTERS
Pass Rate: 2/4 (50.0%)

⚠ PARTIAL — Vague implementations  
Evidence: 云图格式识别与线框实现仍存在关键缺口（见 Step 3.2 与 Step 2.2 DB/versions 部分）（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:138-142,184-191`）。  
Impact: Dev 可能需要临场补全规格才能完成 AC。

✓ PASS — Completion lies  
Evidence: AC 与测试点是可观测的（data-testid、输入控件、按钮行为）（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:46-76,279-289,421-501`）。  
Impact: 可避免“做了但无法验收”的假完成。

✓ PASS — Scope creep  
Evidence: Out-of-scope 明确列出分块加载/时序动画/剖面等（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:35-39`）。  

⚠ PARTIAL — Quality failures  
Evidence: 测试计划存在但未与现有 harness/选择器惯例对齐，且缺少对 VTK 资源释放/错误边界的强约束（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:421-501`；`apps/web/e2e/model-viewer.spec.ts:10-45`；`docs/sprint-artifacts/tech-spec-9-4-lightweight-viewer-mesh-contour.md:323-325`）。  
Impact: 质量门槛可能在后期才发现缺口（flake、内存泄漏、边界数据失败）。

---

### Step 4: LLM-Dev-Agent Optimization Analysis
Pass Rate: 1/5 (20.0%)

⚠ PARTIAL — Verbosity problems  
Evidence: Story 内包含较长的 API 代码块与测试示例（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:303-355,423-501`）。  
Impact: Dev agent token 预算可能被示例代码占用，掩盖关键约束（格式策略/线框实现）。

⚠ PARTIAL — Ambiguity issues  
Evidence: 线框实现与云图格式识别策略未被“硬化”为明确做法（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:138-142,184-191`）。  
Impact: 多种实现分叉，风险上升。

⚠ PARTIAL — Context overload  
Evidence: 同时包含 UI 规范、任务分解、护栏、API 示例与测试示例（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:79-501`）。  
Impact: 关键信号不够前置时，容易被忽略。

⚠ PARTIAL — Missing critical signals  
Evidence: 已有 SSR/Hook-first/300 行/@cdm/ui 等护栏（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:209-289`），但缺少“DataAssetFormat 与 VTK 格式不匹配时的统一策略”和“线框的正确实现方式（不依赖不存在 API）”。  
Impact: 最关键的阻塞点可能在实现中才暴露。

✓ PASS — Poor structure  
Evidence: Story 结构清晰：Scope → AC → Tasks → Guardrails → Dev Notes → Testing（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:20-505`）。  

---

### Step 4: LLM Optimization Principles
Pass Rate: 1/5 (20.0%)

⚠ PARTIAL — Clarity over verbosity  
Evidence: 示例代码可压缩为要点清单（当前较长）（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:303-355,423-501`）。  
Impact: 关键约束可能被示例淹没。

⚠ PARTIAL — Actionable instructions  
Evidence: 大多数任务是可执行的，但线框/实体与 VTK 包名/导入风格存在致命不一致（`docs/sprint-artifacts/tech-spec-9-4-lightweight-viewer-mesh-contour.md:235-253,308-310`）。  
Impact: Dev agent 可能按错误路径推进而阻塞。

✓ PASS — Scannable structure  
Evidence: 章节与 Phase 分组明确，含 checklist 护栏（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:109-289`）。  

⚠ PARTIAL — Token efficiency  
Evidence: 大段 VTK API 示例与完整 E2E 示例可替换为最小可测 checklist + 指向现有 harness（`apps/web/e2e/model-viewer.spec.ts:10-45`）。  
Impact: 节省 token、减少偏航。

⚠ PARTIAL — Unambiguous language  
Evidence: “线框/实体”与“云图格式”虽列出，但实现策略不够无歧义（尤其 format 表示与 wireframe 实现）（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:22-33,138-142,184-191`）。  
Impact: 容易出现实现分歧与返工。

---

### Step 5: Improvement Recommendations
Pass Rate: 4/4 (100.0%)

✓ PASS — Critical Misses (Must Fix)  
Evidence: 见下方 Failed Items / Recommendations（ShadingType.Lines 与 VTK 包名/导入风格问题）。  

✓ PASS — Enhancement Opportunities (Should Add)  
Evidence: 见下方 Partial Items / Recommendations。  

✓ PASS — Optimization Suggestions (Nice to Have)  
Evidence: 见下方 Recommendations（精简示例、前置关键护栏）。  

✓ PASS — LLM Optimization Improvements  
Evidence: 见下方 Recommendations（将关键阻塞点前置为“必须遵循”）。  

---

## Failed Items
- Wrong libraries/frameworks: 修正线框/实体的可行实现路线（避免 `OV.ShadingType.Lines`），并统一 VTK 的依赖包名与 import 风格（`docs/sprint-artifacts/tech-spec-9-4-lightweight-viewer-mesh-contour.md:235-253,308-310`；`apps/web/node_modules/online-3d-viewer/build/engine/o3dv.module.d.ts:1348-1353`）。

## Partial Items
- 版本/依赖不一致：Story 的 `online-3d-viewer` 版本与 repo 不符（`docs/sprint-artifacts/9-4-lightweight-viewer-mesh-contour.md:395-403` vs `apps/web/package.json:37-41`）。  
- 云图格式与数据模型：`DataAssetFormat` 无 VTK 系列格式，但预览 gating 基于 enum（`packages/database/prisma/schema.prisma:426-443`；`apps/web/features/data-library/components/AssetCard.tsx:36-51`）。  
- Grid/List 行为一致性：需要同时更新 `AssetCard` 与 `AssetList` 的 preview gating（`apps/web/features/data-library/components/AssetList.tsx:38-53`）。  
- 测试对齐：Story 的 E2E 示例未复用现有 harness（`apps/web/e2e/model-viewer.spec.ts:10-45`）。  
- 性能/资源释放：VTK.js WebGL context/资源释放未形成任务/护栏（`docs/sprint-artifacts/tech-spec-9-4-lightweight-viewer-mesh-contour.md:323-325`）。  

## Recommendations
1. Must Fix:
   - 纠正“线框/实体”实现：不要使用不存在的 `OV.ShadingType.Lines`；明确采用可行方案（例如：将“线框”定义为三角网格材质 wireframe，或定义为 edges-only/edge overlay，并与现有 `edgesEnabled` 语义兼容）。同时让 Story 与 Tech-Spec 统一同一方案。  
   - 明确云图资产识别策略：在不扩展 DB enum 的情况下，需基于 `asset.name/storagePath` 扩展名判定并设置 `previewType`；若要扩展 enum，则需要 DB/Types/API 同步变更与迁移计划。并同步更新 `AssetCard` + `AssetList` 的 preview gating。  
2. Should Improve:
   - 对齐依赖版本与导入：将 Story/Tech-Spec 的 `online-3d-viewer` 版本更新为 `^0.18.0`（当前 repo），VTK 选择 `vtk.js` 或 `@kitware/vtk.js` 其一并保持 import 一致。  
   - 将 E2E 计划对齐现有惯例：复用 `createTestGraph/makeTestGraphUrl` 与 Drawer 打开方式，新增 seed mesh/contour 资产的 helper。  
   - 增加资源释放/性能护栏：在 `useContourViewer` unmount 时显式 dispose VTK 相关对象，避免重复 init/泄漏，并添加失败回退与可观测的 error 状态。  
3. Consider:
   - 将 mock 资产放入 `apps/web/public/mock/storage/` 并在 seed 脚本或 E2E seed 中引用，便于手工验证与稳定测试数据。  
   - 精简大段示例代码为“必须做/禁止做”清单，把关键阻塞点（格式策略/线框实现）前置到 Scope/Guardrails。  
