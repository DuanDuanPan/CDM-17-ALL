# Validation Report

**Document:** docs/sprint-artifacts/story-8-1-node-collapse-expand.md  
**Checklist:** _bmad/bmm/workflows/4-implementation/create-story/checklist.md  
**Date:** 2026-01-04T20:50:03+0800

## Summary
- Overall: 20/44 passed (45%)
- Critical Issues: 6

## Section Results

### Critical Mistakes to Prevent
Pass Rate: 2/8 (25%)

⚠ PARTIAL - Reinventing wheels  
Evidence: 复用点没有被明确标出：当前协作栈已经存在 GraphSyncManager（X6↔Yjs 双向同步）与 CollabService（Yjs→Postgres 持久化），但 Story 仍倾向“直接读写 Yjs nodesMap”（`docs/sprint-artifacts/story-8-1-node-collapse-expand.md:224-227,1090-1096`）而未明确“以 X6 数据变更为本地入口，GraphSyncManager 负责同步”。  
Impact: Dev 容易绕过既有同步机制，导致覆盖 UI-only 字段或引入同步回路。

✓ PASS - Wrong libraries  
Evidence: 依赖与栈一致（X6/Yjs/lucide-react）并被显式列出（`docs/sprint-artifacts/story-8-1-node-collapse-expand.md:1083-1087`；`docs/sprint-artifacts/tech-spec-8-1-node-collapse-expand.md:55-66,240-252`）。  
Impact: 降低实现时引入不必要依赖的风险。

✗ FAIL - Wrong file locations  
Evidence: `packages/ui` 现有组件文件位于 `packages/ui/src/*.tsx` 且通过 `packages/ui/src/index.ts` 导出（`packages/ui/src/index.ts:1-29`），但 Story 要求新增文件路径为 `packages/ui/src/components/CollapseToggle.tsx`（`docs/sprint-artifacts/story-8-1-node-collapse-expand.md:244-261,1109-1111`）。同时 `apps/web/components/nodes` 现状无 `components/` 子目录，但 Story 仍指向 `apps/web/components/nodes/components/ChildCountBadge.tsx`（`docs/sprint-artifacts/story-8-1-node-collapse-expand.md:262-268,1109-1111`）。  
Impact: 路径不对会直接造成实现落点错误、导出失败与 review 成本飙升。

⚠ PARTIAL - Breaking regressions  
Evidence: 通过 `cell.setVisible(false)` 隐藏节点/边的策略明确（`docs/sprint-artifacts/story-8-1-node-collapse-expand.md:224-227`；`docs/sprint-artifacts/tech-spec-8-1-node-collapse-expand.md:55-66`），但未说明“远端协作更新/刷新回放时”如何重放折叠可见性（GraphSyncManager 仅同步 `collapsed` 字段，不处理折叠导致的 `visible` 变化：`apps/web/features/collab/GraphSyncManager.ts:495-560`）。  
Impact: 协作/刷新后折叠状态与可见性可能脱节（状态是折叠，但子树仍可见）。

✓ PASS - Ignoring UX  
Evidence: UI 规范、交互流程图、可访问性要求较完整（`docs/sprint-artifacts/story-8-1-node-collapse-expand.md:38-200`）。  
Impact: 降低“做出来但不好用/不可访问”的风险。

⚠ PARTIAL - Vague implementations  
Evidence: AC2 “保持原有布局位置”没有定义是否允许触发布局重算，而 Tech-Spec 明确写了 `graph.layout()`/`useLayoutPlugin`（`docs/sprint-artifacts/story-8-1-node-collapse-expand.md:21-24` vs `docs/sprint-artifacts/tech-spec-8-1-node-collapse-expand.md:126-131`）。  
Impact: Dev 可能实现为“折叠触发布局收缩”，导致展开后位置漂移并破坏用户空间记忆。

⚠ PARTIAL - Lying about completion  
Evidence: Story 给出了大量“文档内”示例代码与测试草案，但没有约束“哪些必须落到真实测试文件并在 CI 跑通”（仅在 AI-Review 里提到风险：`docs/sprint-artifacts/story-8-1-node-collapse-expand.md:347-357`）。  
Impact: 容易出现“文档看似完整但代码/测试未真正落地”的假完成。

✗ FAIL - Not learning from past work  
Evidence: GraphSyncManager 的关键注释明确要求跳过本地 UI origin 的 Yjs 事务，避免覆盖 UI-only 字段（`apps/web/features/collab/GraphSyncManager.ts:238-247`）。但 Story Dev Notes 仍要求“折叠状态变更通过 Yjs Map.set” （`docs/sprint-artifacts/story-8-1-node-collapse-expand.md:1090-1096`）。  
Impact: 与既有协作同步约束冲突，容易复现“协作中编辑/选择状态被 wipe”的历史问题。

### Step 1: Load and Understand the Target
Pass Rate: 5/6 (83%)

✓ PASS - Load the workflow configuration  
Evidence: 工作流定义存在（`_bmad/bmm/workflows/4-implementation/create-story/workflow.yaml:1-52`）。  

✓ PASS - Load the story file  
Evidence: Story 文件存在且包含 AC/Tasks/Test Design（`docs/sprint-artifacts/story-8-1-node-collapse-expand.md:1-1182`）。  

✓ PASS - Load validation framework  
Evidence: 验证框架存在（`_bmad/core/tasks/validate-workflow.xml:1-59`）。  

✓ PASS - Extract metadata (epic/story key)  
Evidence: Title/Tech-Spec 链接清晰（`docs/sprint-artifacts/story-8-1-node-collapse-expand.md:1-5`），epics 文件包含同名 Story（`docs/epics.md:765-784`）。  

⚠ PARTIAL - Resolve workflow variables  
Evidence: `create-story/workflow.yaml` 依赖 `config.yaml:sprint_artifacts`（`_bmad/bmm/workflows/4-implementation/create-story/workflow.yaml:10-13`），但当前 `_bmad/bmm/config.yaml` 未包含该字段（`_bmad/bmm/config.yaml:1-12`），变量解析需要人工兜底（本次以 `docs/sprint-artifacts/` 为准）。  
Impact: 自动化工具在“发现 story_dir / sprint-status”时可能失败。

✓ PASS - Understand current status  
Evidence: Story 目前标记为 `in-progress`（`docs/sprint-artifacts/story-8-1-node-collapse-expand.md:3`），Tech-Spec 标记为 Ready for Development（`docs/sprint-artifacts/tech-spec-8-1-node-collapse-expand.md:3-5`）。  

### Step 2.1: Epics and Stories Analysis
Pass Rate: 4/5 (80%)

✓ PASS - Epic objectives and business value  
Evidence: Epic 8 面向 500-5000+ 节点的 UX 优化目标明确（`docs/epics.md:765-768`）。  

✓ PASS - Story requirements and acceptance criteria alignment  
Evidence: epics.md 的 AC 与 Story AC1-AC5 一致（`docs/epics.md:769-784` vs `docs/sprint-artifacts/story-8-1-node-collapse-expand.md:14-34`）。  

⚠ PARTIAL - Cross-story dependencies and prerequisites  
Evidence: Story 引用 GraphContext / Context Menu / Hotkeys 等落点，但未在 Tasks 中显式纳入（仅在 AI-Review 中提及：`docs/sprint-artifacts/story-8-1-node-collapse-expand.md:354-355`）。  
Impact: Dev 可能只改了 GlobalSearchDialog/useGraphContextMenu，导致功能入口覆盖不全。

✓ PASS - In/Out of scope boundaries  
Evidence: Tech-Spec 定义了 out-of-scope（`docs/sprint-artifacts/tech-spec-8-1-node-collapse-expand.md:24-38`）。  

✓ PASS - Types already exist  
Evidence: `NodeData.collapsed` 已存在（`packages/types/src/index.ts:2-14`；Story 亦记录：`docs/sprint-artifacts/story-8-1-node-collapse-expand.md:1083-1087`）。  

### Step 2.2: Architecture Deep-Dive
Pass Rate: 2/5 (40%)

✗ FAIL - Data flow consistency (Yjs-first vs GraphSyncManager)  
Evidence: 架构文档宣称 UI 必须走 Yjs Map.set（`docs/architecture.md:546-549`），但现有实现通过 GraphSyncManager 将 X6 事件同步到 Yjs，并显式警告“不要把本地 Yjs 事务再 apply 回 X6”（`apps/web/features/collab/GraphSyncManager.ts:238-247`）。Story 仍指向直接 Map.set（`docs/sprint-artifacts/story-8-1-node-collapse-expand.md:1090-1096`）。  
Impact: 若按 Story 直接写 Yjs，极易触发 GraphSyncManager 的保护逻辑/覆盖风险。

⚠ PARTIAL - Collaboration persistence assumption  
Evidence: 后端 CollabService 已做 Yjs→Postgres 持久化（`apps/api/src/modules/collab/collab.service.ts:20-33,84-120`），但 Story AC4 明确 localStorage（`docs/sprint-artifacts/story-8-1-node-collapse-expand.md:29-31`）。  
Impact: 可能重复实现双持久化，造成多源真相与边界不清。

✓ PASS - Hook-first structure  
Evidence: Story 将核心逻辑集中在 `useNodeCollapse`（`docs/sprint-artifacts/story-8-1-node-collapse-expand.md:206-227`）并符合项目 Hook-first 习惯。  

✗ FAIL - Right-click menu integration point  
Evidence: Story 要求修改 `useGraphContextMenu.ts`（`docs/sprint-artifacts/story-8-1-node-collapse-expand.md:312-317`），但该 hook 专注 Edge 菜单（`apps/web/components/graph/hooks/useGraphContextMenu.ts:1-9,31-55`）；Node 菜单在 `apps/web/components/graph/parts/NodeContextMenu.tsx`（`apps/web/components/graph/parts/NodeContextMenu.tsx:6-24`）。  
Impact: 改错文件会导致功能缺失与回归风险。

⚠ PARTIAL - Navigation layer for AC5  
Evidence: GlobalSearchDialog 只是透出 `onSelect`（`apps/web/components/CommandPalette/GlobalSearchDialog.tsx:17-27,58-72`），实际导航在 GraphContext.navigateToNode（`apps/web/contexts/GraphContext.tsx:36-66`），但 Story 仍要求改 GlobalSearchDialog（`docs/sprint-artifacts/story-8-1-node-collapse-expand.md:321-334`）。  
Impact: 其它入口（通知跳转、未来 outline 等）不会自动展开路径。

### Step 4: LLM-Dev-Agent Optimization Analysis
Pass Rate: 3/6 (50%)

✓ PASS - Scannable structure  
Evidence: AC、UI 规范、Tasks、Test Design、Dev Notes 分区清晰（`docs/sprint-artifacts/story-8-1-node-collapse-expand.md:14-1182`）。  

⚠ PARTIAL - Context overload  
Evidence: 文档内嵌大量“拟实现代码/拟测试代码”（从 `docs/sprint-artifacts/story-8-1-node-collapse-expand.md:374` 起），并在 AI-Review 中已提示“文档代码漂移”风险（`docs/sprint-artifacts/story-8-1-node-collapse-expand.md:357`）。  
Impact: Dev Agent token 成本高，且容易把文档代码当成最终实现忽略真实仓库约束。

⚠ PARTIAL - Missing crisp decisions  
Evidence: “折叠状态是否协作共享”没有给出最终裁决（以 AI-Review 形式提出冲突：`docs/sprint-artifacts/story-8-1-node-collapse-expand.md:351`），并且 AC4 与 Dev Notes 的同步策略存在张力（`docs/sprint-artifacts/story-8-1-node-collapse-expand.md:29-31,1090-1096`）。  
Impact: Dev 无法确定单一真相源，容易做出不可逆的同步/持久化选择。

✓ PASS - Test intent is explicit  
Evidence: 提供单测/E2E 覆盖矩阵（`docs/sprint-artifacts/story-8-1-node-collapse-expand.md:361-370`）。  

✗ FAIL - “Do not lie” enforcement  
Evidence: Dev Agent Record 的 `File List` 为空占位（`docs/sprint-artifacts/story-8-1-node-collapse-expand.md:1175-1182`），没有硬性“完成前必须填充/必须跑哪些命令”的关卡。  
Impact: 很容易出现“实现分散/未列出改动/未跑测试”的交付物。

✓ PASS - References included  
Evidence: Tech-Spec / architecture / project-context / 官方文档链接齐全（`docs/sprint-artifacts/story-8-1-node-collapse-expand.md:1168-1173`）。  

## Failed Items
- Wrong file locations（修正文档中的落点与导出策略）
- Not learning from past work（以 GraphSyncManager 为本地入口，避免直接 Yjs Map.set）
- Data flow consistency（澄清协作同步路径；明确远端更新如何重放可见性）
- Right-click menu integration point（改 NodeContextMenu 而非 useGraphContextMenu）
- “Do not lie” enforcement（补齐 Dev Agent Record 的交付门槛）

## Partial Items
- 状态/流程一致性（Story status vs Tech-Spec）
- 协作持久化边界（Postgres 已持久化 vs localStorage 要求）
- AC2 布局语义（是否允许重新布局）
- AC5 入口覆盖（导航层统一处理）
- 文档内代码块过多（token 与漂移风险）

## Recommendations
1. Must Fix: 修正文件落点、右键菜单/导航落点；明确“本地入口是 X6+GraphSyncManager”并补齐远端折叠重放策略。
2. Should Improve: 澄清 AC2 布局语义与子节点计数定义；将 localStorage 作为可选优化或明确与后端持久化的关系。
3. Consider: 将长篇示例迁移到真实测试/实现文件，文档只保留接口与关键断言，降低漂移与 token 成本。

