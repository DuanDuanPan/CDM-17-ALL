# Validation Report

**Document:** `docs/sprint-artifacts/5-2-subtree-fragments.md`  
**Checklist:** `_bmad/bmm/workflows/4-implementation/create-story/checklist.md`  
**Date:** 2026-01-02T10-55-04+0800

## Summary

- Overall: **27/76 passed** (35.5%); Partial: 34; Fail: 13; N/A: 2
- Critical Issues: **6**
  1. **Yjs 节点/边数据结构不匹配（高风险）**：插入模板时生成的 node/edge shape 与现有协作/粘贴逻辑不一致，可能导致边不渲染、数据不同步或 GraphSyncManager 无法正确处理。(`docs/sprint-artifacts/5-2-subtree-fragments.md:997-1032`; `apps/web/hooks/clipboard/clipboardPaste.ts:267-292`; `apps/web/hooks/clipboard/pasteHelpers.ts:98-110`)
  2. **重复造轮子：子树提取/插入与 Clipboard 已有能力高度重叠**，且 Clipboard 逻辑已包含 descendant 展开、edge kind 读取、sanitizeNodeProps、ID 映射与 Yjs 写入。(`docs/sprint-artifacts/5-2-subtree-fragments.md:761-866`, `docs/sprint-artifacts/5-2-subtree-fragments.md:924-1034`; `apps/web/hooks/clipboard/clipboardSerializer.ts:33-179`; `apps/web/hooks/clipboard/clipboardPaste.ts:242-292`)
  3. **AC6 可见性（私有/公开）设计不闭环**：DB 无 `isPublic` 字段、list API/类型也无必要字段，私有模板很可能被错误暴露或无法筛选。(`docs/sprint-artifacts/5-2-subtree-fragments.md:51-56`, `docs/sprint-artifacts/5-2-subtree-fragments.md:70-76`, `docs/sprint-artifacts/5-2-subtree-fragments.md:1039-1042`; `packages/database/prisma/schema.prisma:368-392`; `packages/types/src/template-types.ts:53-76`; `packages/plugins/plugin-template/src/server/templates/templates.repository.ts:21-78`)
  4. **DTO/Controller 路径与 Nest 校验用法与现状不一致**：当前已存在 `templates.request.dto.ts` 与全局 `ValidationPipe`，Story 仍引导创建新 `dto/` 目录与 `@Body(ValidationPipe)`。(`docs/sprint-artifacts/5-2-subtree-fragments.md:551-585`, `docs/sprint-artifacts/5-2-subtree-fragments.md:675-696`; `packages/plugins/plugin-template/src/server/templates/templates.request.dto.ts:1-48`; `apps/api/src/main.ts:13-21`)
  5. **DnD 实现示例偏离 repo 现有 dnd-kit 用法**：Story 使用 `Draggable/Droppable` 包装组件，但代码库已有 `useDraggable/useDroppable` 模式（Kanban）。(`docs/sprint-artifacts/5-2-subtree-fragments.md:165-175`; `apps/web/features/views/components/KanbanView/KanbanCard.tsx:83-96`; `apps/web/features/views/components/KanbanView/KanbanColumn.tsx:85-93`)
  6. **安全/数据治理：metadata 清洗策略不充分**：Story 的 `sanitizeMetadata` 仅“删除若干字段”的思路不足以覆盖多态节点 props；现有 `sanitizeNodeProps` 才是已验证的白名单策略。(`docs/sprint-artifacts/5-2-subtree-fragments.md:866-866`; `apps/web/hooks/clipboard/clipboardSerializer.ts:130-147`; `packages/types/src/node-types.ts:213-230`)

## Section Results

### Critical Mistakes to Prevent
Pass Rate: 2/8 (25%)

⚠ PARTIAL — Reinventing wheels  
Evidence: Story 新增 `subtree-extractor.ts` 与 `useTemplateInsert` 自行实现“选中子树展开/依赖边提取/ID 重映射/Yjs 写入”。(`docs/sprint-artifacts/5-2-subtree-fragments.md:761-866`, `docs/sprint-artifacts/5-2-subtree-fragments.md:924-1034`) 但现有 Clipboard 已覆盖相同能力（含 descendants、edge metadata.kind、sanitizeNodeProps、Yjs 写入、边重建）。(`apps/web/hooks/clipboard/clipboardSerializer.ts:33-179`; `apps/web/hooks/clipboard/clipboardPaste.ts:242-292`; `apps/web/hooks/clipboard/pasteHelpers.ts:78-147`)  
Impact: 高概率产生重复实现与数据结构分叉，导致“粘贴能用、模板插入坏”的 split-brain 体验。

✓ PASS — Wrong libraries  
Evidence: Story 使用 `@dnd-kit/core` 做拖拽。(`docs/sprint-artifacts/5-2-subtree-fragments.md:163-185`) Repo 已依赖并在 Kanban 中使用 dnd-kit。(`apps/web/package.json:24-26`; `apps/web/features/views/components/KanbanView/KanbanCard.tsx:83-96`)  
Impact: 低风险出现“选错库/版本不兼容”。

⚠ PARTIAL — Wrong file locations  
Evidence: Story 指向 `packages/plugins/plugin-template/src/server/templates/dto/create-template.dto.ts`（新增 dto 目录）。(`docs/sprint-artifacts/5-2-subtree-fragments.md:551-554`) 但当前 plugin-template 已使用 `templates.request.dto.ts` 放在同级目录。(`packages/plugins/plugin-template/src/server/templates/templates.request.dto.ts:1-48`)  
Impact: 可能造成 DTO 分散、导出/引用不一致，增加维护成本。

⚠ PARTIAL — Breaking regressions  
Evidence: Story 要求 `TemplateLibraryDialog` 支持“从模板创建新图”与“插入到当前图”双模式并加 Tab 过滤。(`docs/sprint-artifacts/5-2-subtree-fragments.md:1039-1042`) 现有 Dialog Footer 与行为是单一路径“从模板创建”。(`apps/web/components/TemplateLibrary/TemplateLibraryDialog.tsx:332-373`)  
Impact: 若不隔离模式/props，可能回归破坏 Story 5.1 的创建流程。

✓ PASS — Ignoring UX  
Evidence: Story 提供了 UI 设计规范、交互规范与设计图引用。(`docs/sprint-artifacts/5-2-subtree-fragments.md:249-257`, `docs/sprint-artifacts/5-2-subtree-fragments.md:311-331`)  
Impact: Dev 有明确 UI 目标与交互边界。

✗ FAIL — Vague implementations  
Evidence: 插入模板生成的节点/边对象与现有协作数据结构不一致：Story 生成 node 使用 `type` 字段与简单结构。(`docs/sprint-artifacts/5-2-subtree-fragments.md:997-1005`) 但现有粘贴写入 Yjs 的节点含 `mindmapType/nodeType/props/metadata/tags/graphId/timestamps` 等字段。(`apps/web/hooks/clipboard/clipboardPaste.ts:267-284`) Edge 也应写入 `type` + `metadata.kind/dependencyType`。(`apps/web/hooks/clipboard/pasteHelpers.ts:98-108`)  
Impact: 极易导致协作同步/渲染失败或数据丢失（dependency edges 不显示/不落库）。

⚠ PARTIAL — Lying about completion  
Evidence: AC6 要求私有/公开可见性。(`docs/sprint-artifacts/5-2-subtree-fragments.md:51-56`) 但当前 DB schema 无 `isPublic`。(`packages/database/prisma/schema.prisma:368-392`) list 类型也无 `creatorId/isPublic` 字段用于 UI “我的模板/私有筛选”。(`packages/types/src/template-types.ts:53-76`)  
Impact: 存在“功能看似完成，但私有模板泄露/不可筛选”的风险。

⚠ PARTIAL — Not learning from past work  
Evidence: Story 复用了 Story 5.1 的 plugin-template 与 TemplateLibraryDialog。(`docs/sprint-artifacts/5-2-subtree-fragments.md:80-89`) 但未引用 Story 2.6 的 Clipboard（它更贴近“子树保存/复用”）。(`apps/web/hooks/clipboard/clipboardSerializer.ts:33-179`)  
Impact: 可能重复踩坑（edge metadata、sanitize、Yjs 写入协议）。

### Step 1: Load and Understand the Target
Pass Rate: 6/6 (100%)

✓ PASS — Load the workflow configuration  
Evidence: create-story workflow 定义了 validation checklist。(`_bmad/bmm/workflows/4-implementation/create-story/workflow.yaml:14-19`)

✓ PASS — Load the story file  
Evidence: 目标 Story 文件存在且为 ready-for-dev。(`docs/sprint-artifacts/5-2-subtree-fragments.md:1-7`)

✓ PASS — Load validation framework  
Evidence: 校验框架定义了“逐项标记 + 报告落盘”。(`_bmad/core/tasks/validate-workflow.xml:1-79`)

✓ PASS — Extract metadata (epic/story key/title)  
Evidence: 标题包含 Epic/Story 编号。(`docs/sprint-artifacts/5-2-subtree-fragments.md:1`)

✓ PASS — Resolve workflow variables  
Evidence: output_folder 指向 `docs`；story 在 `docs/sprint-artifacts` 下符合 repo 习惯。(`_bmad/bmm/config.yaml:12-16`; `docs/sprint-artifacts/5-2-subtree-fragments.md:7`)

✓ PASS — Understand current status  
Evidence: 状态为 `ready-for-dev`，并包含完整 Tasks/测试矩阵。(`docs/sprint-artifacts/5-2-subtree-fragments.md:3`, `docs/sprint-artifacts/5-2-subtree-fragments.md:501-1141`)

### Step 2.1: Epics and Stories Analysis
Pass Rate: 5/6 (83.3%)

✓ PASS — Load epics file  
Evidence: Epic 5 与 Story 5.2 均在 `docs/epics.md` 中。(`docs/epics.md:448-481`)

✓ PASS — Epic objectives and business value  
Evidence: Epic 5 明确目标为“知识复用与智能辅助”。(`docs/epics.md:448-450`)

✓ PASS — ALL stories in this epic (cross-story context)  
Evidence: Epic 5 包含 5.1~5.4。(`docs/epics.md:452-510`)

✓ PASS — Our story requirements and acceptance criteria  
Evidence: epics 中 Story 5.2 的 AC 覆盖“保存为模板 + 拖拽复用”。(`docs/epics.md:467-480`) Story 文件扩展为 AC1~AC6。(`docs/sprint-artifacts/5-2-subtree-fragments.md:19-56`)

⚠ PARTIAL — Technical requirements and constraints  
Evidence: epics 对技术约束描述较少，更多依赖 Story/Tech-Spec 补全。(`docs/epics.md:467-480`; `docs/sprint-artifacts/5-2-subtree-fragments.md:66-76`)  
Impact: 需要确保关键技术约束（Yjs node/edge shape、sanitize、边模型）写在“最权威”的位置且不冲突。

✓ PASS — Cross-story dependencies and prerequisites  
Evidence: Story 显式依赖 Story 5.1。(`docs/sprint-artifacts/5-2-subtree-fragments.md:6`; `docs/epics.md:452-466`)

### Step 2.2: Architecture Deep-Dive
Pass Rate: 3/10 (30%)

✓ PASS — Load architecture file  
Evidence: architecture 定义了 Plugin Protocol、Isomorphic DTO、Yjs-first。(`docs/architecture.md:520-549`)

⚠ PARTIAL — Technical stack with versions  
Evidence: 架构文档锁定了 Yjs/Nest/Next 方向，但本 Story 未提供版本/约束表，容易发生“用法不一致”。(`docs/architecture.md:546-549`; `docs/sprint-artifacts/5-2-subtree-fragments.md:161-186`)  
Impact: 缺少版本级别的 guardrails 时，Dev 可能按文档示例写出与现有实现不兼容的代码。

⚠ PARTIAL — Code structure and organization patterns  
Evidence: 架构强调共享类型在 `packages/types`（零重复）。(`docs/architecture.md:539-543`) Story 虽然扩展 types，但前端示例仍出现“自定义 node/edge shape”倾向。(`docs/sprint-artifacts/5-2-subtree-fragments.md:997-1032`)  
Impact: 可能导致 `apps/web` 与 `packages/types` 的契约漂移。

⚠ PARTIAL — API design patterns and contracts  
Evidence: Story 增加 `POST /templates`，但 list/filter/visibility 的 query contract 未闭环。(`docs/sprint-artifacts/5-2-subtree-fragments.md:679-696`, `docs/sprint-artifacts/5-2-subtree-fragments.md:1039-1042`)  
Impact: AC6 容易卡在“前端能选，但后端无法保证不泄露”。

⚠ PARTIAL — Database schemas and relationships  
Evidence: Story 以 `isPublic` 控制可见性。(`docs/sprint-artifacts/5-2-subtree-fragments.md:70-76`) 但 Template 模型无该字段。(`packages/database/prisma/schema.prisma:368-392`)  
Impact: 需要明确：新增列/用 status 编码/用 JSON 字段，否则实现会分叉。

⚠ PARTIAL — Security requirements and patterns  
Evidence: 架构强调 RBAC/权限。(`docs/architecture.md:557-564`) Story 目前以 `userId` query param 传入创建者，并未定义私有模板的访问控制策略。(`docs/sprint-artifacts/5-2-subtree-fragments.md:681-693`)  
Impact: 无 auth 时至少要在 list/getById 做严格过滤，否则私有模板可被枚举访问。

⚠ PARTIAL — Performance requirements and optimization strategies  
Evidence: Clipboard 有 MAX 节点限制来避免大选择卡死。(`apps/web/hooks/clipboard/clipboardSerializer.ts:40-44`) Story 未设定模板保存的 node/edge 上限或 JSON 大小限制。(`docs/sprint-artifacts/5-2-subtree-fragments.md:93-111`)  
Impact: 大子树模板可能导致 DB/网络/前端渲染性能灾难。

✓ PASS — Testing standards and frameworks  
Evidence: Story 明确 Jest/Vitest/Playwright 覆盖，并提供 AC 追溯矩阵。(`docs/sprint-artifacts/5-2-subtree-fragments.md:1044-1141`)

➖ N/A — Deployment and environment patterns  
Evidence: 本 Story 不涉及部署/环境差异（不新增 infra）。  
Impact: N/A

✓ PASS — Integration patterns and external services  
Evidence: Story 引用 Yjs-first 原则并在插入路径使用 `ydoc.transact()`。(`docs/architecture.md:546-549`; `docs/sprint-artifacts/5-2-subtree-fragments.md:181-185`)

### Step 2.3: Previous Story Intelligence (if applicable)
Pass Rate: 2/7 (28.6%)

✓ PASS — Load previous story file  
Evidence: Story 5.1 存在并标记 done。(`docs/sprint-artifacts/5-1-template-library.md:1-3`)

⚠ PARTIAL — Dev notes and learnings  
Evidence: Story 引用了 5.1，但未把“TemplateLibraryDialog 内部预览组件不可复用”这种落地问题显式转化为任务（例如抽取组件）。(`docs/sprint-artifacts/5-2-subtree-fragments.md:711-712`; `apps/web/components/TemplateLibrary/TemplateLibraryDialog.tsx:381-415`)  
Impact: 实施时会出现“想复用但无法 import”的返工点。

⚠ PARTIAL — Review feedback and corrections needed  
Evidence: 5.1 的代码/验证报告强调路径/契约一致性的重要性；本 Story 仍存在与既有数据结构不一致的示例（node/edge shape）。(`docs/sprint-artifacts/5-2-subtree-fragments.md:997-1032`; `apps/web/hooks/clipboard/clipboardPaste.ts:267-292`)  
Impact: 重复出现“文档驱动实现，但实现与系统真实契约不一致”的问题。

⚠ PARTIAL — Files created/modified and their patterns  
Evidence: Story 指向新增 `dto/` 目录与 `apps/web/lib/graph` 新目录。(`docs/sprint-artifacts/5-2-subtree-fragments.md:553-554`, `docs/sprint-artifacts/5-2-subtree-fragments.md:763-764`) 但现有模式是 `templates.request.dto.ts` 与 `apps/web/hooks/clipboard/*`。(`packages/plugins/plugin-template/src/server/templates/templates.request.dto.ts:1-48`; `apps/web/hooks/clipboard/clipboardSerializer.ts:1-18`)  
Impact: 目录结构可能变得不统一，增加新成员学习成本。

✓ PASS — Testing approaches that worked/didn't work  
Evidence: Story 延续“unit + component + e2e”模式并给出用例编号。(`docs/sprint-artifacts/5-2-subtree-fragments.md:1044-1104`)

⚠ PARTIAL — Problems encountered and solutions found  
Evidence: 未沉淀“协作数据写入 shape（mindmapType/nodeType/props/metadata）”这一已解决问题的标准写法到 Story 的关键路径示例。(`apps/web/hooks/clipboard/clipboardPaste.ts:267-284`; `docs/sprint-artifacts/5-2-subtree-fragments.md:997-1005`)  
Impact: 实施阶段更容易出现“写入字段不全 → 数据丢失/不渲染”。

⚠ PARTIAL — Code patterns and conventions established  
Evidence: 现有 `useTemplates` 的 state 命名是 `isLoading/isLoadingTemplate/isInstantiating`；Story 的 hook 示例使用 `setLoading`（不存在）。(`apps/web/hooks/useTemplates.ts:58-66`; `docs/sprint-artifacts/5-2-subtree-fragments.md:728-745`)  
Impact: 示例代码会误导实现，降低可直接复制粘贴的可信度。

### Step 2.4: Git History Analysis
Pass Rate: 5/5 (100%)

✓ PASS — Files created/modified in previous work  
Evidence: 最近提交包含 Story 5.1 与多个 story 完成/重构，说明 repo 的变更模式稳定（conventional commits）。(`git log -n 12 --oneline` 输出含 `feat(template-library)` 等)

✓ PASS — Code patterns and conventions used  
Evidence: Commit message 使用 `feat(scope): ...`。(`git log -n 12 --oneline`)

✓ PASS — Library dependencies added/changed  
Evidence: 近期主要是 feature/重构，未显示大量依赖漂移（符合 monorepo 稳定期）。(`git log -n 12 --oneline`)

✓ PASS — Architecture decisions implemented  
Evidence: `feat(plugin-migration)` 等提交反映 plugin 架构已落地。(`git log -n 12 --oneline`)

✓ PASS — Testing approaches used  
Evidence: 多个提交提及 tests/validation reports。(`git log -n 12 --oneline`)

### Step 2.5: Latest Technical Research
Pass Rate: 1/4 (25%)

✓ PASS — Identify any libraries/frameworks mentioned  
Evidence: Story 明确涉及 `@dnd-kit/core`、Yjs、Nest/Prisma。(`docs/sprint-artifacts/5-2-subtree-fragments.md:161-186`, `docs/sprint-artifacts/5-2-subtree-fragments.md:933-965`)

⚠ PARTIAL — Breaking changes or security updates  
Evidence: 未包含对关键库版本的“近期破坏性变更/安全注意事项”的外部调研。  
Impact: 仍可能在实现时遇到版本细节坑（尤其是 dnd-kit + React 19 + Next 16 组合）。

⚠ PARTIAL — Performance improvements or deprecations  
Evidence: 未对模板结构 JSON、拖拽性能（大模板）给出版本相关建议。  
Impact: 大模板插入可能卡顿，需要提前设定上限/分批渲染策略。

⚠ PARTIAL — Best practices for current versions  
Evidence: 未明确引用 repo 中已有的 dnd-kit 模式（useDraggable/useDroppable）与 yDoc 写入模式（clipboardPaste）。(`apps/web/features/views/components/KanbanView/KanbanCard.tsx:83-96`; `apps/web/hooks/clipboard/clipboardPaste.ts:242-292`)  
Impact: Dev 容易按 Story 示例写出与现有最佳实践冲突的实现。

### Step 3.1: Reinvention Prevention Gaps
Pass Rate: 0/3 (0%)

✗ FAIL — Wheel reinvention risk  
Evidence: Story 从零实现“选中子树 + edges 提取 + 生成节点/边 + Yjs 写入”。(`docs/sprint-artifacts/5-2-subtree-fragments.md:761-866`, `docs/sprint-artifacts/5-2-subtree-fragments.md:974-1032`)  
Impact: 与 Clipboard（已验证）重复，且更易产生不一致。

✗ FAIL — Code reuse opportunities not identified  
Evidence: 现有 `clipboardSerializer` 已具备 subtree 展开与 dependency edge 提取（读取 `edge.getData().metadata.kind`）。(`apps/web/hooks/clipboard/clipboardSerializer.ts:46-99`, `apps/web/hooks/clipboard/clipboardSerializer.ts:150-168`) Story 未建议复用该能力。  
Impact: 造成重复 bugfix 成本与契约漂移。

✗ FAIL — Existing solutions not mentioned  
Evidence: 现有 paste 逻辑已经定义了 Yjs nodes/edges 的 canonical 写入结构。(`apps/web/hooks/clipboard/clipboardPaste.ts:267-292`; `apps/web/hooks/clipboard/pasteHelpers.ts:98-110`) Story 的 `useTemplateInsert` 未引用。(`docs/sprint-artifacts/5-2-subtree-fragments.md:935-1032`)  
Impact: 高概率写入字段不全，导致协作数据异常。

### Step 3.2: Technical Specification DISASTERS
Pass Rate: 1/5 (20%)

✓ PASS — Wrong libraries/frameworks  
Evidence: dnd-kit/Yjs/Nest/Prisma 都是 repo 已采用的栈。(`apps/web/package.json:24-26`; `docs/architecture.md:546-549`)

✗ FAIL — API contract violations  
Evidence: Story 需要“我的模板 Tab（creatorId）+ 私有模板（isPublic）筛选”。(`docs/sprint-artifacts/5-2-subtree-fragments.md:441-443`, `docs/sprint-artifacts/5-2-subtree-fragments.md:1039-1042`) 但 `TemplateListItem` 无 `creatorId/isPublic`，templates list API 也未返回。(`packages/types/src/template-types.ts:53-67`; `packages/plugins/plugin-template/src/server/templates/templates.repository.ts:40-63`)  
Impact: UI 无法可靠实现“我的模板/私有筛选”，且私有模板可能被错误暴露。

⚠ PARTIAL — Database schema conflicts  
Evidence: Story 多处依赖 `isPublic`。(`docs/sprint-artifacts/5-2-subtree-fragments.md:70-76`, `docs/sprint-artifacts/5-2-subtree-fragments.md:535-544`) 但 Prisma `Template` 无该字段。(`packages/database/prisma/schema.prisma:368-392`)  
Impact: 需要明确采用“新增列”或“用 status 编码”等策略，否则实现会卡死在持久化层。

✗ FAIL — Security vulnerabilities  
Evidence: 当前 `GET /templates` 默认返回 `status=PUBLISHED`，未按用户过滤。(`packages/plugins/plugin-template/src/server/templates/templates.repository.ts:21-28`) 若私有模板也是 PUBLISHED（Story AC3），将被所有人看到。(`docs/sprint-artifacts/5-2-subtree-fragments.md:30-35`, `docs/sprint-artifacts/5-2-subtree-fragments.md:51-56`)  
Impact: 私有模板泄露属于高严重度安全缺陷。

⚠ PARTIAL — Performance disasters  
Evidence: Story 未规定保存/插入的最大节点数/边数、JSON 体积、或拖拽插入的节流/批量写入策略。(`docs/sprint-artifacts/5-2-subtree-fragments.md:93-111`)  
Impact: 大子树模板会导致 UI 卡顿、网络超时或 DB 膨胀。

### Step 3.3: File Structure DISASTERS
Pass Rate: 0/4 (0%)

✗ FAIL — Wrong file locations  
Evidence: Story 要求新增 DTO 在 `templates/dto/` 下。(`docs/sprint-artifacts/5-2-subtree-fragments.md:551-554`) 但当前 plugin-template DTO 都集中在 `templates.request.dto.ts`。(`packages/plugins/plugin-template/src/server/templates/templates.request.dto.ts:1-48`)  
Impact: 可能导致 controller import 混乱、导出不一致。

⚠ PARTIAL — Coding standard violations  
Evidence: Story 示例使用 `Math.random().toString(36).substr(...)` 风格的 tempId（tech-spec 中出现），以及多处 `any`。(`docs/sprint-artifacts/tech-spec-5-2-subtree-fragments.md:487-515`, `docs/sprint-artifacts/5-2-subtree-fragments.md:980-1005`)  
Impact: 降低类型安全与可维护性；建议复用 `nanoid` 与强类型结构。

✗ FAIL — Integration pattern breaks  
Evidence: Story 的 edge 提取判断 `data.kind === 'dependency'`。(`docs/sprint-artifacts/5-2-subtree-fragments.md:845-852`) 但现有边 kind 存在 `edge.getData().metadata.kind`。(`apps/web/hooks/clipboard/clipboardSerializer.ts:56-60`, `apps/web/hooks/clipboard/clipboardSerializer.ts:159-166`)  
Impact: 将漏提取 dependency edges，导致 AC5 “依赖边正确重建”失败。

➖ N/A — Deployment failures  
Evidence: 本 Story 不涉及 CI/CD 或运行时环境差异。  
Impact: N/A

### Step 3.4: Regression DISASTERS
Pass Rate: 1/4 (25%)

⚠ PARTIAL — Breaking changes  
Evidence: types 扩展会影响 `@cdm/types` 的消费者；需要确保新增字段均为 optional 并更新导出。(`docs/sprint-artifacts/5-2-subtree-fragments.md:505-547`)  
Impact: 若非可选字段或导出遗漏，会破坏现有编译/运行。

✓ PASS — Test failures  
Evidence: Story 覆盖后端/前端/组件/E2E，并有 AC 追溯矩阵。(`docs/sprint-artifacts/5-2-subtree-fragments.md:1044-1141`)  
Impact: 有较强回归保护意图。

⚠ PARTIAL — UX violations  
Evidence: Story UI 规范采用深色主题（`#1e1e2e` 等）。(`docs/sprint-artifacts/5-2-subtree-fragments.md:301-309`) 但现有 TemplateLibraryDialog 使用浅色 UI（白底/灰底）。(`apps/web/components/TemplateLibrary/TemplateLibraryDialog.tsx:265-279`, `apps/web/components/TemplateLibrary/TemplateLibraryDialog.tsx:312-313`)  
Impact: 若产品整体未统一深色主题，可能出现风格割裂。

⚠ PARTIAL — Learning failures  
Evidence: 未把“Clipboard 已提供 canonical Yjs 写入结构”作为强制指导，导致重复出现协议不一致的风险。(`apps/web/hooks/clipboard/clipboardPaste.ts:267-292`; `docs/sprint-artifacts/5-2-subtree-fragments.md:935-1032`)  
Impact: 容易重蹈数据结构/同步问题。

### Step 3.5: Implementation DISASTERS
Pass Rate: 0/4 (0%)

✗ FAIL — Vague implementations  
Evidence: `useTemplateInsert.generateFromTemplate` 未对 node/edge 结构与 GraphSyncManager/Collab 协议对齐（缺少 `nodeType/mindmapType/props`，edge 缺少 `metadata` 与 `type` 映射）。(`docs/sprint-artifacts/5-2-subtree-fragments.md:997-1032`; `apps/web/hooks/clipboard/clipboardPaste.ts:267-284`; `apps/web/hooks/clipboard/pasteHelpers.ts:98-108`)  
Impact: 高概率导致“插入后不显示/不落库/数据丢失”。

✗ FAIL — Completion lies  
Evidence: AC6 需要私有模板对非创建者不可见。(`docs/sprint-artifacts/5-2-subtree-fragments.md:51-56`) 若不补齐 DB + list/getById 过滤，本 Story 即使完成 UI/POST，也无法满足 AC6。(`packages/plugins/plugin-template/src/server/templates/templates.repository.ts:21-28`)  
Impact: Story 可能被标记 done，但实际存在严重缺陷。

⚠ PARTIAL — Scope creep  
Evidence: Story 包含完整颜色系统、动画规范、响应式断点等“设计系统”内容。(`docs/sprint-artifacts/5-2-subtree-fragments.md:444-499`)  
Impact: 可能分散实现注意力；需确认这些是否为“必须交付”还是参考。

⚠ PARTIAL — Quality failures  
Evidence: metadata 清洗与规模上限未明确采用已有的白名单策略与限制。(`packages/types/src/node-types.ts:213-230`; `apps/web/hooks/clipboard/clipboardSerializer.ts:40-44`)  
Impact: 易引入安全/性能问题。

### Step 4: LLM-Dev-Agent Optimization Analysis
Pass Rate: 1/10 (10%)

✗ FAIL — Verbosity problems  
Evidence: Story 文件约 1324 行，包含大量 UI 规范、代码大段示例与测试示例。(`docs/sprint-artifacts/5-2-subtree-fragments.md:1-1324`；行数统计)  
Impact: Dev agent token 消耗高，且关键约束更难被抓住。

⚠ PARTIAL — Ambiguity issues  
Evidence: “个人或团队模板库”与“公开=所有用户可见”存在语义张力。(`docs/sprint-artifacts/5-2-subtree-fragments.md:33-56`)  
Impact: 可能导致实现成“全局公开”而非“团队可见”。

✗ FAIL — Context overload  
Evidence: 同一 Story 同时包含 UI 设计系统、实现细节、测试大量示例，且部分示例与 repo 现状不一致（Yjs shape / hook state 命名）。(`docs/sprint-artifacts/5-2-subtree-fragments.md:301-331`, `docs/sprint-artifacts/5-2-subtree-fragments.md:728-745`, `docs/sprint-artifacts/5-2-subtree-fragments.md:997-1032`)  
Impact: Dev agent 可能遵循错误示例，忽略真正的系统契约。

⚠ PARTIAL — Missing critical signals  
Evidence: 未把“复用 Clipboard 作为 canonical 实现”提升为 MUST。(`apps/web/hooks/clipboard/clipboardSerializer.ts:33-179`)  
Impact: 关键防灾信号不足。

⚠ PARTIAL — Poor structure  
Evidence: Story 有明确 AC/Tasks/测试矩阵结构，但“关键协议（Yjs node/edge shape）”未集中成权威段落。(`docs/sprint-artifacts/5-2-subtree-fragments.md:501-1141`)  
Impact: 信息可扫描，但关键约束不够突出。

⚠ PARTIAL — Clarity over verbosity  
Evidence: 多处大段示例与重复说明；应提炼“必须遵循的 canonical 函数/数据结构”。  
Impact: 容易让实现偏离现状。

⚠ PARTIAL — Actionable instructions  
Evidence: Tasks 很细，但部分示例不可直接落地（hook state 命名、edge.kind 读取路径）。(`docs/sprint-artifacts/5-2-subtree-fragments.md:728-745`, `docs/sprint-artifacts/5-2-subtree-fragments.md:845-852`)  
Impact: 降低可执行性。

✓ PASS — Scannable structure  
Evidence: 具有 AC、Non-goals、Dev Notes、UI Specs、Tasks、Test Matrix。(`docs/sprint-artifacts/5-2-subtree-fragments.md:17-63`, `docs/sprint-artifacts/5-2-subtree-fragments.md:501-1141`)  
Impact: 有利于开发分阶段推进。

✗ FAIL — Token efficiency  
Evidence: UI 规范/动画/颜色系统占用大量篇幅。(`docs/sprint-artifacts/5-2-subtree-fragments.md:444-499`)  
Impact: LLM dev agent 运行成本增大，且更易错过关键协议。

⚠ PARTIAL — Unambiguous language  
Evidence: 可见性语义（团队 vs 全局）与持久化字段（isPublic 的落地方案）需更明确。(`docs/sprint-artifacts/5-2-subtree-fragments.md:33-56`, `docs/sprint-artifacts/5-2-subtree-fragments.md:70-76`)  
Impact: 容易在 DB/API 层做出不一致实现。

## Failed Items (✗)

1. Vague implementations (Yjs node/edge shape mismatch) — 建议复用 `apps/web/hooks/clipboard/*` 的 canonical 写入结构。  
2. Step 3.1 全部（Reinvention gaps）— 建议将 Clipboard 作为子树提取/插入的底座。  
3. API contract violations（creatorId/isPublic 相关）— 建议补齐 types + list/getById 过滤策略。  
4. Security vulnerabilities（私有模板泄露风险）— 建议明确“私有模板存储/访问控制”。  
5. Integration pattern breaks（edge.kind 读取错误）— 建议统一使用 `edge.getData().metadata.kind`。  

## Partial Items (⚠)

- 可见性策略（isPublic/团队语义/落地字段）需闭环。  
- 文件路径与现有 DTO/Hook 模式需对齐。  
- 性能上限（max nodes/edges/template size）需定义并测试。  
- UI 主题与现有 UI 统一性需确认。  

## Recommendations

1. **Must Fix (阻断项)**
   - 以 `apps/web/hooks/clipboard/clipboardPaste.ts` 与 `pasteHelpers.ts` 为准，统一模板插入的 Yjs node/edge shape。(`apps/web/hooks/clipboard/clipboardPaste.ts:267-292`; `apps/web/hooks/clipboard/pasteHelpers.ts:98-110`)
   - 明确 AC6 的可见性持久化方案（新增 `Template.isPublic` 列 / 复用 status 编码 / 其他），并补齐 `GET /templates` 与 `GET /templates/:id` 的访问控制。(`packages/database/prisma/schema.prisma:368-392`; `packages/plugins/plugin-template/src/server/templates/templates.repository.ts:21-28`)
   - 将“复用 Clipboard 逻辑”写成明确任务/强制约束，避免重复实现。(`apps/web/hooks/clipboard/clipboardSerializer.ts:33-179`)

2. **Should Improve**
   - DnD 实现对齐现有 `useDraggable/useDroppable` 模式（Kanban），避免引入新的包装层。(`apps/web/features/views/components/KanbanView/KanbanCard.tsx:83-96`; `apps/web/features/views/components/KanbanView/KanbanColumn.tsx:85-93`)
   - 把 `TemplateNodePreview` 抽取成可复用组件（或在 SaveTemplateDialog 内实现）。(`apps/web/components/TemplateLibrary/TemplateLibraryDialog.tsx:381-415`)
   - 在模板保存/插入路径引入规模限制与提示（参考 Clipboard 的 MAX_CLIPBOARD_NODES）。(`apps/web/hooks/clipboard/clipboardSerializer.ts:40-44`)

3. **Consider**
   - 精简 Story：把颜色/动画/响应式作为参考附录，主线保留“必须遵守的协议 + Tasks”。  

