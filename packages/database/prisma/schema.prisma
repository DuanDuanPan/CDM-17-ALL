// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Core Models for CDM Mindmap Application

// Node Type Enum - Story 2.1
enum NodeType {
  ORDINARY
  TASK
  REQUIREMENT
  PBS
  DATA
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projects Project[]
}

model Project {
  id          String   @id @default(cuid())
  name        String   @default("未命名项目")
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  ownerId String
  owner   User   @relation(fields: [ownerId], references: [id])

  graphs Graph[]
}

model Graph {
  id        String   @id @default(cuid())
  name      String   @default("新脑图")
  data      Json     @default("{}")
  yjsState  Bytes?   // Yjs CRDT state for real-time collaboration (Story 1.4)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  nodes Node[]
  edges Edge[]
}

model Node {
  id       String   @id @default(cuid())
  label    String
  creatorName String @default("Mock User")
  type     NodeType @default(ORDINARY) // Story 2.1: Changed from String to NodeType enum
  x        Float    @default(0)
  y        Float    @default(0)
  width    Float    @default(120)
  height   Float    @default(40)
  metadata Json     @default("{}")

  graphId String
  graph   Graph  @relation(fields: [graphId], references: [id], onDelete: Cascade)

  parentId String?
  parent   Node?   @relation("NodeHierarchy", fields: [parentId], references: [id])
  children Node[]  @relation("NodeHierarchy")

  sourceEdges Edge[] @relation("SourceNode")
  targetEdges Edge[] @relation("TargetNode")

  // Story 2.1: Polymorphic Extension Tables (1:1 relations)
  taskProps        NodeTask?
  requirementProps NodeRequirement?
  pbsProps         NodePBS?
  dataProps        NodeData?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Story 2.1: Extension Tables for Polymorphic Node Properties
model NodeTask {
  nodeId   String   @id
  node     Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  status     String   @default("todo") // todo, in-progress, done
  assigneeId String?
  dueDate    DateTime?
  priority   String?  @default("medium") // low, medium, high

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model NodeRequirement {
  nodeId   String   @id
  node     Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  reqType            String? // functional, non-functional, etc.
  acceptanceCriteria String?
  priority           String? @default("must") // MoSCoW: must, should, could, wont

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model NodePBS {
  nodeId  String   @id
  node    Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  code     String? // e.g., "PBS-001"
  version  String? @default("v1.0.0")
  ownerId  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model NodeData {
  nodeId  String   @id
  node    Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  dataType     String? // document, model, drawing
  version      String? @default("v1.0.0") // semantic version
  secretLevel  String? @default("public") // public, internal, secret
  storagePath  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Edge {
  id   String @id @default(cuid())
  type String @default("hierarchical")

  graphId String
  graph   Graph  @relation(fields: [graphId], references: [id], onDelete: Cascade)

  sourceId String
  source   Node   @relation("SourceNode", fields: [sourceId], references: [id], onDelete: Cascade)

  targetId String
  target   Node   @relation("TargetNode", fields: [targetId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
