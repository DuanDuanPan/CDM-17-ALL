// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Core Models for CDM Mindmap Application

// Node Type Enum - Story 2.1, Story 2.9
enum NodeType {
  ORDINARY
  TASK
  REQUIREMENT
  PBS
  DATA
  APP // Story 2.9: APP 节点类型
}

// Story 5.1: Template Status Enum
enum TemplateStatus {
  DRAFT
  PUBLISHED
  DEPRECATED
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projects      Project[]
  notifications Notification[] // Story 2.4: Task dispatch notifications

  // Story 4.3: Contextual Comments
  comments      Comment[]
  commentReads  CommentRead[]

  // Story 4.4: Watch & Subscription
  subscriptions Subscription[]
}

model Project {
  id          String   @id @default(cuid())
  name        String   @default("未命名项目")
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  ownerId String
  owner   User   @relation(fields: [ownerId], references: [id])

  graphs Graph[]
}

model Graph {
  id        String   @id @default(cuid())
  name      String   @default("新脑图")
  data      Json     @default("{}")
  yjsState  Bytes?   // Yjs CRDT state for real-time collaboration (Story 1.4)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  nodes    Node[]
  edges    Edge[]

  // Story 9.1: Data Library
  dataFolders DataFolder[]
  dataAssets  DataAsset[]
  
  // Story 4.3: Contextual Comments
  comments Comment[]
}

model Node {
  id          String   @id @default(cuid())
  label       String
  description String?  // Story 2.5: Node description for search and card UI
  creatorName String   @default("Mock User")
  type        NodeType @default(ORDINARY) // Story 2.1: Changed from String to NodeType enum
  x           Float    @default(0)
  y           Float    @default(0)
  width       Float    @default(120)
  height      Float    @default(40)
  metadata    Json     @default("{}")

  // Story 8.6: Sibling node order persistence
  order       Int      @default(0)

  // Story 4.1: Approval Workflow
  approval    Json?    // Stores ApprovalPipeline: { status, currentStepIndex, steps[], history[] }

  // Story 2.5: Tags and Archive fields
  tags        String[] @default([])   // 标签数组
  isArchived  Boolean  @default(false) // 归档状态 (软删除)
  archivedAt  DateTime?               // 归档时间

  graphId String
  graph   Graph  @relation(fields: [graphId], references: [id], onDelete: Cascade)

  parentId String?
  parent   Node?   @relation("NodeHierarchy", fields: [parentId], references: [id])
  children Node[]  @relation("NodeHierarchy")

  sourceEdges Edge[] @relation("SourceNode")
  targetEdges Edge[] @relation("TargetNode")

  // Story 2.1: Polymorphic Extension Tables (1:1 relations)
  taskProps        NodeTask?
  requirementProps NodeRequirement?
  pbsProps         NodePBS?
  dataProps        NodeData?
  appProps         NodeApp? // Story 2.9: APP 节点属性

  // Story 4.3: Contextual Comments
  comments  Comment[]

  // Story 4.4: Watch & Subscription
  subscriptions Subscription[]

  // Story 9.1: Data Library - Node to DataAsset links
  dataLinks     NodeDataLink[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Story 2.5: Indexes for search performance
  @@index([graphId, isArchived])  // Filter archived nodes per graph
  @@index([tags])                  // Tag filtering (GIN index in PostgreSQL)
  @@index([graphId, label])        // Label search within graph
}

// Story 2.1: Extension Tables for Polymorphic Node Properties
// Story 2.3: Added startDate, customStage, progress for Multi-View Synchronization
// Story 2.4: Added assignment dispatch & feedback fields
model NodeTask {
  nodeId   String   @id
  node     Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  status      String   @default("todo") // todo, in-progress, done
  assigneeId  String?
  startDate   DateTime? // Story 2.3: Gantt start date
  dueDate     DateTime? // Story 2.3: Gantt end date
  priority    String?  @default("medium") // low, medium, high
  customStage String?  // Story 2.3: Dynamic Kanban grouping field
  progress    Int?     @default(0) // Story 2.3: 0-100 percentage for Gantt progress bar

  // Story 2.4: Task dispatch & feedback fields
  assignmentStatus String    @default("idle") // idle, dispatched, accepted, rejected
  ownerId          String? // 任务创建者/下发者 ID
  rejectionReason  String? // 驳回理由
  dispatchedAt     DateTime? // 下发时间
  feedbackAt       DateTime? // 反馈时间

  // Story 2.8: Knowledge association
  knowledgeRefs   Json?

  // Story 4.1: Approval Workflow
  deliverables    Json?    // Array: [{ id, fileId, fileName, uploadedAt }]

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model NodeRequirement {
  nodeId   String   @id
  node     Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  reqType            String? // functional, non-functional, etc.
  acceptanceCriteria String?
  priority           String? @default("must") // MoSCoW: must, should, could, wont

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model NodePBS {
  nodeId  String   @id
  node    Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  code     String? // e.g., "PBS-001"
  version  String? @default("v1.0.0")
  ownerId  String?
  
  // Story 2.7: PBS Indicators and Product Library Reference
  indicators Json?  // Array of PBSIndicator: [{ id, name, unit, targetValue, actualValue }]
  productRef Json?  // ProductReference: { productId, productName, productCode, category }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model NodeData {
  nodeId  String   @id
  node    Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  dataType     String? // document, model, drawing
  version      String? @default("v1.0.0") // semantic version
  secretLevel  String? @default("public") // public, internal, secret
  storagePath  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Story 2.9: APP 节点扩展表
model NodeApp {
  nodeId  String   @id
  node    Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  appSourceType   String?  @default("library") // local, remote, library
  appPath         String?  // 本地应用路径
  appUrl          String?  // 远程应用 URL
  libraryAppId    String?  // 应用库 ID
  libraryAppName  String?  // 应用库名称
  inputs          Json?    // AppInput[] 数组
  outputs         Json?    // AppOutput[] 数组
  executionStatus String?  @default("idle") // idle, running, success, error
  lastExecutedAt  DateTime?
  errorMessage    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Edge {
  id   String @id @default(cuid())
  type String @default("hierarchical") // Legacy field for backward compatibility

  // Story 2.2: Edge metadata for polymorphism (hierarchical vs dependency)
  // Stores: { kind: 'hierarchical' | 'dependency', dependencyType?: 'FS' | 'SS' | 'FF' | 'SF' }
  metadata Json @default("{\"kind\": \"hierarchical\"}")

  graphId String
  graph   Graph  @relation(fields: [graphId], references: [id], onDelete: Cascade)

  sourceId String
  source   Node   @relation("SourceNode", fields: [sourceId], references: [id], onDelete: Cascade)

  targetId String
  target   Node   @relation("TargetNode", fields: [targetId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Story 2.4: Notification Model for task dispatch & feedback
model Notification {
  id          String   @id @default(cuid())
  recipientId String
  recipient   User     @relation(fields: [recipientId], references: [id])

  type      String // TASK_DISPATCH | TASK_ACCEPTED | TASK_REJECTED | WATCH_UPDATE
  title     String
  content   Json // { taskId, taskName, action, senderName, reason? }
  refNodeId String? // 关联的节点 ID (用于点击跳转)
  isRead    Boolean  @default(false)

  // Story 4.4: Aggregation fields for notification throttling
  groupKey         String?   // Aggregation key: userId:mindmapId:type
  batchCount       Int       @default(1) // Number of aggregated events
  lastAggregatedAt DateTime? // Last time this notification was updated with new events

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([recipientId, isRead])
  @@index([recipientId, createdAt])
  @@index([recipientId, groupKey, isRead]) // Fast lookup for aggregation
}

// Story 4.3: Comment Model for Contextual Comments
model Comment {
  id        String   @id @default(cuid())
  content   String   @db.Text
  
  // Relations
  nodeId    String
  node      Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  
  mindmapId String
  mindmap   Graph    @relation(fields: [mindmapId], references: [id], onDelete: Cascade)
  
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  
  // Threading (max 2 levels in UI)
  replyToId String?
  replyTo   Comment? @relation("CommentThread", fields: [replyToId], references: [id])
  replies   Comment[] @relation("CommentThread")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Story 4.3+: File attachments
  attachments CommentAttachment[]
  
  @@index([nodeId])
  @@index([mindmapId])
  @@index([authorId])
}

// Story 4.3: CommentRead Model for tracking unread state
model CommentRead {
  id         String   @id @default(cuid())
  userId     String
  nodeId     String
  lastReadAt DateTime @default(now())
  
  user       User     @relation(fields: [userId], references: [id])
  
  @@unique([userId, nodeId])
  @@index([nodeId])
}

// Story 4.3+: CommentAttachment Model for file attachments
model CommentAttachment {
  id          String   @id @default(cuid())

  commentId   String?  // Nullable: null means pending association
  comment     Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)

  fileName    String      // Original filename
  fileSize    Int         // Size in bytes
  mimeType    String      // e.g., "image/png", "application/pdf"
  storagePath String      // Local storage path: uploads/comments/{filename}

  uploaderId  String      // User who uploaded the file

  createdAt   DateTime @default(now())

  @@index([commentId])
}

// Story 4.4: Subscription Model for Watch & Subscription feature
model Subscription {
  id        String   @id @default(cuid())
  userId    String
  nodeId    String
  mindmapId String

  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])
  node      Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  @@unique([userId, nodeId]) // Prevent duplicate subscriptions
  @@index([nodeId])          // Fast lookup: "Who is watching this node?"
  @@index([userId])          // Fast lookup: "What am I watching?"
}

// Story 5.1: Template Library Models

// Template Category for organizing templates
model TemplateCategory {
  id        String   @id @default(cuid())
  name      String   @unique
  icon      String?  // Lucide icon name
  sortOrder Int      @default(0)

  templates Template[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Template Model - stores reusable graph structures
// Story 5.2: Added isPublic for visibility control
model Template {
  id                    String         @id @default(cuid())
  name                  String
  description           String?        @db.Text
  thumbnail             String?        // URL or path to thumbnail image
  structure             Json           // { rootNode: { label, type?, metadata?, children: [...] }, edges?: [...] }
  defaultClassification String         @default("internal") // public, internal, confidential, secret
  requiredFields        Json?          // Array of required field names
  status                TemplateStatus @default(DRAFT)
  version               Int            @default(1)

  categoryId String?
  category   TemplateCategory? @relation(fields: [categoryId], references: [id])

  creatorId  String? // User ID of template creator
  usageCount Int     @default(0)
  isPublic   Boolean @default(true) // Story 5.2: Visibility control (true=public, false=private)

  usageLogs TemplateUsageLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([categoryId])
  @@index([isPublic]) // Story 5.2: Index for visibility filtering
  @@index([creatorId, isPublic]) // Story 5.2: Index for "my templates" + visibility filtering
}

// Template Usage Log - tracks template instantiation
model TemplateUsageLog {
  id         String   @id @default(cuid())
  templateId String
  template   Template @relation(fields: [templateId], references: [id], onDelete: Cascade)
  userId     String
  graphId    String   // The graph created from the template

  createdAt DateTime @default(now())

  @@index([templateId])
  @@index([userId])
}

// ========================================
// Story 9.1: Data Library (数据资源库)
// ========================================

// Data Asset Format Enum - defines supported file formats
enum DataAssetFormat {
  STEP       // 3D CAD format (.step, .stp)
  IGES       // CAD format (.iges, .igs)
  STL        // 3D printing format
  OBJ        // 3D object format
  FBX        // 3D interchange format
  GLTF       // GL Transmission Format
  VTK        // VTK scientific visualization (.vtk, .vtp, .vtu, .vti)
  PDF        // Document format
  DOCX       // Word document
  XLSX       // Excel spreadsheet
  JSON       // Data format
  XML        // Markup format
  CSV        // Comma-separated values
  IMAGE      // Image files (png, jpg, svg)
  VIDEO      // Video files (mp4, mov)
  OTHER      // Other formats
}

// Data Folder - hierarchical folder structure for organizing assets
model DataFolder {
  id          String   @id @default(cuid())
  name        String
  description String?
  parentId    String?  // Null means root folder
  graphId     String
  graph       Graph    @relation(fields: [graphId], references: [id], onDelete: Cascade)

  parent      DataFolder?  @relation("FolderHierarchy", fields: [parentId], references: [id])
  children    DataFolder[] @relation("FolderHierarchy")

  assets      DataAsset[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([graphId])
  @@index([parentId])
}

// Data Asset - individual data files/resources in the library
model DataAsset {
  id          String          @id @default(cuid())
  name        String
  description String?         @db.Text
  format      DataAssetFormat @default(OTHER)
  fileSize    Int?            // Size in bytes
  storagePath String?         // Storage path or URL
  thumbnail   String?         // Thumbnail image path/URL
  version     String          @default("v1.0.0")
  tags        String[]        @default([])

  // Ownership and organization
  graphId     String
  graph       Graph           @relation(fields: [graphId], references: [id], onDelete: Cascade)
  folderId    String?         // Null means in root
  folder      DataFolder?     @relation(fields: [folderId], references: [id])
  creatorId   String?         // User who created/uploaded

  // Classification
  secretLevel String          @default("internal") // public, internal, confidential, secret

  // Soft delete fields
  isDeleted   Boolean         @default(false)
  deletedAt   DateTime?

  // Links to nodes
  nodeLinks   NodeDataLink[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([graphId])
  @@index([folderId])
  @@index([format])
  @@index([tags])
  @@index([name])
  @@index([graphId, isDeleted])  // Optimized for trash queries
}

// NodeDataLink - links between nodes and data assets (many-to-many)
model NodeDataLink {
  id        String   @id @default(cuid())
  nodeId    String
  assetId   String

  node      Node      @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  asset     DataAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  // Link metadata
  linkType  String    @default("reference") // reference, attachment, source
  note      String?   // Optional note about the link

  createdAt DateTime @default(now())

  @@unique([nodeId, assetId]) // Prevent duplicate links
  @@index([nodeId])
  @@index([assetId])
}
