// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Core Models for CDM Mindmap Application

// Node Type Enum - Story 2.1
enum NodeType {
  ORDINARY
  TASK
  REQUIREMENT
  PBS
  DATA
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projects      Project[]
  notifications Notification[] // Story 2.4: Task dispatch notifications
}

model Project {
  id          String   @id @default(cuid())
  name        String   @default("未命名项目")
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  ownerId String
  owner   User   @relation(fields: [ownerId], references: [id])

  graphs Graph[]
}

model Graph {
  id        String   @id @default(cuid())
  name      String   @default("新脑图")
  data      Json     @default("{}")
  yjsState  Bytes?   // Yjs CRDT state for real-time collaboration (Story 1.4)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  nodes Node[]
  edges Edge[]
}

model Node {
  id          String   @id @default(cuid())
  label       String
  description String?  // Story 2.5: Node description for search and card UI
  creatorName String   @default("Mock User")
  type        NodeType @default(ORDINARY) // Story 2.1: Changed from String to NodeType enum
  x           Float    @default(0)
  y           Float    @default(0)
  width       Float    @default(120)
  height      Float    @default(40)
  metadata    Json     @default("{}")

  // Story 2.5: Tags and Archive fields
  tags        String[] @default([])   // 标签数组
  isArchived  Boolean  @default(false) // 归档状态 (软删除)
  archivedAt  DateTime?               // 归档时间

  graphId String
  graph   Graph  @relation(fields: [graphId], references: [id], onDelete: Cascade)

  parentId String?
  parent   Node?   @relation("NodeHierarchy", fields: [parentId], references: [id])
  children Node[]  @relation("NodeHierarchy")

  sourceEdges Edge[] @relation("SourceNode")
  targetEdges Edge[] @relation("TargetNode")

  // Story 2.1: Polymorphic Extension Tables (1:1 relations)
  taskProps        NodeTask?
  requirementProps NodeRequirement?
  pbsProps         NodePBS?
  dataProps        NodeData?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Story 2.5: Indexes for search performance
  @@index([graphId, isArchived])  // Filter archived nodes per graph
  @@index([tags])                  // Tag filtering (GIN index in PostgreSQL)
  @@index([graphId, label])        // Label search within graph
}

// Story 2.1: Extension Tables for Polymorphic Node Properties
// Story 2.3: Added startDate, customStage, progress for Multi-View Synchronization
// Story 2.4: Added assignment dispatch & feedback fields
model NodeTask {
  nodeId   String   @id
  node     Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  status      String   @default("todo") // todo, in-progress, done
  assigneeId  String?
  startDate   DateTime? // Story 2.3: Gantt start date
  dueDate     DateTime? // Story 2.3: Gantt end date
  priority    String?  @default("medium") // low, medium, high
  customStage String?  // Story 2.3: Dynamic Kanban grouping field
  progress    Int?     @default(0) // Story 2.3: 0-100 percentage for Gantt progress bar

  // Story 2.4: Task dispatch & feedback fields
  assignmentStatus String    @default("idle") // idle, dispatched, accepted, rejected
  ownerId          String? // 任务创建者/下发者 ID
  rejectionReason  String? // 驳回理由
  dispatchedAt     DateTime? // 下发时间
  feedbackAt       DateTime? // 反馈时间

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model NodeRequirement {
  nodeId   String   @id
  node     Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  reqType            String? // functional, non-functional, etc.
  acceptanceCriteria String?
  priority           String? @default("must") // MoSCoW: must, should, could, wont

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model NodePBS {
  nodeId  String   @id
  node    Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  code     String? // e.g., "PBS-001"
  version  String? @default("v1.0.0")
  ownerId  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model NodeData {
  nodeId  String   @id
  node    Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  dataType     String? // document, model, drawing
  version      String? @default("v1.0.0") // semantic version
  secretLevel  String? @default("public") // public, internal, secret
  storagePath  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Edge {
  id   String @id @default(cuid())
  type String @default("hierarchical") // Legacy field for backward compatibility

  // Story 2.2: Edge metadata for polymorphism (hierarchical vs dependency)
  // Stores: { kind: 'hierarchical' | 'dependency', dependencyType?: 'FS' | 'SS' | 'FF' | 'SF' }
  metadata Json @default("{\"kind\": \"hierarchical\"}")

  graphId String
  graph   Graph  @relation(fields: [graphId], references: [id], onDelete: Cascade)

  sourceId String
  source   Node   @relation("SourceNode", fields: [sourceId], references: [id], onDelete: Cascade)

  targetId String
  target   Node   @relation("TargetNode", fields: [targetId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Story 2.4: Notification Model for task dispatch & feedback
model Notification {
  id          String   @id @default(cuid())
  recipientId String
  recipient   User     @relation(fields: [recipientId], references: [id])

  type      String // TASK_DISPATCH | TASK_ACCEPTED | TASK_REJECTED
  title     String
  content   Json // { taskId, taskName, action, senderName, reason? }
  refNodeId String? // 关联的节点 ID (用于点击跳转)
  isRead    Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([recipientId, isRead])
  @@index([recipientId, createdAt])
}
