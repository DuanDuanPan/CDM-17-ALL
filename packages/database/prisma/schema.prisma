// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Core Models for CDM Mindmap Application

// Node Type Enum - Story 2.1, Story 2.9
enum NodeType {
  ORDINARY
  TASK
  REQUIREMENT
  PBS
  DATA
  APP // Story 2.9: APP 节点类型
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projects      Project[]
  notifications Notification[] // Story 2.4: Task dispatch notifications
  
  // Story 4.3: Contextual Comments
  comments      Comment[]
  commentReads  CommentRead[]
}

model Project {
  id          String   @id @default(cuid())
  name        String   @default("未命名项目")
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  ownerId String
  owner   User   @relation(fields: [ownerId], references: [id])

  graphs Graph[]
}

model Graph {
  id        String   @id @default(cuid())
  name      String   @default("新脑图")
  data      Json     @default("{}")
  yjsState  Bytes?   // Yjs CRDT state for real-time collaboration (Story 1.4)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  nodes    Node[]
  edges    Edge[]
  
  // Story 4.3: Contextual Comments
  comments Comment[]
}

model Node {
  id          String   @id @default(cuid())
  label       String
  description String?  // Story 2.5: Node description for search and card UI
  creatorName String   @default("Mock User")
  type        NodeType @default(ORDINARY) // Story 2.1: Changed from String to NodeType enum
  x           Float    @default(0)
  y           Float    @default(0)
  width       Float    @default(120)
  height      Float    @default(40)
  metadata    Json     @default("{}")

  // Story 4.1: Approval Workflow
  approval    Json?    // Stores ApprovalPipeline: { status, currentStepIndex, steps[], history[] }

  // Story 2.5: Tags and Archive fields
  tags        String[] @default([])   // 标签数组
  isArchived  Boolean  @default(false) // 归档状态 (软删除)
  archivedAt  DateTime?               // 归档时间

  graphId String
  graph   Graph  @relation(fields: [graphId], references: [id], onDelete: Cascade)

  parentId String?
  parent   Node?   @relation("NodeHierarchy", fields: [parentId], references: [id])
  children Node[]  @relation("NodeHierarchy")

  sourceEdges Edge[] @relation("SourceNode")
  targetEdges Edge[] @relation("TargetNode")

  // Story 2.1: Polymorphic Extension Tables (1:1 relations)
  taskProps        NodeTask?
  requirementProps NodeRequirement?
  pbsProps         NodePBS?
  dataProps        NodeData?
  appProps         NodeApp? // Story 2.9: APP 节点属性

  // Story 4.3: Contextual Comments
  comments  Comment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Story 2.5: Indexes for search performance
  @@index([graphId, isArchived])  // Filter archived nodes per graph
  @@index([tags])                  // Tag filtering (GIN index in PostgreSQL)
  @@index([graphId, label])        // Label search within graph
}

// Story 2.1: Extension Tables for Polymorphic Node Properties
// Story 2.3: Added startDate, customStage, progress for Multi-View Synchronization
// Story 2.4: Added assignment dispatch & feedback fields
model NodeTask {
  nodeId   String   @id
  node     Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  status      String   @default("todo") // todo, in-progress, done
  assigneeId  String?
  startDate   DateTime? // Story 2.3: Gantt start date
  dueDate     DateTime? // Story 2.3: Gantt end date
  priority    String?  @default("medium") // low, medium, high
  customStage String?  // Story 2.3: Dynamic Kanban grouping field
  progress    Int?     @default(0) // Story 2.3: 0-100 percentage for Gantt progress bar

  // Story 2.4: Task dispatch & feedback fields
  assignmentStatus String    @default("idle") // idle, dispatched, accepted, rejected
  ownerId          String? // 任务创建者/下发者 ID
  rejectionReason  String? // 驳回理由
  dispatchedAt     DateTime? // 下发时间
  feedbackAt       DateTime? // 反馈时间

  // Story 2.8: Knowledge association
  knowledgeRefs   Json?

  // Story 4.1: Approval Workflow
  deliverables    Json?    // Array: [{ id, fileId, fileName, uploadedAt }]

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model NodeRequirement {
  nodeId   String   @id
  node     Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  reqType            String? // functional, non-functional, etc.
  acceptanceCriteria String?
  priority           String? @default("must") // MoSCoW: must, should, could, wont

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model NodePBS {
  nodeId  String   @id
  node    Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  code     String? // e.g., "PBS-001"
  version  String? @default("v1.0.0")
  ownerId  String?
  
  // Story 2.7: PBS Indicators and Product Library Reference
  indicators Json?  // Array of PBSIndicator: [{ id, name, unit, targetValue, actualValue }]
  productRef Json?  // ProductReference: { productId, productName, productCode, category }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model NodeData {
  nodeId  String   @id
  node    Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  dataType     String? // document, model, drawing
  version      String? @default("v1.0.0") // semantic version
  secretLevel  String? @default("public") // public, internal, secret
  storagePath  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Story 2.9: APP 节点扩展表
model NodeApp {
  nodeId  String   @id
  node    Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  appSourceType   String?  @default("library") // local, remote, library
  appPath         String?  // 本地应用路径
  appUrl          String?  // 远程应用 URL
  libraryAppId    String?  // 应用库 ID
  libraryAppName  String?  // 应用库名称
  inputs          Json?    // AppInput[] 数组
  outputs         Json?    // AppOutput[] 数组
  executionStatus String?  @default("idle") // idle, running, success, error
  lastExecutedAt  DateTime?
  errorMessage    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Edge {
  id   String @id @default(cuid())
  type String @default("hierarchical") // Legacy field for backward compatibility

  // Story 2.2: Edge metadata for polymorphism (hierarchical vs dependency)
  // Stores: { kind: 'hierarchical' | 'dependency', dependencyType?: 'FS' | 'SS' | 'FF' | 'SF' }
  metadata Json @default("{\"kind\": \"hierarchical\"}")

  graphId String
  graph   Graph  @relation(fields: [graphId], references: [id], onDelete: Cascade)

  sourceId String
  source   Node   @relation("SourceNode", fields: [sourceId], references: [id], onDelete: Cascade)

  targetId String
  target   Node   @relation("TargetNode", fields: [targetId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Story 2.4: Notification Model for task dispatch & feedback
model Notification {
  id          String   @id @default(cuid())
  recipientId String
  recipient   User     @relation(fields: [recipientId], references: [id])

  type      String // TASK_DISPATCH | TASK_ACCEPTED | TASK_REJECTED
  title     String
  content   Json // { taskId, taskName, action, senderName, reason? }
  refNodeId String? // 关联的节点 ID (用于点击跳转)
  isRead    Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([recipientId, isRead])
  @@index([recipientId, createdAt])
}

// Story 4.3: Comment Model for Contextual Comments
model Comment {
  id        String   @id @default(cuid())
  content   String   @db.Text
  
  // Relations
  nodeId    String
  node      Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  
  mindmapId String
  mindmap   Graph    @relation(fields: [mindmapId], references: [id], onDelete: Cascade)
  
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  
  // Threading (max 2 levels in UI)
  replyToId String?
  replyTo   Comment? @relation("CommentThread", fields: [replyToId], references: [id])
  replies   Comment[] @relation("CommentThread")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Story 4.3+: File attachments
  attachments CommentAttachment[]
  
  @@index([nodeId])
  @@index([mindmapId])
  @@index([authorId])
}

// Story 4.3: CommentRead Model for tracking unread state
model CommentRead {
  id         String   @id @default(cuid())
  userId     String
  nodeId     String
  lastReadAt DateTime @default(now())
  
  user       User     @relation(fields: [userId], references: [id])
  
  @@unique([userId, nodeId])
  @@index([nodeId])
}

// Story 4.3+: CommentAttachment Model for file attachments
model CommentAttachment {
  id          String   @id @default(cuid())
  
  commentId   String
  comment     Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  
  fileName    String      // Original filename
  fileSize    Int         // Size in bytes
  mimeType    String      // e.g., "image/png", "application/pdf"
  storagePath String      // Local storage path: uploads/comments/{commentId}/{filename}
  
  uploaderId  String      // User who uploaded the file
  
  createdAt   DateTime @default(now())
  
  @@index([commentId])
}

